<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Observability Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback CSS in case Tailwind CDN fails
    if (!window.tailwind) {
      const fallbackCSS = `
        body { background: #181A20; color: white; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .bg-dtdark { background: #181A20; }
        .text-white { color: white; }
        .min-h-screen { min-height: 100vh; }
        .fixed { position: fixed; }
        .p-4 { padding: 1rem; }
        .bg-dtcard { background: #22242A; }
        .border { border: 1px solid #2D2D2D; }
        .rounded { border-radius: 0.25rem; }
        .text-dtcyan { color: #00D4FF; }
        .bg-dtgreen { background: #73BE28; }
        .hover\\:bg-green-700:hover { background: #15803d; }
        .transition-all { transition: all 0.3s; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-6 { padding: 1.5rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: bold; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .cursor-pointer { cursor: pointer; }
        .disabled\\:opacity-50:disabled { opacity: 0.5; }
      `;
      const style = document.createElement('style');
      style.textContent = fallbackCSS;
      document.head.appendChild(style);
    }
    
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dtpurple: '#6C2C9C', dtblue: '#00A1C9', dtcyan: '#00D4FF', dtgreen: '#73BE28', dtorange: '#FFA86B', dtyellow: '#FFD23F', dtdark: '#181A20', dtgray: '#23272F', dtcard: '#22242A', dtaccent: '#FFD23F', dtborder: '#2D2D2D'
          },
          boxShadow: {
            glow: '0 0 20px rgba(0, 212, 255, 0.5)',
            card: '0 4px 24px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,212,255,0.08)'
          },
          fontFamily: {
            sans: ['Inter', 'Roboto', 'Arial', 'sans-serif']
          }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    .node { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .node:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(0,212,255,0.6); }
    .connector { position:absolute; width:2px; background: linear-gradient(180deg, #00D4FF, transparent); animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5} }
    
    /* Sidebar Animations */
    #mainContent { margin-left: 0 !important; }
    #mainContent.sidebar-open { margin-left: 320px !important; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 45; }
    
    /* Prompt Cache Styles */
    .prompt-cache-indicator { 
      background: linear-gradient(45deg, #6C2C9C, #00A1C9); 
      animation: shimmer 2s infinite; 
    }
    @keyframes shimmer { 0%{background-position: -200px 0;} 100%{background-position: 200px 0;} }
    @keyframes fade-in { 
      0% { opacity: 0; transform: scale(0.9) translateY(-20px); } 
      100% { opacity: 1; transform: scale(1) translateY(0); } 
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out; }
    
    /* Tab System Styles */
    .tab-button {
      background: transparent;
      color: #9CA3AF;
      border: none;
      cursor: pointer;
    }
    .tab-button:hover {
      color: #00D4FF;
      background: rgba(0, 212, 255, 0.1);
    }
    .tab-button.active {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      color: black;
      font-weight: bold;
      border-color: #4ECDC4 !important;
      box-shadow: 0 8px 32px rgba(78, 205, 196, 0.3);
    }

    .tab-button.active .w-8 {
      background: linear-gradient(135deg, #000, #333) !important;
      color: white !important;
    }

    .tab-button.completed .w-8 {
      background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
      color: black !important;
    }
    
    .dashboard-tab {
      background: #23272F;
      color: #9CA3AF;
    }
    
    .dashboard-tab.active {
      background: #00D4FF;
      color: black;
      font-weight: bold;
    }

    .tab-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(78, 205, 196, 0.2);
    }

    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }

    /* Agent panel tabs */
    .agent-panel { display: none; }
    .agent-panel:not(.hidden) { display: block; }
    .agent-tab.active {
      font-weight: 700;
      box-shadow: 0 0 12px rgba(78, 205, 196, 0.3);
    }
    .agent-tab[data-agent="gremlin"].active { background: rgba(127,29,29,0.6); color: #f87171; border-color: #b91c1c; }
    .agent-tab[data-agent="fixit"].active { background: rgba(20,83,45,0.6); color: #4ade80; border-color: #15803d; }
    .agent-tab[data-agent="librarian"].active { background: rgba(30,58,138,0.6); color: #60a5fa; border-color: #1d4ed8; }
    .agent-tab[data-agent="dashboard"].active { background: rgba(88,28,135,0.6); color: #c084fc; border-color: #7e22ce; }

    /* Enhanced form styling */
    .form-input-enhanced {
      background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
      border: 2px solid #4ECDC4;
      border-radius: 12px;
      color: white;
      padding: 16px 20px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }

    .form-input-enhanced:focus {
      border-color: #7B68EE;
      box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2), inset 0 2px 10px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .btn-enhanced {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      border: none;
      border-radius: 12px;
      color: black;
      font-weight: bold;
      padding: 16px 32px;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(78, 205, 196, 0.3);
      cursor: pointer;
    }

    .btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(78, 205, 196, 0.4);
      background: linear-gradient(135deg, #7B68EE, #6A5ACD);
      color: white;
    }

    /* Enhanced animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-pane.active {
      animation: slideInUp 0.5s ease-out;
    }

    /* Card hover effects */
    .group:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    /* Progress line gradient animation */
    #progress-line {
      background: linear-gradient(90deg, #4ECDC4, #7B68EE, #4ECDC4);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Data Mode Button Styles */
    .data-mode-btn {
      background: transparent;
      color: #9CA3AF;
      border: none;
      cursor: pointer;
    }
    .data-mode-btn:hover {
      color: #00D4FF;
      background: rgba(0, 212, 255, 0.1);
    }
    .data-mode-btn.active {
      background: #00D4FF;
      color: #000;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      #mainContent.sidebar-open { margin-left: 0 !important; }
      #savedPromptsSidebar { width: 100vw !important; }
      .tab-button {
        font-size: 12px;
        padding: 8px 12px !important;
      }
    }
  </style>
</head>
<body class="bg-dtdark text-white min-h-screen">
  <!-- Saved Prompts Sidebar -->
  <div id="savedPromptsSidebar" class="fixed left-0 top-0 h-full w-80 bg-dtcard border-r border-dtborder shadow-xl z-50">
    <div class="p-4 border-b border-dtborder">
      <h2 class="text-lg font-bold text-dtcyan">ğŸ’¾ Saved Prompts</h2>
    </div>
    
    <div class="p-4">
      <!-- Save Current Prompt Section -->
      <div class="mb-6 p-3 bg-dtgray bg-opacity-40 rounded-lg border border-dtcyan">
        <h3 class="text-base font-bold text-dtcyan mb-2">ğŸ’¾ Save Current Configuration</h3>
        <input id="savePromptName" placeholder="Give this prompt a name..." class="w-full p-3 mb-2 rounded-lg bg-dtgray text-white border border-dtcyan focus:ring-2 focus:ring-dtcyan text-sm" />
        <button id="saveCurrentPrompt" onclick="window.saveCurrentConfiguration()" class="w-full bg-dtgreen text-black px-4 py-3 rounded-lg font-bold hover:bg-dtcyan transition-all text-sm">ğŸ’¾ Save Current State</button>
        <div id="saveStatus" class="mt-2 text-xs text-center hidden">
          <span class="text-dtcyan">â˜ï¸ Saving to server...</span>
        </div>
      </div>
      
      <!-- User Saved Prompts Section -->
      <div class="mb-4 p-3 bg-dtgray bg-opacity-40 rounded-lg border border-dtcyan">
        <h3 class="text-sm font-bold text-dtcyan mb-3 flex items-center gap-2">
          <span>ğŸ’¾</span> Your Saved Prompts
        </h3>
        <select id="userSavedPromptsDropdown" size="8" class="w-full bg-dtcard border border-dtcyan rounded-lg p-2 text-white text-sm mb-3 max-h-64 overflow-y-auto">
          <option value="">No saved prompts</option>
        </select>
        <div class="grid grid-cols-3 gap-2">
          <button onclick="loadSelectedUserPrompt()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black px-3 py-2 rounded-lg text-xs font-bold transition-all">
            ğŸ“– Load
          </button>
          <button onclick="duplicateSelectedUserPrompt()" class="bg-dtblue hover:bg-dtcyan text-white hover:text-black px-3 py-2 rounded-lg text-xs font-bold transition-all">
            ğŸ“„ Duplicate
          </button>
          <button onclick="deleteSelectedUserPrompt()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-bold transition-all">
            ğŸ—‘ï¸ Delete
          </button>
        </div>
      </div>
      
      <!-- Default Prompts Section -->
      <div class="mb-4 p-3 bg-dtgray bg-opacity-40 rounded-lg border border-dtyellow">
        <h3 class="text-sm font-bold text-dtyellow mb-3 flex items-center gap-2">
          <span>ğŸ“š</span> Default Library (24)
        </h3>
        <select id="defaultPromptsDropdown" size="8" class="w-full bg-dtcard border border-dtyellow rounded-lg p-2 text-white text-sm mb-3 max-h-64 overflow-y-auto">
          <option value="">Select a default prompt...</option>
        </select>
        <button onclick="loadSelectedDefaultPrompt()" class="w-full bg-dtyellow hover:bg-yellow-500 text-black px-3 py-2 rounded-lg text-sm font-bold transition-all">
          ğŸ“– Load Prompt
        </button>
      </div>
      
      <!-- Management Buttons -->
      <div class="grid grid-cols-2 gap-2 mb-2">
        <button id="exportPrompts" class="bg-dtpurple text-white px-4 py-3 rounded-lg font-bold hover:bg-dtcyan transition-all text-sm">ğŸ“¤ Export</button>
        <button id="importPrompts" class="bg-dtgreen text-black px-4 py-3 rounded-lg font-bold hover:bg-green-600 transition-all text-sm">ğŸ“¥ Import</button>
      </div>
      <div class="mb-4">
        <button id="clearAllPrompts" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-red-700 transition-all text-sm">ğŸ—‘ï¸ Clear All User Prompts</button>
      </div>
      
      <!-- Quick Help -->
      <div class="text-sm text-gray-400 bg-dtgray bg-opacity-30 rounded p-3 border border-gray-600">
        <p class="font-bold text-gray-300 mb-2">ğŸ’¡ Quick Tips:</p>
        <p>â€¢ <span class="text-dtcyan">Ctrl+S</span>: Quick Save</p>
        <p>â€¢ <span class="text-dtcyan">Ctrl+Shift+S</span>: Named Save</p>
        <p>â€¢ <span class="text-dtcyan">ğŸ’¾ User Saved</span>: Your custom configs</p>
        <p>â€¢ <span class="text-dtyellow">ğŸ“š Default</span>: 24 pre-built journeys</p>
        <p>â€¢ Export/Import: Share prompts</p>
      </div>
    </div>
  </div>



  <!-- Main Content -->
  <div id="mainContent" class="ml-80 transition-all duration-300">
    <div class="max-w-[2000px] mx-auto px-6 py-4 font-sans">
      <header class="flex items-center justify-between mb-6 p-4 rounded-xl bg-gradient-to-r from-dtpurple/10 to-dtcyan/10 border border-dtcyan/20">
        <div class="flex items-center space-x-4">
          <div class="p-2 rounded-lg bg-dtcyan/20 border border-dtcyan">
            <span class="text-2xl">ğŸ¢</span>
          </div>
          <div>
            <h1 class="text-3xl font-extrabold text-dtcyan tracking-tight drop-shadow">Business Observability Generator</h1>
            <p class="text-sm text-gray-300 mt-1">AI-powered customer journey simulation & performance testing</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="openDtSettingsModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-dtcard border border-dtborder hover:border-dtcyan text-gray-300 hover:text-dtcyan text-sm font-medium transition-all" title="Dynatrace Settings">
            <span>âš™ï¸</span>
            <span class="hidden sm:inline">Settings</span>
            <span id="dt-settings-indicator" class="w-2 h-2 rounded-full bg-gray-500" title="Not configured"></span>
          </button>
          <div class="px-3 py-1 rounded-full bg-dtgreen/20 border border-dtgreen text-dtgreen text-xs font-medium">
            âœ… READY
          </div>
          <span id="host-label" class="text-sm text-dtaccent font-medium px-3 py-1 rounded-full bg-dtpurple/20 border border-dtpurple">Smartscape UI Â· Real-time overlays</span>
        </div>
      </header>

      <!-- Service Status Dropdown - Top Right Corner -->
      <div class="fixed top-4 right-4 z-50">
        <div class="relative">
          <button id="services-dropdown-btn" onclick="toggleServicesDropdown()" class="bg-dtcard hover:bg-dtgray border border-dtborder rounded-lg px-3 py-2 text-sm font-medium text-white shadow-lg transition-all flex items-center gap-2">
            <span class="text-dtcyan">âš™ï¸</span>
            <span id="services-count">Services</span>
            <span class="text-xs">â–¼</span>
          </button>
          
          <div id="services-dropdown" class="absolute right-0 top-12 bg-dtcard border border-dtborder rounded-lg shadow-xl w-96 max-w-screen-sm hidden z-50">
            <div class="p-4 border-b border-dtborder flex items-center justify-between">
              <h3 class="text-sm font-semibold text-dtcyan flex items-center">
                <span class="w-2 h-2 bg-dtcyan rounded-full mr-2 animate-pulse"></span>
                Running Services
              </h3>
              <div class="flex gap-2">
                <button onclick="openServiceDashboard()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black rounded-lg px-3 py-1.5 text-xs font-bold transition-all duration-200" title="Open detailed service dashboard">
                  ğŸ“Š Details
                </button>
                <button onclick="updateServiceStatus()" class="bg-dtgray hover:bg-dtcyan text-white hover:text-black rounded-lg px-3 py-1.5 text-xs font-medium transition-all duration-200 flex items-center" title="Refresh service status">
                  <span class="mr-1">ğŸ”„</span>
                  Refresh
                </button>
              </div>
            </div>
            
            <div class="p-4 max-h-96 overflow-y-auto">
              <div id="service-status-loading-dropdown" class="text-center text-gray-400 text-sm py-8">
                <div class="animate-spin w-6 h-6 border-2 border-dtcyan border-t-transparent rounded-full mx-auto mb-2"></div>
                Loading services...
              </div>
              <div id="service-status-list-dropdown" class="hidden space-y-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="mb-8">
        <div class="relative">
          <!-- Progress Line -->
          <div class="absolute top-6 left-0 right-0 h-0.5 bg-dtgray z-0"></div>
          <div id="progress-line" class="absolute top-6 left-0 h-0.5 bg-gradient-to-r from-dtcyan to-dtpurple z-0 transition-all duration-500" style="width: 20%;"></div>
          
          <nav class="relative flex justify-between z-10">
            <button class="tab-button active flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border-2 border-dtcyan shadow-lg" data-tab="welcome">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtcyan text-black font-bold text-sm">ğŸ </div>
              <span class="text-xs font-medium text-center">Welcome</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step1">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">1</div>
              <span class="text-xs font-medium text-center">Customer<br>Details</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step2">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">2</div>
              <span class="text-xs font-medium text-center">Generate<br>Prompts</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step3">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">3</div>
              <span class="text-xs font-medium text-center">Generate<br>Data</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step4">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">ğŸ¤–</div>
              <span class="text-xs font-medium text-center">AI Agent<br>Hub</span>
            </button>
          </nav>
        </div>
      </div>

      <!-- Tab Content Container -->
      <div id="tabContent" class="min-h-[600px]">
        
        <!-- Welcome Tab -->
        <div class="tab-pane active" id="welcome-tab">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: App Overview -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ¯ Application Overview</h2>
              <div class="space-y-4 text-gray-300">
                <p class="text-lg"><strong class="text-dtcyan">Business Observability Generator</strong> creates realistic customer journey scenarios for performance testing and business intelligence demonstrations.</p>
                
                <div class="bg-dtpurple bg-opacity-20 rounded-lg p-4 border border-dtpurple">
                  <h3 class="text-dtcyan font-semibold mb-2">ğŸ”§ Core Functionality</h3>
                  <ul class="space-y-2 text-sm">
                    <li>â€¢ <strong>AI-Generated Journeys:</strong> Create realistic customer paths using Copilot prompts</li>
                    <li>â€¢ <strong>Business Intelligence:</strong> Generate revenue metrics, KPIs, and competitive insights</li>
                    <li>â€¢ <strong>Performance Testing:</strong> LoadRunner integration with customizable load profiles</li>
                    <li>â€¢ <strong>Real-time Simulation:</strong> Execute customer journeys with Dynatrace correlation</li>
                    <li>â€¢ <strong>Error Simulation:</strong> Toggle realistic errors for comprehensive testing scenarios</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Right Column: Business Use Cases -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ’¼ Business Use Cases</h2>
              <div class="space-y-4">
                
                <div class="bg-dtgreen bg-opacity-20 rounded-lg p-4 border border-dtgreen">
                  <h3 class="text-dtgreen font-semibold mb-2">ğŸ›ï¸ E-Commerce Scenarios</h3>
                  <p class="text-sm text-gray-300">Simulate customer shopping experiences, cart abandonment, payment processing, and seasonal traffic patterns with realistic revenue data.</p>
                </div>

                <div class="bg-dtblue bg-opacity-20 rounded-lg p-4 border border-dtblue">
                  <h3 class="text-dtblue font-semibold mb-2">ğŸ¢ Enterprise Applications</h3>
                  <p class="text-sm text-gray-300">Test B2B workflows, employee onboarding systems, CRM interactions, and resource management platforms under load.</p>
                </div>

                <div class="bg-dtyellow bg-opacity-20 rounded-lg p-4 border border-dtyellow">
                  <h3 class="text-dtyellow font-semibold mb-2">ğŸ“± Digital Services</h3>
                  <p class="text-sm text-gray-300">Validate SaaS platforms, mobile app backends, API performance, and multi-tenant architectures with business metrics.</p>
                </div>

                <div class="bg-dtpurple bg-opacity-20 rounded-lg p-4 border border-dtpurple">
                  <h3 class="text-dtpurple font-semibold mb-2">ğŸ¯ Demo Environments</h3>
                  <p class="text-sm text-gray-300">Create compelling demonstrations with realistic business data, competitive analysis, and industry-specific KPIs for stakeholder presentations.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Getting Started Section -->
          <div class="mt-6 p-6 rounded-2xl bg-gradient-to-r from-dtcyan/10 to-dtpurple/10 border border-dtcyan">
            <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸš€ Getting Started</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ¤–</div>
                <h3 class="font-semibold text-dtcyan mb-2">1. Generate AI Prompts</h3>
                <p class="text-sm text-gray-300">Start with company details to create intelligent Copilot prompts</p>
              </div>
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ¯</div>
                <h3 class="font-semibold text-dtcyan mb-2">2. Build Customer Journey</h3> 
                <p class="text-sm text-gray-300">Use AI-generated prompts to create realistic business workflows</p>
              </div>
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ“Š</div>
                <h3 class="font-semibold text-dtcyan mb-2">3. Test & Simulate</h3>
                <p class="text-sm text-gray-300">Execute load tests and customer simulations with business intelligence</p>
              </div>
            </div>
            <div class="mt-6 text-center">
              <button onclick="switchTab('step1')" class="bg-dtcyan hover:bg-dtpurple text-black hover:text-white font-bold px-6 py-3 rounded-lg transition-all duration-200">
                Start Building Your Journey â†’
              </button>
            </div>
          </div>
        </div>

        <!-- Step 1 Tab -->
        <div class="tab-pane" id="step1-tab">
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- Left Column: Journey Generator -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ‘¤ Step 1 - Customer Details</h2>
              
              <form id="journey-form" class="space-y-6">
                <div class="space-y-2">
                  <label for="companyName" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtcyan text-black rounded-full mr-3 text-sm font-bold">ğŸ¢</span>
                    Company Name
                  </label>
                  <input id="companyName" class="form-input-enhanced w-full" name="customer" placeholder="e.g., ShopMart, TechCorp, HealthPlus" />
                  <p class="text-sm text-gray-400 mt-2 ml-11">Enter the company name for your business scenario</p>
                </div>
                
                <div class="space-y-2">
                  <label for="domain" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtpurple text-white rounded-full mr-3 text-sm font-bold">ğŸŒ</span>
                    Website Domain
                  </label>
                  <input id="domain" class="form-input-enhanced w-full" name="website" placeholder="e.g., shopmart.com, techcorp.io" />
                  <p class="text-sm text-gray-400 mt-2 ml-11">Website domain for the customer journey simulation</p>
                </div>

                <div class="space-y-2">
                  <label for="journeyRequirements" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtgreen text-black rounded-full mr-3 text-sm font-bold">ğŸ¯</span>
                    Journey Requirements
                  </label>
                  <textarea id="journeyRequirements" class="form-input-enhanced w-full h-24 resize-y" name="requirements" placeholder="e.g., Order journey from website to delivery, Banking loan application process, Healthcare appointment booking flow"></textarea>
                  <p class="text-sm text-gray-400 mt-2 ml-11">Describe the specific customer journey scenario you want to simulate</p>
                </div>
            
                
                <div class="pt-6">
                  <button type="button" onclick="validateAndProceed()" class="btn-enhanced w-full">
                    <span class="flex items-center justify-center">
                      Next: Generate Prompts 
                      <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                    </span>
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Right Column: Instructions -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h3 class="text-xl mb-3 text-dtcyan font-bold">ğŸ“‹ What We'll Create</h3>
              <div class="space-y-4">
                <div class="p-4 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
                  <h4 class="text-dtblue font-semibold mb-2">ğŸ¤– AI-Generated Journey</h4>
                  <ul class="text-sm text-gray-300 space-y-1">
                    <li>â€¢ Realistic customer interaction patterns</li>
                    <li>â€¢ Business intelligence and revenue metrics</li>
                    <li>â€¢ Industry-specific journey steps</li>
                    <li>â€¢ Performance testing configurations</li>
                  </ul>
                </div>
                
                <div class="p-4 bg-dtyellow bg-opacity-20 rounded-lg border border-dtyellow">
                  <h4 class="text-dtyellow font-semibold mb-2">ğŸš€ Next Steps</h4>
                  <p class="text-sm text-gray-300">We'll generate tailored Copilot prompts that you can use to create realistic business scenarios.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 Tab - Generate Prompts -->
        <div class="tab-pane" id="step2-tab">
          <div class="max-w-6xl mx-auto">
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ¤– Step 2 - Generate Prompts</h2>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Generated Prompts -->
                <div class="space-y-4">
                  <div class="p-3 bg-dtpurple bg-opacity-20 rounded-lg border border-dtpurple mb-4">
                    <p class="text-sm text-gray-300">
                      <strong>ğŸ“‹ Instructions:</strong> Copy each prompt below to Copilot Chat, then return to paste the JSON response.
                    </p>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Copilot Prompt 1 - C-suite Analysis</h4>
                      <div class="flex gap-2"><button onclick="copyToClipboard('promptText1')" class="text-xs bg-dtpurple text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all">ğŸ“‹ Copy</button><button onclick="openCopilotEditor('promptText1-step2')" class="text-xs bg-dtblue text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                    </div>
                    <textarea id="promptText1-step2" readonly class="w-full h-32 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono resize-y"></textarea>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Copilot Prompt 2 - Customer Journey</h4>
                      <div class="flex gap-2"><button onclick="copyToClipboard('promptText2')" class="text-xs bg-dtpurple text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all">ğŸ“‹ Copy</button><button onclick="openCopilotEditor('promptText2-step2')" class="text-xs bg-dtblue text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                    </div>
                    <textarea id="promptText2-step2" readonly class="w-full h-32 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono resize-y"></textarea>
                  </div>
                  
                  <div class="p-3 bg-dtgreen bg-opacity-20 rounded-lg border border-dtgreen">
                    <p class="text-sm text-dtgreen font-semibold mb-1">âœ… Ready to Copy</p>
                    <p class="text-xs text-gray-300">Both prompts have been generated and are ready to use with Copilot Chat.</p>
                  </div>
                </div>
                
                <!-- Right Column: Response Input -->
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Paste Copilot's Response</h4>
                      <button onclick="loadTestJSON()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition-all">ğŸ“ Load Test Data</button>
                    </div>
                    <div class="relative"><textarea id="copilotResponse-step2" placeholder="After running the prompts in Copilot Chat, paste the JSON response here..." class="w-full h-64 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono pr-20" onchange="checkResponseInput()"></textarea><button onclick="openCopilotEditor('copilotResponse-step2')" class="absolute top-2 right-2 bg-dtblue hover:bg-dtcyan text-white hover:text-black px-3 py-1 rounded text-xs font-medium transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                  </div>
                  
                  <div class="space-y-2">
                    <button id="processJourneyResponse" onclick="processJourneyResponse(); switchTab('step3');" class="bg-dtgreen text-black px-6 py-3 rounded-lg text-base font-bold shadow-card hover:bg-dtcyan transition-all w-full" disabled>
                      âš¡ Process Response & Continue â†’
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <button onclick="switchTab('step1')" class="bg-dtgray text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtpurple transition-all">
                        â† Back to Details
                      </button>
                      <button onclick="switchTab('step3')" class="bg-dtpurple text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtcyan hover:text-black transition-all">
                        Skip to Generate â†’
                      </button>
                    </div>
                  </div>
                  
                  <div class="p-3 bg-dtyellow bg-opacity-20 rounded-lg border border-dtyellow">
                    <p class="text-sm text-dtyellow font-semibold mb-1">ğŸ’¡ Tip</p>
                    <p class="text-xs text-gray-300">Use both prompts in sequence for best results. The C-suite analysis provides context for the customer journey generation.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Hidden container for processed journey data (used by JS) -->
        <div id="step3-data-store" style="display:none;">
          <pre id="journey-output-step3"></pre>
          <span id="step-count">0</span>
          <span id="field-count">0</span>
          <div id="generated-fields-preview"></div>
        </div>

        <!-- Step 3 Tab - Generate Data -->
        <div class="tab-pane" id="step3-tab">
          <div class="max-w-6xl mx-auto">
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl text-dtcyan font-bold tracking-tight">ğŸ“Š Step 3 - Generate Data</h2>
                <div class="text-xs text-gray-400">
                  Multi-tenant: Services persist across journeys
                </div>
              </div>
              
              <!-- Single Simulation Mode -->
              <div id="single-mode" class="data-mode-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸš€ Journey Simulation</h4>
                    
                    <div class="p-3 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
                      <h5 class="text-dtblue font-semibold mb-2">Real Customer Journey</h5>
                      <p class="text-xs text-gray-400">Executes realistic customer interactions with Dynatrace correlation headers and business metrics.</p>
                    </div>
                    
                    <button id="run-journey-simulation-step4" onclick="runJourneySimulation(); updateSimulationStatus('Running customer journey simulation...');" class="w-full bg-dtgreen hover:bg-dtcyan text-black font-bold rounded-lg p-4 shadow-card transition-all text-lg">
                      ğŸš€ Run Single Journey Simulation
                    </button>
                    
                    <div id="simulation-status-step4" class="p-3 bg-dtgray rounded-lg text-sm">
                      Ready to run simulation with current journey configuration
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸ“ˆ Live Results</h4>
                    <div id="simulation-results-step4" class="p-3 bg-dtgray rounded-lg text-sm h-64 overflow-auto">
                      <div class="text-center text-gray-400 mt-8">
                        <div class="text-2xl mb-2">ğŸ“Š</div>
                        <p>Simulation results will appear here</p>
                        <p class="text-xs mt-2">Including: Response times, business metrics, Dynatrace traces, and error scenarios</p>
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <button onclick="clearSimulationResults()" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded px-3 py-2 text-sm transition-all">
                        ğŸ—‘ï¸ Clear Results
                      </button>
                      <button onclick="exportSimulationResults()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black font-bold rounded px-3 py-2 text-sm transition-all">
                        ğŸ“ Export Results
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Dynatrace Integration Section -->
                <div class="mt-6 p-4 bg-gradient-to-r from-dtpurple to-dtblue bg-opacity-20 rounded-lg border border-dtcyan">
                  <h4 class="text-lg font-bold text-dtcyan mb-3 flex items-center gap-2">
                    <span>ğŸ”—</span> Dynatrace Integration
                  </h4>
                  <p class="text-sm text-gray-300 mb-4">
                    Auto-deploy monitoring dashboards and configure Dynatrace settings for your journey
                  </p>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="deployDynatraceDashboard()" class="bg-dtcyan hover:bg-dtgreen text-black font-bold rounded-lg px-4 py-3 shadow-card transition-all text-sm">
                      ğŸ“Š Deploy Journey Dashboard
                    </button>
                    <button onclick="generateAIDashboard()" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold rounded-lg px-4 py-3 shadow-card transition-all text-sm">
                      ğŸ¤– AI Dashboard (5s)
                    </button>
                  </div>
                  <div class="grid grid-cols-1 gap-3 mt-3">
                    <button onclick="queryDynatraceData()" class="bg-dtblue hover:bg-dtcyan text-white hover:text-black font-bold rounded-lg px-4 py-3 shadow-card transition-all text-sm">
                      âœ… Verify Data Ingestion
                    </button>
                  </div>
                  <div id="dynatrace-status" class="mt-3 p-3 bg-black bg-opacity-50 rounded text-xs font-mono text-gray-400">
                    Ready to deploy Dynatrace dashboards...
                  </div>
                </div>
              </div>
              

              
              <!-- Navigation -->
              <div class="mt-6 flex justify-between">
                <button onclick="switchTab('step2')" class="bg-dtgray text-white px-6 py-3 rounded-lg text-base font-medium hover:bg-dtpurple transition-all">
                  â† Back to Prompts
                </button>
                <button onclick="switchTab('step4')" class="bg-dtpurple text-white px-6 py-3 rounded-lg text-base font-medium hover:bg-dtcyan hover:text-black transition-all">
                  AI Agents â†’
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- Step 4 Tab - AI Agent Hub -->
        <div class="tab-pane" id="step4-tab">
          <div class="max-w-7xl mx-auto space-y-5">

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  HEADER + JOURNEY SELECTOR                     -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="p-5 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">ğŸ¤–</span>
                  <div>
                    <h2 class="text-2xl text-dtcyan font-bold tracking-tight">AI Agent Hub</h2>
                    <p class="text-xs text-gray-400">Select a journey to auto-populate services, then unleash the agents.</p>
                  </div>
                </div>
                <span class="text-xs text-gray-500 font-mono" id="agents-status-badge">Ready</span>
              </div>

              <!-- Journey Selector Row -->
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
                <!-- Journey Dropdown -->
                <div class="lg:col-span-2">
                  <label class="block text-sm font-semibold text-gray-300 mb-1">ğŸ“‹ Select Journey</label>
                  <select id="agent-journey-select" onchange="window._agentSelectJourney(this.value)" class="w-full p-2.5 bg-black border border-dtcyan rounded-lg text-white text-sm focus:border-dtgreen focus:outline-none">
                    <option value="">Loading journeys...</option>
                  </select>
                </div>
                <!-- Quick Info -->
                <div class="flex items-end gap-2">
                  <button onclick="window._agentRefreshJourneys()" class="flex-1 bg-dtgray text-white px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-dtcyan hover:text-black transition-all border border-dtborder">
                    â†» Refresh
                  </button>
                  <button onclick="window._agentUseCurrentJourney()" class="flex-1 bg-dtcyan bg-opacity-20 text-dtcyan px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-opacity-40 transition-all border border-dtcyan" title="Use journey data from Steps 1-3">
                    ğŸ“¥ Use Current
                  </button>
                </div>
              </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  JOURNEY CONTEXT PANEL                         -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-journey-context" class="hidden p-5 rounded-2xl bg-gradient-to-r from-dtcard to-black border border-dtcyan border-opacity-30 shadow-card">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h3 class="text-lg font-bold text-dtcyan" id="agent-ctx-company">â€”</h3>
                  <p class="text-xs text-gray-400"><span id="agent-ctx-industry" class="text-gray-300">â€”</span> Â· <span id="agent-ctx-journey-type" class="text-dtpurple">â€”</span></p>
                </div>
                <div class="text-right">
                  <p class="text-xl font-bold text-dtgreen" id="agent-ctx-step-count">0</p>
                  <p class="text-[10px] text-gray-500 uppercase tracking-widest">Steps</p>
                </div>
              </div>

              <!-- Service Cards -->
              <div class="mt-3">
                <p class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wider">ğŸ”— Services in this Journey</p>
                <div id="agent-service-cards" class="flex flex-wrap gap-2">
                  <span class="text-xs text-gray-500">No services loaded</span>
                </div>
              </div>

              <!-- Steps Flow -->
              <div class="mt-4">
                <p class="text-xs text-gray-400 mb-2 font-semibold uppercase tracking-wider">ğŸ“Š Journey Steps</p>
                <div id="agent-steps-flow" class="flex flex-wrap gap-1 items-center">
                  <span class="text-xs text-gray-500">No steps loaded</span>
                </div>
              </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  AGENT CARDS - HORIZONTAL TABS                 -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="flex gap-2 flex-wrap">
              <button onclick="window._agentShowPanel('gremlin')" class="agent-tab active text-xs px-4 py-2 rounded-full border transition-all cursor-pointer bg-red-900 bg-opacity-60 text-red-400 border-red-700 hover:bg-opacity-80" data-agent="gremlin">ğŸ‘¹ Gremlin</button>
              <button onclick="window._agentShowPanel('fixit')" class="agent-tab text-xs px-4 py-2 rounded-full border transition-all cursor-pointer bg-dtgray text-gray-400 border-dtborder hover:border-green-700 hover:text-dtgreen" data-agent="fixit">ğŸ”§ Fix-It</button>
              <button onclick="window._agentShowPanel('librarian')" class="agent-tab text-xs px-4 py-2 rounded-full border transition-all cursor-pointer bg-dtgray text-gray-400 border-dtborder hover:border-blue-700 hover:text-dtblue" data-agent="librarian">ğŸ“š Librarian</button>
              <button onclick="window._agentShowPanel('dashboard')" class="agent-tab text-xs px-4 py-2 rounded-full border transition-all cursor-pointer bg-dtgray text-gray-400 border-dtborder hover:border-purple-700 hover:text-dtpurple" data-agent="dashboard">ğŸ“Š Dashboard</button>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  GREMLIN PANEL                                 -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-panel-gremlin" class="agent-panel p-6 rounded-2xl bg-dtcard border-2 border-red-800 shadow-card">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-3xl">ğŸ‘¹</span>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-red-400">Gremlin &mdash; Chaos Agent</h3>
                  <p class="text-xs text-gray-500">Target services from your selected journey to inject feature-flag faults</p>
                </div>
                <span class="text-[10px] bg-red-900 text-red-300 px-2 py-0.5 rounded-full border border-red-700 uppercase tracking-widest">Chaos</span>
              </div>
              <div class="border-b border-red-900 mb-4"></div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: Controls -->
                <div class="space-y-4">
                  <!-- Target Service (auto-populated) -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-1">ğŸ¯ Target Service</label>
                    <select id="gremlin-target-service" class="w-full p-2.5 bg-black border border-dtborder rounded-lg text-white text-sm focus:border-red-400 focus:outline-none">
                      <option value="all">All Services (Random)</option>
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-1">Chaos Recipe</label>
                    <select id="gremlin-recipe" class="w-full p-2.5 bg-black border border-dtborder rounded-lg text-white text-sm focus:border-red-400 focus:outline-none">
                      <option value="">Loading recipes...</option>
                    </select>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-semibold text-gray-300 mb-1">Intensity (1-10)</label>
                      <input id="gremlin-intensity" type="number" min="1" max="10" value="5" class="w-full p-2.5 bg-black border border-dtborder rounded-lg text-white text-sm focus:border-red-400 focus:outline-none">
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-300 mb-1">Duration (sec)</label>
                      <input id="gremlin-duration" type="number" min="10" max="600" value="120" class="w-full p-2.5 bg-black border border-dtborder rounded-lg text-white text-sm focus:border-red-400 focus:outline-none">
                    </div>
                  </div>
                  <button onclick="window._agentInjectChaos()" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-red-500 transition-all shadow-card">
                    ğŸ‘¹ Inject Chaos
                  </button>

                  <!-- Smart Chaos -->
                  <div class="border-t border-dtborder pt-4">
                    <label class="block text-sm font-semibold text-gray-300 mb-1">Smart Chaos (Natural Language)</label>
                    <textarea id="gremlin-smart-input" rows="2" class="w-full p-2.5 bg-black border border-dtborder rounded-lg text-white text-sm focus:border-red-400 focus:outline-none" placeholder="e.g. Simulate a payment outage for 2 minutes"></textarea>
                    <button onclick="window._agentSmartChaos()" class="mt-2 w-full bg-dtorange text-black px-4 py-2 rounded-lg text-sm font-bold hover:bg-dtyellow transition-all">
                      ğŸ§  Smart Chaos
                    </button>
                  </div>
                </div>

                <!-- Right: Active Faults -->
                <div>
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-bold text-gray-300">Active Faults</h4>
                    <div class="flex gap-2">
                      <button onclick="window._agentRefreshFaults()" class="text-xs text-dtcyan hover:underline">â†» Refresh</button>
                      <button onclick="window._agentRevertAll()" class="text-xs text-red-400 hover:underline">â¹ Revert All</button>
                    </div>
                  </div>
                  <div id="gremlin-active-faults" class="bg-black rounded-lg border border-dtborder p-3 min-h-[200px] max-h-[300px] overflow-y-auto text-sm">
                    <p class="text-gray-500 text-center text-xs">No active faults</p>
                  </div>
                </div>
              </div>

              <!-- Gremlin Results -->
              <div id="gremlin-result" class="mt-4 hidden">
                <pre class="bg-black rounded-lg border border-red-900 p-3 text-xs text-green-400 max-h-40 overflow-y-auto whitespace-pre-wrap"></pre>
              </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  FIX-IT PANEL                                  -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-panel-fixit" class="agent-panel hidden p-6 rounded-2xl bg-dtcard border-2 border-green-800 shadow-card">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-3xl">ğŸ”§</span>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-dtgreen">Fix-It &mdash; Remediation Agent</h3>
                  <p class="text-xs text-gray-500">Automated remediation triggered by Dynatrace workflows</p>
                </div>
                <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded-full border border-green-700 uppercase tracking-widest">Workflow</span>
              </div>
              <div class="border-b border-green-900 mb-4"></div>

              <!-- How it works -->
              <div class="bg-black bg-opacity-40 rounded-xl p-5 border border-green-900 mb-4">
                <h4 class="text-sm font-bold text-green-400 mb-3">How It Works</h4>
                <div class="flex items-start gap-4 text-xs text-gray-400">
                  <div class="flex flex-col items-center gap-1 text-center min-w-[80px]">
                    <span class="text-2xl">ğŸš¨</span>
                    <span class="font-bold text-white">DT Problem</span>
                    <span class="text-[10px]">Detected by Davis</span>
                  </div>
                  <span class="text-green-600 mt-3 text-lg">&rarr;</span>
                  <div class="flex flex-col items-center gap-1 text-center min-w-[80px]">
                    <span class="text-2xl">âš™ï¸</span>
                    <span class="font-bold text-white">Workflow</span>
                    <span class="text-[10px]">HTTP Action trigger</span>
                  </div>
                  <span class="text-green-600 mt-3 text-lg">&rarr;</span>
                  <div class="flex flex-col items-center gap-1 text-center min-w-[80px]">
                    <span class="text-2xl">ğŸ¤–</span>
                    <span class="font-bold text-white">Fix-It Agent</span>
                    <span class="text-[10px]">Diagnose + remediate</span>
                  </div>
                  <span class="text-green-600 mt-3 text-lg">&rarr;</span>
                  <div class="flex flex-col items-center gap-1 text-center min-w-[80px]">
                    <span class="text-2xl">âœ…</span>
                    <span class="font-bold text-white">Resolved</span>
                    <span class="text-[10px]">Flags reset, verified</span>
                  </div>
                </div>
              </div>

              <!-- API Endpoints for Workflows -->
              <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Workflow API Endpoints</h4>
              <div class="space-y-3">
                <!-- Auto Fix -->
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded font-mono">POST</span>
                    <code class="text-xs text-green-400 font-mono">/api/fixit/auto</code>
                    <span class="text-[10px] text-gray-600 ml-auto">Recommended for workflows</span>
                  </div>
                  <p class="text-[11px] text-gray-500 mb-2">Full auto-remediation pipeline: detects problems from DT, diagnoses via LLM + rules, applies fixes, verifies resolution.</p>
                  <div class="bg-gray-900 rounded-lg p-2.5 border border-gray-800">
                    <pre class="text-[10px] text-gray-400 font-mono whitespace-pre">// Workflow HTTP Action body
{
  "problemId": "{{ .problem.id }}"  // optional â€” omit for auto-detect
}</pre>
                  </div>
                </div>

                <!-- Diagnose -->
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-[10px] bg-blue-900 text-blue-300 px-2 py-0.5 rounded font-mono">POST</span>
                    <code class="text-xs text-blue-400 font-mono">/api/fixit/diagnose</code>
                  </div>
                  <p class="text-[11px] text-gray-500 mb-2">Diagnose only (no auto-fix). Returns root cause analysis, affected services, and recommended actions.</p>
                  <div class="bg-gray-900 rounded-lg p-2.5 border border-gray-800">
                    <pre class="text-[10px] text-gray-400 font-mono whitespace-pre">{ "problemId": "{{ .problem.id }}" }</pre>
                  </div>
                </div>

                <!-- Agentic -->
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-[10px] bg-purple-900 text-purple-300 px-2 py-0.5 rounded font-mono">POST</span>
                    <code class="text-xs text-purple-400 font-mono">/api/fixit/agentic</code>
                  </div>
                  <p class="text-[11px] text-gray-500 mb-2">Natural language AI agent â€” describe the problem and let the LLM autonomously investigate and fix it.</p>
                  <div class="bg-gray-900 rounded-lg p-2.5 border border-gray-800">
                    <pre class="text-[10px] text-gray-400 font-mono whitespace-pre">{ "description": "{{ .problem.title }}" }</pre>
                  </div>
                </div>
              </div>

              <!-- Quick Test -->
              <div class="border-t border-green-900 mt-4 pt-4">
                <div class="flex items-center gap-3">
                  <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Quick Test</h4>
                  <button onclick="window._fixitQuickTest()" id="fixit-test-btn" class="bg-green-900 text-green-300 px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-green-800 transition-all border border-green-700">
                    ğŸ§ª Test Auto Fix Endpoint
                  </button>
                  <span id="fixit-test-status" class="text-[10px] text-gray-600"></span>
                </div>
                <div id="fixit-result" class="mt-3 hidden">
                  <pre class="bg-black rounded-lg border border-green-900 p-3 text-xs text-green-400 max-h-48 overflow-y-auto whitespace-pre-wrap"></pre>
                </div>
              </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  LIBRARIAN PANEL                               -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-panel-librarian" class="agent-panel hidden p-6 rounded-2xl bg-dtcard border-2 border-blue-800 shadow-card">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-3xl">ğŸ“š</span>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-dtblue">Librarian &mdash; Operational Memory</h3>
                  <p class="text-xs text-gray-500">Search incident history, view timelines, and review operational stats</p>
                </div>
                <span class="text-[10px] bg-blue-900 text-blue-300 px-2 py-0.5 rounded-full border border-blue-700 uppercase tracking-widest">Memory</span>
              </div>
              <div class="border-b border-blue-900 mb-4"></div>

              <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <h4 class="text-sm font-bold text-dtblue mb-2">ğŸ“Š Stats</h4>
                  <div id="librarian-stats" class="text-xs text-gray-400 min-h-[60px]">
                    <p>Loading...</p>
                  </div>
                  <button onclick="window._agentLibStats()" class="mt-2 text-xs text-dtcyan hover:underline">â†» Refresh</button>
                </div>
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <h4 class="text-sm font-bold text-dtblue mb-2">ğŸ” Search</h4>
                  <input id="librarian-search-input" type="text" class="w-full p-2 bg-dtdark border border-dtborder rounded-lg text-white text-xs mb-2 focus:border-dtblue focus:outline-none" placeholder="Search incidents...">
                  <button onclick="window._agentLibSearch()" class="w-full bg-dtblue text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-dtcyan hover:text-black transition-all">
                    Search
                  </button>
                </div>
                <div class="bg-black bg-opacity-40 rounded-xl p-4 border border-dtborder">
                  <h4 class="text-sm font-bold text-dtblue mb-2">ğŸ“… Timeline</h4>
                  <input id="librarian-timeline-id" type="text" class="w-full p-2 bg-dtdark border border-dtborder rounded-lg text-white text-xs mb-2 focus:border-dtblue focus:outline-none" placeholder="Incident ID...">
                  <button onclick="window._agentLibTimeline()" class="w-full bg-dtblue text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-dtcyan hover:text-black transition-all">
                    View Timeline
                  </button>
                </div>
              </div>

              <div>
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-bold text-gray-300">Recent History</h4>
                  <button onclick="window._agentLibHistory()" class="text-xs text-dtcyan hover:underline">â†» Refresh</button>
                </div>
                <div id="librarian-history" class="bg-black rounded-lg border border-dtborder p-3 min-h-[100px] max-h-[200px] overflow-y-auto text-xs">
                  <p class="text-gray-500 text-center">Loading history...</p>
                </div>
              </div>

              <div id="librarian-result" class="mt-4 hidden">
                <pre class="bg-black rounded-lg border border-blue-900 p-3 text-xs text-green-400 max-h-40 overflow-y-auto whitespace-pre-wrap"></pre>
              </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <!--  DASHBOARD PANEL                               -->
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="agent-panel-dashboard" class="agent-panel hidden p-6 rounded-2xl bg-dtcard border-2 border-purple-800 shadow-card">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-3xl">ğŸ“Š</span>
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-dtpurple">Dashboard &mdash; AI Generator</h3>
                  <p class="text-xs text-gray-500">Generate & deploy Dynatrace dashboards from your selected journey</p>
                </div>
                <span id="dashboard-ai-status" class="text-[10px] bg-purple-900 text-purple-300 px-2 py-0.5 rounded-full border border-purple-700 uppercase tracking-widest">Generator</span>
              </div>
              <div class="border-b border-purple-900 mb-4"></div>

              <!-- Journey Selector for Dashboard -->
              <div class="mb-4 p-3 bg-black bg-opacity-40 rounded-xl border border-purple-900">
                <label class="block text-xs font-semibold text-gray-400 mb-1.5">ğŸ“‹ Select Journey for Dashboard</label>
                <select id="dashboard-journey-select" onchange="window._dashSelectJourney(this.value)" class="w-full p-2.5 bg-black border border-dtpurple rounded-lg text-white text-sm focus:border-dtcyan focus:outline-none">
                  <option value="">Use currently selected journey from Agent Hub</option>
                </select>
                <p id="dashboard-journey-info" class="text-[10px] text-gray-600 mt-1.5">Dashboard will use the journey selected in the Agent Hub above</p>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="space-y-4">
                  <div class="flex items-center justify-between p-3 bg-black bg-opacity-40 rounded-xl border border-dtborder">
                    <div>
                      <h4 class="text-sm font-bold text-gray-300">Use AI (Ollama)</h4>
                      <p class="text-xs text-gray-500">Uses LLM to select optimal tiles; falls back to rules if unavailable</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="dashboard-use-ai" checked class="sr-only peer">
                      <div class="w-11 h-6 bg-dtborder rounded-full peer peer-checked:bg-dtpurple peer-focus:ring-2 peer-focus:ring-dtpurple after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full"></div>
                    </label>
                  </div>

                  <div class="grid grid-cols-2 gap-3">
                    <button onclick="window._agentDashPreview()" class="bg-dtpurple bg-opacity-30 text-dtpurple border border-dtpurple px-4 py-3 rounded-lg text-sm font-bold hover:bg-opacity-60 transition-all">
                      ğŸ‘ï¸ Preview Fields
                    </button>
                    <button onclick="window._agentDashGenerate()" class="bg-dtpurple text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-dtcyan hover:text-black transition-all shadow-card">
                      ğŸ§  Generate Dashboard
                    </button>
                  </div>

                  <div class="border-t border-dtborder pt-4 space-y-3">
                    <button onclick="window._agentDashDeploy()" class="w-full bg-dtgreen text-black px-4 py-3 rounded-lg text-sm font-bold hover:bg-dtcyan transition-all shadow-card">
                      ğŸš€ Deploy to Dynatrace
                    </button>
                    <button onclick="window._agentDashDownload()" class="w-full bg-dtgray text-white px-4 py-2 rounded-lg text-xs font-medium hover:bg-dtpurple transition-all border border-dtborder">
                      ğŸ’¾ Download JSON
                    </button>
                  </div>

                  <button onclick="window._agentDashHealth()" class="text-xs text-gray-500 hover:text-dtcyan underline">Check Ollama Health</button>
                </div>

                <div class="space-y-3">
                  <div class="bg-black bg-opacity-40 rounded-xl border border-dtborder p-4">
                    <h4 class="text-sm font-bold text-dtpurple mb-2">Dashboard Preview</h4>
                    <div id="dashboard-preview" class="text-xs text-gray-400 min-h-[120px]">
                      <p class="text-gray-500 text-center">Generate or preview to see dashboard details</p>
                    </div>
                  </div>
                  <div id="dashboard-deploy-status" class="hidden bg-black bg-opacity-40 rounded-xl border border-dtgreen p-3">
                    <p class="text-xs text-dtgreen font-semibold">Deployment status will appear here</p>
                  </div>
                </div>
              </div>

              <div id="dashboard-result" class="mt-4 hidden">
                <pre class="bg-black rounded-lg border border-purple-900 p-3 text-xs text-green-400 max-h-60 overflow-y-auto whitespace-pre-wrap"></pre>
              </div>
            </div>

            <!-- Footer Nav -->
            <div class="flex justify-between mt-2">
              <button onclick="switchTab('step3')" class="bg-dtgray text-white px-6 py-3 rounded-lg text-base font-medium hover:bg-dtpurple transition-all">
                â† Back to Generate Data
              </button>
              <div class="text-center">
                <p class="text-sm text-gray-400 mb-1">ğŸ¤– AI Agent Hub</p>
                <p class="text-xs text-gray-500">Gremlin Â· Fix-It Â· Librarian Â· Dashboard</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
    </div>
  </div>
  
    <!-- Feature Flags Modal Removed - System is Fully Automatic -->
    <div id="feature-flags-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[100] hidden flex items-center justify-center p-4" onclick="closeFeatureFlagsModal(event)" style="display: none !important;">
      <div class="bg-dtcard border-2 border-dtpurple rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-dtpurple to-dtcyan p-6 flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
              <span>ğŸš¦</span>
              Feature Flags Configuration
              <span class="text-xs bg-dtgreen text-black px-2 py-1 rounded-full">AUTO-GENERATED</span>
            </h2>
            <p class="text-sm text-gray-300 mt-1">Automatically created from your journey steps</p>
          </div>
          <button onclick="closeFeatureFlagsModal()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-bold transition-all">
            âœ• Close
          </button>
        </div>
        
        <!-- Feature Flags Content -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 160px);">
          <div class="space-y-4">
            
            <!-- Auto-generation Controls -->
            <div class="flex gap-3">
              <button onclick="regenerateFeatureFlags()" class="flex-1 p-3 bg-dtpurple hover:bg-dtpurple/80 text-white rounded-lg font-semibold flex items-center justify-center gap-2 transition-all">
                <span class="text-xl">ğŸ”„</span>
                <span>Regenerate Flags</span>
              </button>
              <button onclick="addNewFeatureFlag()" class="flex-1 p-3 border-2 border-dtcyan text-dtcyan hover:bg-dtcyan hover:text-black rounded-lg font-semibold flex items-center justify-center gap-2 transition-all">
                <span class="text-xl">â•</span>
                <span>Add Custom Flag</span>
              </button>
            </div>


            <!-- Active Feature Flags Container -->
            <div id="feature-flags-container" class="space-y-3">
              <!-- Dynamic feature flags will be inserted here -->
            </div>

            <!-- Example Templates (Collapsed by default) -->
            <div class="p-4 bg-dtgray rounded-lg border border-dtborder">
              <button onclick="toggleTemplates()" class="w-full flex items-center justify-between text-left">
                <span class="text-white font-semibold">ğŸ“‹ Example Templates</span>
                <span id="templates-arrow" class="text-dtcyan">â–¼</span>
              </button>
              <div id="templates-content" class="hidden mt-3 space-y-2 text-xs">
                <button onclick="applyTemplate('timeout')" class="w-full text-left p-2 bg-dtcard rounded hover:bg-dtblue hover:bg-opacity-20 transition-all">
                  <strong class="text-dtcyan">Timeout Error:</strong> <span class="text-gray-400">Service timeout (504) - 15% rate</span>
                </button>
                <button onclick="applyTemplate('unavailable')" class="w-full text-left p-2 bg-dtcard rounded hover:bg-dtblue hover:bg-opacity-20 transition-all">
                  <strong class="text-dtyellow">Service Unavailable:</strong> <span class="text-gray-400">Service down (503) - 10% rate</span>
                </button>
                <button onclick="applyTemplate('validation')" class="w-full text-left p-2 bg-dtcard rounded hover:bg-dtblue hover:bg-opacity-20 transition-all">
                  <strong class="text-dtgreen">Validation Error:</strong> <span class="text-gray-400">Invalid data (400) - 5% rate</span>
                </button>
                <button onclick="applyTemplate('rate_limit')" class="w-full text-left p-2 bg-dtcard rounded hover:bg-dtblue hover:bg-opacity-20 transition-all">
                  <strong class="text-dtpurple">Rate Limit:</strong> <span class="text-gray-400">Too many requests (429) - 8% rate</span>
                </button>
              </div>
            </div>

            <!-- Info Panel -->
            <div class="p-4 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
              <h4 class="text-dtblue font-semibold mb-2 flex items-center gap-2">
                <span>â„¹ï¸</span>
                How It Works
              </h4>
              <ul class="text-xs text-gray-300 space-y-1">
                <li>â€¢ <strong>Custom Flags:</strong> Create flags for any journey type (retail, manufacturing, banking, etc.)</li>
                <li>â€¢ <strong>Error Injection:</strong> Errors applied based on step names and probability</li>
                <li>â€¢ <strong>Bizevent Capture:</strong> All errors tagged with <code>error.feature_flag</code> for Dynatrace</li>
                <li>â€¢ <strong>Workflow Ready:</strong> Use in Dynatrace workflows for auto-remediation</li>
              </ul>
            </div>

            <!-- Status Summary -->
            <div class="flex items-center justify-between p-4 bg-dtgray rounded-lg border border-dtborder">
              <div>
                <span class="text-white font-semibold">Active Flags:</span>
                <span id="modal-active-flags-count" class="text-dtcyan font-bold ml-2">0</span>
              </div>
              <button onclick="clearAllFeatureFlags()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                Clear All
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Service Management Dashboard Modal -->
    <div id="service-dashboard-modal" class="fixed inset-0 bg-black bg-opacity-75 z-[100] hidden flex items-center justify-center p-4" onclick="closeServiceDashboard(event)">
      <div class="bg-dtcard border-2 border-dtcyan rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-dtpurple to-dtblue p-6 flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
              <span>ğŸ“Š</span>
              Service Management Dashboard
            </h2>
            <p class="text-sm text-gray-300 mt-1">Real-time monitoring of multi-tenant service infrastructure</p>
          </div>
          <button onclick="closeServiceDashboard()" class="bg-red-600 hover:bg-red-700 text-white rounded-lg px-4 py-2 font-bold transition-all">
            âœ• Close
          </button>
        </div>
        
        <!-- Stats Bar -->
        <div id="service-dashboard-stats" class="bg-dtgray p-4 border-b border-dtborder grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-dtcyan" id="stat-total-companies">-</div>
            <div class="text-xs text-gray-400">Companies</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-dtgreen" id="stat-running-services">-</div>
            <div class="text-xs text-gray-400">Running Services</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-white" id="stat-total-services">-</div>
            <div class="text-xs text-gray-400">Total Services</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-dtyellow" id="stat-active-loadtests">-</div>
            <div class="text-xs text-gray-400">Load Tests</div>
          </div>
          <div class="text-center">
            <button onclick="refreshServiceDashboard()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold transition-all w-full">
              ğŸ”„ Refresh
            </button>
          </div>
        </div>
        
        <!-- Tabs -->
        <div class="bg-dtgray border-b border-dtborder">
          <div class="flex gap-2 p-2">
            <button onclick="switchDashboardTab('services')" id="tab-services" class="dashboard-tab active px-6 py-2 rounded-lg text-sm font-bold transition-all">
              ğŸ”§ Services
            </button>
            <button onclick="switchDashboardTab('loadtests')" id="tab-loadtests" class="dashboard-tab px-6 py-2 rounded-lg text-sm font-bold transition-all">
              âš¡ Load Tests
            </button>
            <button onclick="switchDashboardTab('history')" id="tab-history" class="dashboard-tab px-6 py-2 rounded-lg text-sm font-bold transition-all">
              ğŸ“œ History
            </button>
          </div>
        </div>
        
        <!-- Service List -->
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 320px);">
          <div id="service-dashboard-loading" class="text-center py-12">
            <div class="animate-spin w-12 h-12 border-4 border-dtcyan border-t-transparent rounded-full mx-auto mb-4"></div>
            <div class="text-gray-400">Loading service data...</div>
          </div>
          
          <!-- Services Tab Content -->
          <div id="dashboard-content-services" class="hidden space-y-6">
            <!-- Will be populated dynamically -->
          </div>
          
          <!-- Load Tests Tab Content -->
          <div id="dashboard-content-loadtests" class="hidden space-y-4">
            <!-- Will be populated dynamically -->
          </div>
          
          <!-- History Tab Content -->
          <div id="dashboard-content-history" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
              <!-- Sidebar with Dropdowns -->
              <div class="lg:col-span-1 space-y-4">
                <!-- User Saved Configs Dropdown -->
                <div class="bg-dtgray rounded-xl border border-dtborder p-4">
                  <h3 class="text-sm font-bold text-dtcyan mb-3 flex items-center gap-2">
                    <span>ğŸ’¾</span> User Saved
                  </h3>
                  <select id="user-saved-configs" class="w-full bg-dtcard border border-dtcyan rounded-lg p-2 text-white text-sm mb-3">
                    <option value="">Select configuration...</option>
                  </select>
                  <div class="flex flex-col gap-2">
                    <button onclick="restoreUserConfig()" class="w-full bg-dtpurple hover:bg-dtcyan text-white hover:text-black px-3 py-2 rounded-lg text-sm font-bold transition-all">
                      â†©ï¸ Restore
                    </button>
                    <button onclick="deleteUserConfig()" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm font-bold transition-all">
                      ğŸ—‘ï¸ Delete
                    </button>
                  </div>
                </div>
                
                <!-- Default Prompts Dropdown -->
                <div class="bg-dtgray rounded-xl border border-dtborder p-4">
                  <h3 class="text-sm font-bold text-dtyellow mb-3 flex items-center gap-2">
                    <span>ğŸ“š</span> Default (24)
                  </h3>
                  <select id="default-prompts" class="w-full bg-dtcard border border-dtyellow rounded-lg p-2 text-white text-sm mb-3">
                    <option value="">Select prompt...</option>
                  </select>
                  <button onclick="loadDefaultPrompt()" class="w-full bg-dtyellow hover:bg-yellow-500 text-black px-3 py-2 rounded-lg text-sm font-bold transition-all">
                    ğŸ“– Load
                  </button>
                </div>
                
                <!-- Save Current Button -->
                <button onclick="saveCurrentConfig()" class="w-full bg-dtgreen hover:bg-green-600 text-black px-4 py-3 rounded-xl font-bold transition-all shadow-lg">
                  ğŸ’¾ Save Current Config
                </button>
              </div>
              
              <!-- Preview Panel -->
              <div class="lg:col-span-3 bg-dtgray rounded-xl border border-dtborder p-6">
                <h3 class="text-lg font-bold text-white mb-4">ğŸ“‹ Configuration Preview</h3>
                <div id="config-preview" class="space-y-4">
                  <div class="text-center text-gray-400 py-12">
                    <div class="text-6xl mb-4">ğŸ‘ˆ</div>
                    <div class="text-xl mb-2">Select a Configuration</div>
                    <p class="text-sm">Choose a saved config or default prompt to preview</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="service-dashboard-empty" class="hidden text-center py-12">
            <div class="text-6xl mb-4">ğŸš«</div>
            <div class="text-xl text-gray-400 mb-2">No Services Running</div>
            <p class="text-sm text-gray-500">Start a journey simulation to see services here</p>
          </div>
        </div>
      </div>
    </div>
    
    </section>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Define Dynatrace storage keys FIRST (before any other code)
    window.DT_SETTINGS_KEY = 'bizobs_dt_settings_v1';
    window.DT_ENCRYPTION_KEY = 'bizobs_dt_enc_key';
    console.log('[Init] Storage keys defined:', { 
      DT_SETTINGS_KEY: window.DT_SETTINGS_KEY, 
      DT_ENCRYPTION_KEY: window.DT_ENCRYPTION_KEY 
    });
    
    const ioClient = io();
    const journeyForm = document.getElementById('journey-form');
    const journeyOutput = document.getElementById('journey-output');
    const journeySources = document.getElementById('journey-sources');
    const journeyProvider = document.getElementById('journey-provider');
    const simulateForm = document.getElementById('simulate-form');
    
    console.log('ğŸ” DOM elements found:');
    console.log('- journeyForm:', !!journeyForm);
    console.log('- journeyOutput:', !!journeyOutput, journeyOutput);
    console.log('- journeySources:', !!journeySources);
    console.log('- journeyProvider:', !!journeyProvider);
    console.log('- simulateForm:', !!simulateForm);

    // Helper function for safe element access
    function safeGetElementValue(id, defaultValue = '') {
      const element = document.getElementById(id);
      return element ? (element.value || defaultValue) : defaultValue;
    }
    
    function safeSetElementValue(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.value = value;
        return true;
      }
      console.warn(`Element with id '${id}' not found`);
      return false;
    }

    // Services dropdown functionality
    window.toggleServicesDropdown = function() {
      const dropdown = document.getElementById('services-dropdown');
      const isHidden = dropdown.classList.contains('hidden');
      
      if (isHidden) {
        dropdown.classList.remove('hidden');
        updateServiceStatus(); // Refresh when opening
      } else {
        dropdown.classList.add('hidden');
      }
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('services-dropdown');
      const button = document.getElementById('services-dropdown-btn');
      
      if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.classList.add('hidden');
      }
    });

    let lastJourney = null;
    let currentJourneyData = null;

    // Error simulation state
    let errorSimulationEnabled = true;

    // Tab System Functions
    window.switchTab = function(tabName) {
      console.log('ğŸ”„ Switching to tab:', tabName);
      
      // Remove active class from all tabs and panes
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      
      // Add active class to selected tab and pane
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      const tabPane = document.getElementById(`${tabName}-tab`);
      
      if (tabButton) tabButton.classList.add('active');
      if (tabPane) tabPane.classList.add('active');
      
      // Update progress line
      updateProgressLine(tabName);
      
      // Save current tab state
      localStorage.setItem('bizobs-current-tab', tabName);
    };

    // Progress tracking function
    function updateProgressLine(tabName) {
      const progressLine = document.getElementById('progress-line');
      if (!progressLine) return;
      
      const progressMap = {
        'welcome': '20%',
        'step1': '40%',
        'step2': '60%',
        'step3': '80%',
        'step4': '100%'
      };
      
      progressLine.style.width = progressMap[tabName] || '20%';
      
      // Add completion state for previous tabs
      const tabOrder = ['welcome', 'step1', 'step2', 'step3', 'step4'];
      const currentIndex = tabOrder.indexOf(tabName);
      
      tabOrder.forEach((tab, index) => {
        const button = document.querySelector(`[data-tab="${tab}"]`);
        if (button) {
          if (index < currentIndex) {
            button.classList.add('completed');
          } else {
            button.classList.remove('completed');
          }
        }
      });
    }

    // Add smooth animations for enhanced UI
    function addUIEnhancements() {
      // Add floating animation to cards on hover
      document.querySelectorAll('.shadow-card, .shadow-xl').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
        });
      });
      
      // Add pulse effect to active buttons
      const buttons = document.querySelectorAll('.btn-enhanced');
      buttons.forEach(btn => {
        if (!btn.disabled) {
          btn.addEventListener('mouseenter', function() {
            this.style.animation = 'pulse 2s infinite';
          });
          
          btn.addEventListener('mouseleave', function() {
            this.style.animation = 'none';
          });
        }
      });
    }
    
    // Initialize tab system on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Set up tab click handlers
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // Sync data between tabs
      syncTabData();
      
      // Always start at welcome page on load
      switchTab('welcome');
      
      // Add UI enhancements
      setTimeout(addUIEnhancements, 100);
    });

    // Helper functions for tabs
    window.copyToClipboard = function(elementId) {
      const element = document.getElementById(elementId) || 
                     document.getElementById(elementId + '-step2') || 
                     document.getElementById(elementId + '-step1');
      
      if (element) {
        const textToCopy = element.value || element.textContent;
        
        // Use modern clipboard API
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(textToCopy).then(() => {
            showCopyFeedback();
          }).catch(err => {
            // Fallback to legacy method
            fallbackCopy(element);
          });
        } else {
          // Fallback for older browsers or non-secure contexts
          fallbackCopy(element);
        }
      }
      
      function fallbackCopy(el) {
        try {
          el.select();
          el.setSelectionRange(0, 99999); // For mobile devices
          document.execCommand('copy');
          showCopyFeedback();
        } catch (err) {
          console.error('Copy failed:', err);
          alert('Copy failed. Please manually select and copy the text.');
        }
      }
      
      function showCopyFeedback() {
        const button = event?.target;
        if (button) {
          const originalText = button.textContent;
          button.textContent = 'âœ… Copied!';
          button.classList.add('bg-dtgreen', 'text-black');
          button.classList.remove('bg-dtpurple', 'text-white');
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-dtgreen', 'text-black');
            button.classList.add('bg-dtpurple', 'text-white');
          }, 2000);
        }
      }
    };

    window.loadTestJSON = function() {
      const testJSON = {
        'journey': {
          'companyName': 'TestCorp',
          'domain': 'testcorp.com',
          'steps': [{'stepIndex': 1, 'stepName': 'Test', 'serviceName': 'TestService'}]
        },
        'customerProfile': {'userId': 'test_001'},
        'traceMetadata': {'correlationId': 'test_trace'},
        'additionalFields': {'deviceType': 'Desktop'}
      };
      const responseEl = document.getElementById('copilotResponse-step2') || document.getElementById('copilotResponse');
      if (responseEl) {
        responseEl.value = JSON.stringify(testJSON, null, 2);
      }
    };

    window.processJourneyResponse = function() {
      console.log('ğŸš€ processJourneyResponse called');
      const responseText = (document.getElementById('copilotResponse-step2') || document.getElementById('copilotResponse')).value.trim();
      console.log('Response text length:', responseText.length);
      
      if (!responseText) {
        alert('Please paste your Copilot response first');
        return;
      }

      try {
        const parsedResponse = JSON.parse(responseText);
        if (parsedResponse.journey && parsedResponse.journey.steps) {
          // Sync to original element if it exists
          const originalResponse = document.getElementById('copilotResponse');
          if (originalResponse) originalResponse.value = responseText;

          // ğŸ”§ ARCHITECTURAL IMPROVEMENT: Integrate error simulation into journey data processing
          // Get error simulation toggle state from UI
          const errorToggle = document.getElementById('errorToggle') || document.getElementById('errorToggle-step3');
          const errorSimulationEnabled = errorToggle ? errorToggle.checked : false;
          
          console.log(`ğŸ¯ Error Simulation Architecture: ${errorSimulationEnabled ? 'ENABLED' : 'DISABLED'} - Processing journey steps with error configuration`);
          
          // Process journey steps and add error configuration based on toggle state
          if (errorSimulationEnabled && parsedResponse.journey.steps) {
            // Add error hints to journey steps for transparent error simulation
            parsedResponse.journey.steps = parsedResponse.journey.steps.map((step, index) => {
              // Apply error simulation logic at data processing level
              const shouldHaveError = Math.random() < 0.3; // 30% chance per step
              const errorStep = {
                ...step,
                hasError: shouldHaveError,
                errorHint: shouldHaveError ? 'Simulated error condition for testing purposes' : undefined
              };
              
              console.log(`ğŸ“ Step ${index + 1} (${step.action}): ${shouldHaveError ? 'ğŸ”´ ERROR CONFIGURED' : 'âœ… No Error'}`);
              return errorStep;
            });
            
            console.log('âœ… Error simulation configuration integrated into journey data structure');
          } else {
            // Ensure all steps have explicit "no error" configuration for consistency
            parsedResponse.journey.steps = parsedResponse.journey.steps.map(step => ({
              ...step,
              hasError: false,
              errorHint: undefined
            }));
            
            console.log('âœ… All steps configured with no errors (error simulation disabled)');
          }

          // Set the global variables for journey simulation with complete data including error configuration
          window.lastJourney = {
            ...parsedResponse.journey,
            additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
            customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
            traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
          };
          window.currentJourneyData = parsedResponse;
          console.log('âœ… Global variables set with complete data including error configuration:', {lastJourney: window.lastJourney, currentJourneyData: window.currentJourneyData});

          // Auto-generate feature flags based on journey
          autoGenerateFeatureFlags(parsedResponse);

          // Display journey with additional fields info
          const displayData = {
            journey: parsedResponse.journey,
            customerProfile: parsedResponse.customerProfile,
            traceMetadata: parsedResponse.traceMetadata,
            additionalFields: parsedResponse.additionalFields
          };

          // Update journey output in multiple places
          const journeyOutputElements = [
            document.getElementById('journey-output'),
            document.getElementById('journey-output-step3')
          ];
          
          journeyOutputElements.forEach(el => {
            if (el) {
              el.textContent = JSON.stringify(displayData, null, 2);
              console.log('âœ… Journey output updated for element:', el.id);
            }
          });
          
          // Update provider and sources info
          const journeyProviderEl = document.getElementById('journey-provider');
          if (journeyProviderEl) {
            journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
          }
          
          const journeySourcesEl = document.getElementById('journey-sources');
          if (journeySourcesEl) {
            journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
          }

          // Update step and field counts
          const stepCount = parsedResponse.journey.steps ? parsedResponse.journey.steps.length : 0;
          const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
          
          const stepCountEl = document.getElementById('step-count');
          const fieldCountEl = document.getElementById('field-count');
          
          if (stepCountEl) stepCountEl.textContent = stepCount;
          if (fieldCountEl) fieldCountEl.textContent = fieldsCount;

          // Sync tab data
          syncTabData();

          alert(`Journey processed successfully! Includes ${stepCount} steps and ${fieldsCount} additional tracking fields. Ready for simulation!`);
        } else {
          alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
        }
      } catch (error) {
        console.error('JSON Parse Error:', error);
        alert('Invalid JSON format. Error: ' + error.message);
      }
    };

    // Sync data between original elements and tab elements
    function syncTabData() {
      const syncData = () => {
        // Sync prompts from original to step2 tab
        const prompt1 = document.getElementById('promptText1');
        const prompt2 = document.getElementById('promptText2');
        const prompt1Step2 = document.getElementById('promptText1-step2');
        const prompt2Step2 = document.getElementById('promptText2-step2');
        
        if (prompt1 && prompt1Step2) prompt1Step2.value = prompt1.value;
        if (prompt2 && prompt2Step2) prompt2Step2.value = prompt2.value;
        
        // Also sync to the original hidden elements
        const origPrompt1 = document.querySelector('#promptText1');
        const origPrompt2 = document.querySelector('#promptText2');  
        if (prompt1 && origPrompt1) origPrompt1.value = prompt1.value;
        if (prompt2 && origPrompt2) origPrompt2.value = prompt2.value;
        
        // Sync journey output to step3 tab
        const journeyOutput = document.getElementById('journey-output');
        const journeyOutputStep3 = document.getElementById('journey-output-step3');
        
        if (journeyOutput && journeyOutputStep3 && journeyOutput.textContent.trim()) {
          journeyOutputStep3.textContent = journeyOutput.textContent;
        }
        
        // Sync error toggle states
        const errorToggle = document.getElementById('errorToggle');
        const errorToggleStep3 = document.getElementById('errorToggle-step3');
        
        if (errorToggle && errorToggleStep3) {
          errorToggleStep3.checked = errorToggle.checked;
        }
        
        // Sync simulation results to step5 tab
        const simulationResults = document.getElementById('simulation-results');
        const simulationResultsStep5 = document.getElementById('simulation-results-step5');
        
        if (simulationResults && simulationResultsStep5 && simulationResults.textContent.trim()) {
          simulationResultsStep5.innerHTML = simulationResults.innerHTML;
        }
      };
      
      // Run sync every 1000ms to keep data updated
      setInterval(syncData, 1000);
      syncData(); // Initial sync
    }

    // Step 5 helper functions
    window.updateSimulationStatus = function(message) {
      const statusEl = document.getElementById('simulation-status-step5');
      if (statusEl) statusEl.textContent = message;
    };

    window.clearSimulationResults = function() {
      const resultsEl = document.getElementById('simulation-results-step4');
      if (resultsEl) {
        resultsEl.innerHTML = `
          <div class="text-center text-gray-400 mt-8" style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
            <div class="text-2xl mb-2">ğŸ“Š</div>
            <p style="color: #ffffff;">Simulation results cleared</p>
            <p class="text-xs mt-2" style="color: #cccccc;">Ready for next simulation run</p>
          </div>
        `;
      }
    };

    // Stop ALL services and load runners - complete system reset
    window.stopAllAndClear = async function() {
      if (!confirm('âš ï¸ This will STOP ALL running services and load runners!\n\nAre you sure you want to proceed?')) {
        return;
      }
      
      try {
        const btn = document.getElementById('agent-stop-all-clear-btn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = 'â³ Stopping everything...';
        }
        
        const response = await fetch('/api/admin/stop-all-and-clear', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.ok) {
          console.log('âœ… All services stopped:', result);
          
          // Refresh service status if on that tab
          if (typeof refreshServiceStatus === 'function') {
            setTimeout(refreshServiceStatus, 1000);
          }
          
          // Refresh journey list to update active flags
          if (typeof loadJourneyList === 'function') {
            setTimeout(loadJourneyList, 1500);
          }
          
          alert(`âœ… System Reset Complete!\n\nâ€¢ Load tests stopped: ${result.stoppedTests}\nâ€¢ All services cleared\nâ€¢ System ready for fresh start`);
          
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = 'ğŸ›‘ STOP ALL & CLEAR';
          }
        } else {
          throw new Error(result.error || 'Failed to stop all services');
        }
      } catch (error) {
        console.error('Stop all error:', error);
        alert('âŒ Error stopping services: ' + error.message);
        
        const btn = document.getElementById('agent-stop-all-clear-btn');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ›‘ STOP ALL & CLEAR';
        }
      }
    };

    // Enhanced Copilot Editor Modal
    window.openCopilotEditor = function(textareaId = 'copilotResponse') {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;
      
      // Create modal overlay with improved backdrop
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 p-4';
      overlay.id = 'copilot-editor-overlay';
      overlay.onclick = (e) => { 
        if (e.target === overlay) {
          console.log('ğŸ”˜ Closing editor by clicking overlay');
          closeCopilotEditor();
        }
      };
      
      // Add ESC key support
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          console.log('âŒ¨ï¸ Closing editor with ESC key');
          closeCopilotEditor();
        }
      };
      window.copilotEditorEscHandler = handleEsc;
      document.addEventListener('keydown', handleEsc);
      
      // Create modal content with enhanced styling
      const modal = document.createElement('div');
      modal.className = 'bg-gradient-to-br from-dtcard to-dtgray border-2 border-dtcyan rounded-2xl shadow-2xl w-full max-w-6xl h-5/6 flex flex-col transform animate-fade-in';
      modal.innerHTML = `
        <div class="flex items-center justify-between p-6 border-b-2 border-dtcyan bg-gradient-to-r from-dtcard to-dtgray">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-dtcyan rounded-full animate-pulse"></div>
            <h2 class="text-2xl font-bold text-dtcyan drop-shadow-lg">ğŸ“ Enhanced Copilot Editor</h2>
          </div>
          <div class="flex gap-3">
            <button onclick="formatCopilotJSON()" class="bg-gradient-to-r from-dtblue to-dtpurple hover:from-dtcyan hover:to-dtgreen text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              ğŸ¨ Format JSON
            </button>
            <button onclick="validateCopilotJSON()" class="bg-gradient-to-r from-dtpurple to-dtcyan hover:from-dtgreen hover:to-dtcyan text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              âœ… Validate
            </button>
            <button onclick="closeCopilotEditor()" class="bg-gradient-to-r from-dtgray to-red-500 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              âœ• Close
            </button>
          </div>
        </div>
        <div class="flex-1 p-6 bg-gradient-to-br from-black to-dtgray">
          <textarea id="copilotEditorTextarea" class="w-full h-full p-4 border-2 border-dtcyan rounded-xl bg-black text-white text-sm font-mono resize-none focus:ring-4 focus:ring-dtcyan focus:ring-opacity-50 transition-all shadow-inner" placeholder="Enter or paste your Copilot JSON response here..." style="box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);"></textarea>
        </div>
        <div class="flex items-center justify-between p-6 border-t-2 border-dtcyan bg-gradient-to-r from-dtcard to-dtgray">
          <div id="copilotEditorStatus" class="text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full">Ready to edit</div>
          <div class="flex gap-3">
            <button onclick="saveCopilotEditor()" class="bg-gradient-to-r from-dtgreen to-dtcyan hover:from-dtcyan hover:to-dtgreen text-black font-bold px-8 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
              ğŸ’¾ Save & Close
            </button>
            <button onclick="closeCopilotEditor()" class="bg-gradient-to-r from-dtgray to-dtpurple hover:from-dtpurple hover:to-dtgray text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Copy current content and focus with smooth animation
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      editorTextarea.value = textarea.value;
      setTimeout(() => {
        editorTextarea.focus();
        editorTextarea.setSelectionRange(editorTextarea.value.length, editorTextarea.value.length);
      }, 200);
      
      // Store reference to original textarea
      window.copilotEditorOriginal = textarea;
    };

    window.closeCopilotEditor = function() {
      console.log('ğŸ”„ Attempting to close Copilot editor...');
      
      // Find overlay by ID first, then fallback to class selectors
      let overlay = document.getElementById('copilot-editor-overlay');
      
      if (!overlay) {
        overlay = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-80') || 
                 document.querySelector('.fixed.inset-0.bg-black.bg-opacity-75') ||
                 document.querySelector('[class*="fixed"][class*="inset-0"][class*="bg-black"]');
      }
      
      if (overlay) {
        // Add fade out animation before removal
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.2s ease-out';
        
        setTimeout(() => {
          try {
            overlay.remove();
            console.log('âœ… Copilot editor closed successfully');
          } catch (e) {
            console.warn('âš ï¸ Error removing overlay:', e);
          }
        }, 200);
      } else {
        console.warn('âš ï¸ Could not find overlay to close');
      }
      
      // Clean up
      window.copilotEditorOriginal = null;
      
      // Remove any ESC key listeners
      document.removeEventListener('keydown', window.copilotEditorEscHandler);
    };

    window.saveCopilotEditor = function() {
      console.log('ğŸ’¾ Saving Copilot editor content...');
      
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const originalTextarea = window.copilotEditorOriginal;
      
      if (editorTextarea && originalTextarea) {
        const content = editorTextarea.value;
        originalTextarea.value = content;
        
        // Trigger change events to update UI
        originalTextarea.dispatchEvent(new Event('change', { bubbles: true }));
        originalTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        
        console.log('âœ… Content saved successfully:', content.substring(0, 100) + '...');
      } else {
        console.warn('âš ï¸ Could not save - missing textarea references');
        console.log('Editor textarea:', !!editorTextarea);
        console.log('Original textarea:', !!originalTextarea);
      }
      
      closeCopilotEditor();
    };

    window.formatCopilotJSON = function() {
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const statusEl = document.getElementById('copilotEditorStatus');
      
      try {
        const parsed = JSON.parse(editorTextarea.value);
        editorTextarea.value = JSON.stringify(parsed, null, 2);
        statusEl.textContent = 'âœ… JSON formatted successfully';
        statusEl.className = 'text-sm text-dtgreen font-medium bg-green-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtgreen animate-pulse';
        setTimeout(() => {
          statusEl.className = 'text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full';
          statusEl.textContent = 'Ready to edit';
        }, 3000);
      } catch (e) {
        statusEl.textContent = 'âŒ Invalid JSON: ' + e.message.substring(0, 50) + '...';
        statusEl.className = 'text-sm text-red-400 font-medium bg-red-900 bg-opacity-30 px-3 py-1 rounded-full border border-red-400 animate-pulse';
      }
    };

    window.validateCopilotJSON = function() {
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const statusEl = document.getElementById('copilotEditorStatus');
      
      try {
        const parsed = JSON.parse(editorTextarea.value);
        const hasJourney = parsed.journey || parsed.aiJourney;
        const hasSteps = hasJourney && hasJourney.steps && Array.isArray(hasJourney.steps);
        
        const hasCompany = parsed.company && parsed.company.name;
        
        if (hasSteps && hasCompany) {
          statusEl.textContent = `âœ… Perfect! ${parsed.company.name} journey with ${hasJourney.steps.length} steps`;
          statusEl.className = 'text-sm text-dtgreen font-medium bg-green-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtgreen animate-pulse';
        } else if (hasSteps) {
          statusEl.textContent = `âš ï¸ Valid journey (${hasJourney.steps.length} steps) but missing company info`;
          statusEl.className = 'text-sm text-dtyellow font-medium bg-yellow-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtyellow';
        } else {
          statusEl.textContent = 'âš ï¸ Valid JSON but missing journey structure';
          statusEl.className = 'text-sm text-dtyellow font-medium bg-yellow-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtyellow';
        }
        
        setTimeout(() => {
          if (statusEl.textContent.includes('Perfect!')) {
            statusEl.className = 'text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full';
            statusEl.textContent = 'Ready to edit';
          }
        }, 4000);
      } catch (e) {
        statusEl.textContent = 'âŒ Invalid JSON: ' + e.message.substring(0, 50) + '...';
        statusEl.className = 'text-sm text-red-400 font-medium bg-red-900 bg-opacity-30 px-3 py-1 rounded-full border border-red-400 animate-pulse';
      }
    };



    window.exportSimulationResults = function() {
      const resultsEl = document.getElementById('simulation-results-step4');
      if (resultsEl && resultsEl.textContent.trim()) {
        const data = resultsEl.textContent;
        const blob = new Blob([data], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bizobs-simulation-results-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else {
        alert('No simulation results to export. Please run a simulation first.');
      }
    };

    // Missing validation and UI functions
    window.validateAndProceed = function() {
      const companyName = safeGetElementValue('companyName').trim();
      const domain = safeGetElementValue('domain').trim();
      const journeyRequirements = safeGetElementValue('journeyRequirements').trim();
      
      if (!companyName) {
        alert('Please enter a company name');
        return;
      }
      if (!domain) {
        alert('Please enter a website domain');  
        return;
      }
      if (!journeyRequirements) {
        alert('Please describe your journey requirements');  
        return;
      }
      
      // Generate prompts and advance to step 2
      generateCopilotPrompt();
      setTimeout(() => switchTab('step2'), 500);
    };

    window.showDataMode = function(mode) {
      // Remove active class from all mode buttons
      document.querySelectorAll('.data-mode-btn').forEach(btn => btn.classList.remove('active'));
      
      // Hide all mode content
      document.querySelectorAll('.data-mode-content').forEach(content => content.style.display = 'none');
      
      // Show selected mode
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      document.getElementById(`${mode}-mode`).style.display = 'block';
    };

    window.checkResponseInput = function() {
      const responseText = document.getElementById('copilotResponse-step2').value.trim();
      const processBtn = document.getElementById('processJourneyResponse');
      
      console.log('checkResponseInput called, text length:', responseText.length);
      console.log('Process button found:', !!processBtn);
      
      if (processBtn) {
        if (responseText.length > 0) {
          processBtn.disabled = false;
          processBtn.classList.remove('opacity-50');
          console.log('âœ… Button enabled');
        } else {
          processBtn.disabled = true;
          processBtn.classList.add('opacity-50');
          console.log('âŒ Button disabled');
        }
      }
    };

    // Add additional event listeners for better responsiveness
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('copilotResponse-step2');
      if (textarea) {
        // Add multiple event listeners to catch all input changes
        textarea.addEventListener('input', checkResponseInput);
        textarea.addEventListener('paste', function() {
          setTimeout(checkResponseInput, 100); // Small delay to let paste complete
        });
        textarea.addEventListener('keyup', checkResponseInput);
      }
    });

    window.validateProcessing = function() {
      const journeyOutput = document.getElementById('journey-output-step3');
      if (journeyOutput && journeyOutput.textContent.trim()) {
        alert('âœ… Journey data validated successfully!');
      } else {
        alert('âš ï¸ No journey data found. Please complete Step 2 first.');
      }
    };

    // Console logging for debugging
    console.log('BizObs App initializing...');

    // Error Simulation Toggle Functionality
    // Feature Flag Management - AUTO-GENERATION
    let activeFeatureFlags = {};
    
    // Auto-generate feature flags based on journey steps
    function autoGenerateFeatureFlags(journeyData) {
      console.log('ğŸ¤– Auto-generating feature flags from journey...');
      
      const steps = journeyData.steps || [];
      const industryType = journeyData.industryType || '';
      const journeyType = journeyData.journeyType || '';
      
      // Analyze steps to detect patterns
      const stepNames = steps.map(s => (s.stepName || s.name || '').toLowerCase());
      const allStepText = stepNames.join(' ');
      
      const possibleFlags = [];
      
      // Payment/Financial patterns
      if (allStepText.includes('payment') || allStepText.includes('checkout') || allStepText.includes('transaction')) {
        possibleFlags.push({
          name: 'Payment Gateway Timeout',
          errorType: 'timeout',
          errorRate: Math.floor(Math.random() * 10) + 10, // 10-20%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/payment|checkout|transaction|billing/)
          ).map(s => s.stepName || s.name),
          severity: 'CRITICAL',
          remediation: 'restart_payment_gateway'
        });
      }
      
      // Inventory/Fulfillment patterns
      if (allStepText.includes('inventory') || allStepText.includes('fulfil') || allStepText.includes('stock') || allStepText.includes('order')) {
        possibleFlags.push({
          name: 'Inventory Sync Failure',
          errorType: 'service_unavailable',
          errorRate: Math.floor(Math.random() * 8) + 5, // 5-13%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/inventory|fulfil|stock|order/)
          ).map(s => s.stepName || s.name),
          severity: 'WARNING',
          remediation: 'trigger_inventory_sync'
        });
      }
      
      // Validation/Verification patterns
      if (allStepText.includes('verif') || allStepText.includes('valid') || allStepText.includes('check') || allStepText.includes('customer')) {
        possibleFlags.push({
          name: 'Validation Timeout',
          errorType: 'validation_failed',
          errorRate: Math.floor(Math.random() * 5) + 3, // 3-8%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/verif|valid|check|customer|account/)
          ).map(s => s.stepName || s.name),
          severity: 'LOW',
          remediation: 'retry_with_defaults'
        });
      }
      
      // Manufacturing patterns
      if (allStepText.includes('weld') || allStepText.includes('assembl') || allStepText.includes('machine') || allStepText.includes('robot')) {
        possibleFlags.push({
          name: 'Robot Malfunction',
          errorType: 'internal_error',
          errorRate: Math.floor(Math.random() * 12) + 8, // 8-20%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/weld|assembl|machine|robot|fabricat/)
          ).map(s => s.stepName || s.name),
          severity: 'CRITICAL',
          remediation: 'restart_robot_controller'
        });
      }
      
      // Quality/Testing patterns
      if (allStepText.includes('quality') || allStepText.includes('inspect') || allStepText.includes('test')) {
        possibleFlags.push({
          name: 'Quality Check Delay',
          errorType: 'timeout',
          errorRate: Math.floor(Math.random() * 6) + 4, // 4-10%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/quality|inspect|test|check/)
          ).map(s => s.stepName || s.name),
          severity: 'WARNING',
          remediation: 'escalate_to_manual_review'
        });
      }
      
      // Banking/KYC patterns
      if (allStepText.includes('kyc') || allStepText.includes('credit') || allStepText.includes('compliance') || allStepText.includes('document')) {
        possibleFlags.push({
          name: 'KYC Verification Failed',
          errorType: 'authentication_failed',
          errorRate: Math.floor(Math.random() * 7) + 5, // 5-12%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/kyc|credit|compliance|document|identit/)
          ).map(s => s.stepName || s.name),
          severity: 'CRITICAL',
          remediation: 'manual_verification'
        });
      }
      
      // Delivery/Logistics patterns
      if (allStepText.includes('deliver') || allStepText.includes('ship') || allStepText.includes('dispatch')) {
        possibleFlags.push({
          name: 'Delivery Tracking Offline',
          errorType: 'service_unavailable',
          errorRate: Math.floor(Math.random() * 8) + 4, // 4-12%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/deliver|ship|dispatch|track/)
          ).map(s => s.stepName || s.name),
          severity: 'WARNING',
          remediation: 'switch_to_backup_tracker'
        });
      }
      
      // Healthcare patterns
      if (allStepText.includes('appointment') || allStepText.includes('lab') || allStepText.includes('prescription')) {
        possibleFlags.push({
          name: 'Lab System Timeout',
          errorType: 'timeout',
          errorRate: Math.floor(Math.random() * 10) + 5, // 5-15%
          affectedSteps: steps.filter(s => 
            (s.stepName || s.name || '').toLowerCase().match(/lab|test|result|appointment/)
          ).map(s => s.stepName || s.name),
          severity: 'WARNING',
          remediation: 'notify_lab_technician'
        });
      }
      
      // Filter out flags with no affected steps
      const validFlags = possibleFlags.filter(f => f.affectedSteps && f.affectedSteps.length > 0);
      
      if (validFlags.length === 0) {
        console.log('âš ï¸ No specific patterns detected, creating generic flags...');
        // Create 1-2 generic flags for any journey
        validFlags.push({
          name: 'Service Timeout',
          errorType: 'timeout',
          errorRate: Math.floor(Math.random() * 10) + 10,
          affectedSteps: steps.slice(0, Math.ceil(steps.length / 2)).map(s => s.stepName || s.name),
          severity: 'WARNING',
          remediation: 'restart_service'
        });
      }
      
      // Randomly enable 1-3 flags (not all)
      const numToEnable = Math.min(validFlags.length, Math.floor(Math.random() * 3) + 1);
      const shuffled = validFlags.sort(() => 0.5 - Math.random());
      const selectedFlags = shuffled.slice(0, numToEnable);
      
      // Clear existing flags and add new ones
      activeFeatureFlags = {};
      
      selectedFlags.forEach(flag => {
        const flagId = flag.name.toLowerCase().replace(/\s+/g, '_');
        activeFeatureFlags[flagId] = {
          ...flag,
          enabled: true
        };
        console.log(`âœ… Auto-created flag: ${flag.name} (${flag.errorRate}% error rate) â†’ ${flag.affectedSteps.join(', ')}`);
      });
      
      saveFeatureFlags();
      updateFeatureFlagCount();
      
      console.log(`ğŸ¯ Auto-generated ${selectedFlags.length} feature flags based on journey`);
      
      return selectedFlags.length;
    }
    
    function openFeatureFlagsModal() {
      const modal = document.getElementById('feature-flags-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        renderFeatureFlags();
      }
    }
    
    function closeFeatureFlagsModal(event) {
      if (event && event.target.id !== 'feature-flags-modal') return;
      const modal = document.getElementById('feature-flags-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    }
    
    function toggleTemplates() {
      const content = document.getElementById('templates-content');
      const arrow = document.getElementById('templates-arrow');
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.textContent = 'â–²';
      } else {
        content.classList.add('hidden');
        arrow.textContent = 'â–¼';
      }
    }
    
    function applyTemplate(type) {
      const templates = {
        timeout: {
          name: 'Service Timeout',
          errorType: 'timeout',
          errorRate: 15,
          affectedSteps: 'Payment,Checkout,Processing',
          severity: 'CRITICAL',
          remediation: 'restart_service'
        },
        unavailable: {
          name: 'Service Unavailable',
          errorType: 'service_unavailable',
          errorRate: 10,
          affectedSteps: 'Fulfillment,Inventory,Sync',
          severity: 'WARNING',
          remediation: 'trigger_sync'
        },
        validation: {
          name: 'Validation Error',
          errorType: 'validation_failed',
          errorRate: 5,
          affectedSteps: 'Verification,Validation,Input',
          severity: 'LOW',
          remediation: 'retry_with_defaults'
        },
        rate_limit: {
          name: 'Rate Limit Exceeded',
          errorType: 'rate_limit_exceeded',
          errorRate: 8,
          affectedSteps: 'API,Gateway,External',
          severity: 'WARNING',
          remediation: 'enable_circuit_breaker'
        }
      };
      
      const template = templates[type];
      if (template) {
        addNewFeatureFlag(template);
      }
    }
    
    function addNewFeatureFlag(template = null) {
      const flagId = template ? template.name.toLowerCase().replace(/\s+/g, '_') : `flag_${Date.now()}`;
      
      const flagName = template?.name || prompt('Enter feature flag name (e.g., "Robot Malfunction", "Assembly Line Jam"):', '');
      if (!flagName) return;
      
      const errorType = template?.errorType || prompt('Error type (timeout, service_unavailable, validation_failed, internal_error):', 'timeout');
      const errorRate = template?.errorRate || parseInt(prompt('Error rate % (1-100):', '10'));
      const affectedSteps = template?.affectedSteps || prompt('Affected step names (comma-separated, e.g., "Welding,Assembly,QualityCheck"):', '');
      const severity = template?.severity || prompt('Severity (CRITICAL, WARNING, LOW):', 'WARNING');
      const remediation = template?.remediation || prompt('Remediation action (e.g., "restart_robot", "clear_jam"):', 'manual_intervention');
      
      if (!affectedSteps) {
        alert('Please specify at least one affected step!');
        return;
      }
      
      const steps = affectedSteps.split(',').map(s => s.trim());
      
      activeFeatureFlags[flagId] = {
        name: flagName,
        enabled: true,
        errorRate: errorRate / 100,
        errorType: errorType,
        affectedSteps: steps,
        severity: severity,
        remediationAction: remediation
      };
      
      saveFeatureFlags();
      renderFeatureFlags();
      updateFeatureFlagCount();
      
      console.log(`ğŸš¦ Feature flag CREATED: ${flagName} (${errorRate}% error rate)`);
    }
    
    function deleteFeatureFlag(flagId) {
      if (!confirm(`Delete feature flag "${activeFeatureFlags[flagId]?.name}"?`)) return;
      
      delete activeFeatureFlags[flagId];
      saveFeatureFlags();
      renderFeatureFlags();
      updateFeatureFlagCount();
      
      console.log(`ğŸ—‘ï¸ Feature flag DELETED: ${flagId}`);
    }
    
    function toggleFeatureFlag(flagId, enabled) {
      if (activeFeatureFlags[flagId]) {
        activeFeatureFlags[flagId].enabled = enabled;
        saveFeatureFlags();
        updateFeatureFlagCount();
        console.log(`ğŸš¦ Feature flag ${enabled ? 'ENABLED' : 'DISABLED'}: ${flagId}`);
      }
    }
    
    function renderFeatureFlags() {
      const container = document.getElementById('feature-flags-container');
      if (!container) return;
      
      const flags = Object.entries(activeFeatureFlags);
      
      if (flags.length === 0) {
        container.innerHTML = `
          <div class="p-8 text-center text-gray-400">
            <p class="text-lg mb-2">No feature flags configured</p>
            <p class="text-sm">Click "Add Custom Feature Flag" above to create your first flag</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = flags.map(([flagId, flag]) => {
        const severityColors = {
          CRITICAL: 'bg-red-600',
          WARNING: 'bg-yellow-600',
          LOW: 'bg-blue-600'
        };
        const toggleColor = {
          CRITICAL: 'peer-checked:bg-red-600',
          WARNING: 'peer-checked:bg-yellow-600',
          LOW: 'peer-checked:bg-blue-600'
        };
        
        return `
          <div class="p-4 bg-dtgray rounded-lg border border-dtborder">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-white font-semibold">${flag.name}</span>
                  <span class="px-2 py-0.5 rounded ${severityColors[flag.severity] || 'bg-gray-600'} text-white text-xs font-bold">${flag.severity}</span>
                </div>
                <p class="text-xs text-gray-400">Error: ${flag.errorType} | Rate: ${(flag.errorRate * 100).toFixed(0)}%</p>
              </div>
              <div class="flex items-center gap-2">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" ${flag.enabled ? 'checked' : ''} onchange="toggleFeatureFlag('${flagId}', this.checked)" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-dtcyan rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all ${toggleColor[flag.severity] || 'peer-checked:bg-dtcyan'}"></div>
                </label>
                <button onclick="deleteFeatureFlag('${flagId}')" class="text-red-500 hover:text-red-400 text-xl" title="Delete flag">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
              <div>
                <span class="text-gray-400">Affected Steps:</span>
                <span class="text-white ml-1">${flag.affectedSteps.join(', ')}</span>
              </div>
              <div>
                <span class="text-gray-400">Remediation:</span>
                <span class="text-dtgreen ml-1">${flag.remediationAction}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function clearAllFeatureFlags() {
      if (!confirm('Clear all active feature flags?')) return;
      
      activeFeatureFlags = {};
      saveFeatureFlags();
      renderFeatureFlags();
      updateFeatureFlagCount();
      console.log('ğŸ§¹ All feature flags cleared');
    }
    
    function saveFeatureFlags() {
      localStorage.setItem('bizobs-feature-flags', JSON.stringify(activeFeatureFlags));
    }
    
    function loadFeatureFlags() {
      const saved = localStorage.getItem('bizobs-feature-flags');
      if (saved) {
        try {
          activeFeatureFlags = JSON.parse(saved);
          updateFeatureFlagCount();
          console.log('âœ… Restored feature flags:', Object.keys(activeFeatureFlags));
        } catch (e) {
          console.warn('âš ï¸ Could not restore feature flags:', e);
        }
      }
    }
    
    function regenerateFeatureFlags() {
      if (!window.currentJourneyData) {
        alert('No journey loaded. Please generate a journey first.');
        return;
      }
      
      const confirmed = confirm('This will replace all current feature flags with new auto-generated ones. Continue?');
      if (!confirmed) return;
      
      autoGenerateFeatureFlags(window.currentJourneyData);
      renderFeatureFlags();
      alert('âœ… Feature flags regenerated based on your journey!');
    }
    
    function updateFeatureFlagCount() {
      const enabledCount = Object.values(activeFeatureFlags).filter(f => f.enabled).length;
      
      // Update badge in menu bar
      const badge = document.getElementById('feature-flags-badge');
      if (badge) {
        badge.textContent = enabledCount;
        if (enabledCount > 0) {
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
      
      // Update count in modal
      const modalCount = document.getElementById('modal-active-flags-count');
      if (modalCount) {
        modalCount.textContent = enabledCount;
        modalCount.className = enabledCount > 0 ? 'text-dtgreen font-bold ml-2' : 'text-gray-400 ml-2';
      }
    }
    
    function initializeFeatureFlags() {
      loadFeatureFlags();
      console.log('âœ… Feature flag system initialized');
    }
    
    function viewFeatureFlagDocs(event) {
      event.preventDefault();
      openFeatureFlagsModal();
    }
    
    // Make feature flags available globally for data generation
    window.getActiveFeatureFlags = function() {
      return activeFeatureFlags;
    };

    // Initialize feature flags when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeFeatureFlags);
    if (document.readyState !== 'loading') {
      initializeFeatureFlags();
    }

    // Prompt Cache Management
    class PromptCache {
      constructor() {
        console.log('PromptCache constructor called');
        this.storageKey = 'bizobs-saved-prompts';
        console.log('Calling initializeSidebar...');
        this.initializeSidebar();
        console.log('Calling loadSavedPrompts...');
        this.loadSavedPrompts();
        console.log('PromptCache constructor completed');
      }

      initializeSidebar() {
        console.log('initializeSidebar method called');
        const toggleBtn = document.getElementById('toggleSidebar');
        const closeBtn = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        const saveBtn = document.getElementById('saveCurrentPrompt');
        const quickSaveBtn = document.getElementById('quickSavePrompt');
        const clearBtn = document.getElementById('clearAllPrompts');
        const exportBtn = document.getElementById('exportPrompts');
        const importBtn = document.getElementById('importPrompts');

        console.log('Element check:');
        console.log('- toggleBtn:', !!toggleBtn);
        console.log('- closeBtn:', !!closeBtn);
        console.log('- sidebar:', !!sidebar);
        console.log('- mainContent:', !!mainContent);

        if (toggleBtn) {
          console.log('Toggle button found, adding event listener...');
          toggleBtn.addEventListener('click', () => {
            console.log('Toggle button clicked!');
            this.toggleSidebar();
          });
        } else {
          console.error('Toggle button NOT found!');
        }
        
        if (closeBtn) {
          console.log('Close button found, adding event listener...');
          closeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Close button clicked!');
            this.closeSidebar();
          });
        } else {
          console.error('Close button NOT found!');
        }
        if (saveBtn) {
          console.log('âœ… Save button found, adding event listener');
          saveBtn.addEventListener('click', () => {
            console.log('ğŸ’¾ Save button clicked!');
            console.log('Current form data:', {
              companyName: document.getElementById('companyName')?.value,
              domain: document.getElementById('domain')?.value,
              promptText1: document.getElementById('promptText1-step2')?.value?.substring(0, 100) + '...',
              promptText2: document.getElementById('promptText2-step2')?.value?.substring(0, 100) + '...'
            });
            this.saveCurrentPrompt();
          });
        } else {
          console.error('âŒ Save button NOT found!');
        }
        if (quickSaveBtn) quickSaveBtn.addEventListener('click', () => this.quickSavePrompt());
        if (clearBtn) clearBtn.addEventListener('click', () => this.clearAllPrompts());
        if (exportBtn) exportBtn.addEventListener('click', () => this.exportPrompts());
        if (importBtn) importBtn.addEventListener('click', () => this.importPrompts());

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
          if (sidebar && toggleBtn && !sidebar.contains(e.target) && !toggleBtn.contains(e.target) && sidebar.classList.contains('translate-x-0')) {
            this.closeSidebar();
          }
        });

        // Update counter on page load
        this.updatePromptsCounter();

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ctrl+S or Cmd+S for quick save
          if ((e.ctrlKey || e.metaKey) && e.key === 's' && !e.shiftKey) {
            e.preventDefault();
            this.quickSavePrompt();
          }
          // Ctrl+Shift+S for named save
          if ((e.ctrlKey || e.metaKey) && e.key === 'S' && e.shiftKey) {
            e.preventDefault();
            this.toggleSidebar();
            setTimeout(() => {
              document.getElementById('savePromptName').focus();
            }, 300);
          }
          // Escape to close sidebar
          if (e.key === 'Escape') {
            this.closeSidebar();
          }
        });
      }

      async toggleSidebar() {
        console.log('toggleSidebar method called');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        console.log('Sidebar element:', sidebar);
        console.log('Main content element:', mainContent);
        
        if (!sidebar) {
          console.error('Sidebar element not found!');
          return;
        }
        
        const isOpen = sidebar.classList.contains('translate-x-0');
        console.log('Sidebar is currently open:', isOpen);
        
        if (isOpen) {
          console.log('Closing sidebar...');
          this.closeSidebar();
        } else {
          console.log('Opening sidebar...');
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
          if (mainContent) mainContent.classList.add('sidebar-open');
          
          // Refresh the saved prompts list when opening sidebar
          await this.renderSavedPrompts();
        }
      }

      closeSidebar() {
        console.log('ğŸ”’ closeSidebar method called');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        
        if (!sidebar) {
          console.error('âŒ Sidebar element not found in closeSidebar!');
          return;
        }
        
        console.log('ğŸ”„ Closing sidebar - removing translate-x-0, adding -translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebar.classList.add('-translate-x-full');
        if (mainContent) {
          mainContent.classList.remove('sidebar-open');
          console.log('âœ… Main content updated');
        }
        console.log('âœ… Sidebar closed successfully');
      }

      getCurrentPromptState() {
        const getElementValue = (id, defaultValue = '') => {
          const element = document.getElementById(id);
          return element ? element.value : defaultValue;
        };
        
        const getCheckboxValue = (id, defaultValue = false) => {
          const element = document.getElementById(id);
          return element ? element.checked : defaultValue;
        };
        
        return {
          timestamp: new Date().toISOString(),
          formData: {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: 'determined-by-ai',
            journeyRequirements: getElementValue('journeyRequirements'),
            customSteps: getElementValue('customSteps'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            generationMethod: getElementValue('generationMethod', 'copilot'),
            customerCount: getElementValue('customerCount', '1')
          },
          // ğŸ”§ COMPREHENSIVE FIELD CAPTURE: Save ALL input fields across all steps
          step1Fields: {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: getElementValue('industryType'),
            journeyRequirements: getElementValue('journeyRequirements'),
            customSteps: getElementValue('customSteps'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            generationMethod: getElementValue('generationMethod', 'copilot')
          },
          step2Fields: {
            promptText1: getElementValue('promptText1'),
            promptText2: getElementValue('promptText2'),
            promptText1Step2: getElementValue('promptText1-step2'),
            promptText2Step2: getElementValue('promptText2-step2'),
            copilotResponse: getElementValue('copilotResponse'),
            copilotResponseStep2: getElementValue('copilotResponse-step2')
          },
          step3Fields: {
            journeyOutput: getElementValue('journey-output') || document.getElementById('journey-output')?.textContent || '',
            journeyOutputStep3: getElementValue('journey-output-step3') || document.getElementById('journey-output-step3')?.textContent || '',
            errorToggle: getCheckboxValue('errorToggle'),
            errorToggleStep3: getCheckboxValue('errorToggle-step3')
          },
          step4Fields: {
            customerCount: getElementValue('customerCount', '1'),
            thinkTimeMs: getElementValue('thinkTimeMs', '1000'),
            executionType: getElementValue('executionType', 'chained')
          },
          step5Fields: {
            simulationResults: document.getElementById('simulation-results')?.innerHTML || '',
            simulationResultsStep5: document.getElementById('simulation-results-step5')?.innerHTML || ''
          },
          // Legacy fields for backward compatibility
          additionalFields: typeof additionalFields !== 'undefined' ? [...additionalFields] : [],
          generatedPrompt: getElementValue('promptText'),
          promptText1: getElementValue('promptText1-step2'),
          promptText2: getElementValue('promptText2-step2'),
          copilotResponse: getElementValue('copilotResponse-step2'),
          lastJourney: typeof window.lastJourney !== 'undefined' && window.lastJourney ? { ...window.lastJourney } : null,
          currentJourneyData: typeof window.currentJourneyData !== 'undefined' && window.currentJourneyData ? { ...window.currentJourneyData } : null
        };
      }

      async saveCurrentPrompt() {
        const nameInput = document.getElementById('savePromptName');
        const saveBtn = document.getElementById('saveCurrentPrompt');
        const saveStatus = document.getElementById('saveStatus');
        
        let name = nameInput ? nameInput.value.trim() : '';
        
        // If no name provided, generate one based on company and journey type
        if (!name) {
          const companyName = document.getElementById('companyName')?.value.trim() || 'Unknown';
          const journeyType = document.getElementById('journeyType')?.value.trim();
          const industryType = document.getElementById('industryType')?.value.trim();
          
          // Create a descriptive name
          if (journeyType) {
            name = `${companyName} - ${journeyType}`;
          } else if (industryType) {
            name = `${companyName} - ${industryType} Journey`;
          } else {
            name = `${companyName} - Unnamed Journey`;
          }
        }

        try {
          // Show saving status
          if (saveStatus) {
            saveStatus.classList.remove('hidden');
            saveStatus.innerHTML = '<span class="text-dtcyan">ğŸ’¾ Saving...</span>';
          }
          
          // Disable button during save
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'ğŸ’¾ Saving...';
            saveBtn.classList.add('opacity-75');
          }

          const promptState = this.getCurrentPromptState();
          promptState.name = name;
          promptState.id = Date.now().toString();

          const savedPrompts = this.getSavedPrompts();
          savedPrompts.push(promptState);
          
          localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));
          
          // Only clear input after successful save
          if (nameInput) nameInput.value = '';
          
          await this.renderSavedPrompts();
          this.updatePromptsCounter();
          
          // Show success message
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-75');
            saveBtn.textContent = 'âœ… Saved!';
            saveBtn.style.background = '#10b981';
            
            setTimeout(() => {
              saveBtn.textContent = 'ğŸ’¾ Save Current State';
              saveBtn.style.background = '';
            }, 2000);
          }
          
          if (saveStatus) {
            saveStatus.innerHTML = '<span class="text-dtgreen">âœ… Saved successfully</span>';
            setTimeout(() => saveStatus.classList.add('hidden'), 3000);
          }

          this.showNotification(`Saved "${name}" successfully!`);
          
        } catch (error) {
          console.error('Error saving prompt:', error);
          
          // Re-enable button and show error
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-75');
            saveBtn.textContent = 'âŒ Save Failed';
            saveBtn.style.background = '#ef4444';
            
            setTimeout(() => {
              saveBtn.textContent = 'ğŸ’¾ Save Current State';
              saveBtn.style.background = '';
            }, 3000);
          }
          
          if (saveStatus) {
            saveStatus.innerHTML = '<span class="text-red-400">âŒ Save failed</span>';
          }
          
          this.showNotification(`Failed to save "${name}": ${error.message}`, 'error');
        }
      }

      getSavedPrompts() {
        try {
          return JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        } catch (error) {
          console.error('Error loading saved prompts:', error);
          return [];
        }
      }

      async loadSavedPrompts() {
        console.log('ğŸ”„ Loading saved prompts from both server and localStorage...');
        
        // Load from server first, then merge with localStorage
        let serverPrompts = [];
        let localPrompts = [];
        
        // Try to load from server
        try {
          const serverResponse = await fetch('/api/admin/configs');
          if (serverResponse.ok) {
            const serverData = await serverResponse.json();
            if (serverData.ok && serverData.configs) {
              // Get full config data for each server config
              for (const configMeta of serverData.configs) {
                try {
                  const configResponse = await fetch(`/api/admin/configs/${configMeta.id}`);
                  if (configResponse.ok) {
                    const configData = await configResponse.json();
                    if (configData.ok) {
                      configData.config.source = 'server';
                      serverPrompts.push(configData.config);
                    }
                  }
                } catch (error) {
                  console.warn(`âš ï¸ Error loading config ${configMeta.id}:`, error);
                }
              }
              console.log(`ğŸ“¡ Loaded ${serverPrompts.length} configurations from server`);
            }
          }
        } catch (error) {
          console.log('ğŸ“¡ Server load failed, using localStorage only:', error.message);
        }
        
        // Load from localStorage as backup/additional source
        const storageKey = 'bizobs-saved-prompts';
        localPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
        localPrompts.forEach(p => {
          if (!p.source) p.source = 'local';
        });
        console.log(`ğŸ’¾ Loaded ${localPrompts.length} configurations from localStorage`);
        
        // Merge and deduplicate (server takes priority over localStorage for same IDs)
        const allPrompts = [...serverPrompts];
        localPrompts.forEach(localPrompt => {
          const existsOnServer = serverPrompts.some(serverPrompt => serverPrompt.id === localPrompt.id);
          if (!existsOnServer) {
            allPrompts.push(localPrompt);
          }
        });
        
        console.log(`ğŸ¯ Total configurations available: ${allPrompts.length} (${serverPrompts.length} from server, ${localPrompts.length} from localStorage)`);
        
        this.renderSavedPrompts();
        this.updatePromptsCounter();
      }

      quickSavePrompt() {
        const companyName = document.getElementById('companyName').value.trim();
        const domain = document.getElementById('domain').value.trim();
        
        // Generate an automatic name based on form content
        const autoName = companyName 
          ? `${companyName} - ${domain || 'General'} (${new Date().toLocaleDateString()})`
          : `Quick Save - ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

        const promptState = this.getCurrentPromptState();
        promptState.name = autoName;
        promptState.id = Date.now().toString();
        promptState.isQuickSave = true;

        const savedPrompts = this.getSavedPrompts();
        savedPrompts.push(promptState);
        localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));

        this.renderSavedPrompts();
        this.updatePromptsCounter();

        // Show success animation - fix undefined btn variable
        const quickSaveBtn = document.getElementById('quickSavePrompt');
        if (quickSaveBtn) {
          const originalText = quickSaveBtn.textContent;
          quickSaveBtn.textContent = 'âœ… Saved!';
          quickSaveBtn.classList.add('bg-green-600');
          quickSaveBtn.classList.remove('bg-dtpurple');
          setTimeout(() => {
            quickSaveBtn.textContent = originalText;
            quickSaveBtn.classList.remove('bg-green-600');
            quickSaveBtn.classList.add('bg-dtpurple');
            quickSaveBtn.disabled = false;
          }, 1200);
        }

        this.showNotification(`Quick saved "${autoName}"!`);
      }

      updatePromptsCounter() {
        const count = this.getSavedPrompts().length;
        const counter = document.getElementById('savedPromptsCount');
        if (counter) {
          counter.textContent = `ğŸ“‹ ${count} saved prompt${count !== 1 ? 's' : ''}`;
        }
      }

      showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        const content = document.getElementById('notificationContent');
        
        if (!toast || !content) {
          console.warn('âš ï¸ Notification elements not found');
          return;
        }
        
        const icons = {
          success: 'âœ…',
          error: 'âŒ',
          info: 'â„¹ï¸',
          warning: 'âš ï¸'
        };
        
        content.innerHTML = `${icons[type]} ${message}`;
        toast.classList.remove('translate-x-full');
        
        setTimeout(() => {
          toast.classList.add('translate-x-full');
        }, 3000);
      }

      loadPromptState(promptState) {
        console.log('ğŸ”„ Loading comprehensive prompt state:', promptState);
        
        const setElementValue = (id, value, defaultValue = '') => {
          const element = document.getElementById(id);
          if (element) {
            element.value = value || defaultValue;
            console.log(`âœ… Restored ${id}: ${(value || '').substring(0, 100)}${value && value.length > 100 ? '...' : ''}`);
          } else {
            console.warn(`âš ï¸ Element ${id} not found when loading prompt state`);
          }
        };
        
        const setElementContent = (id, content) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = content;
            console.log(`âœ… Restored content for ${id}`);
          } else {
            console.warn(`âš ï¸ Element ${id} not found when loading content`);
          }
        };
        
        const setElementHTML = (id, html) => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = html;
            console.log(`âœ… Restored HTML for ${id}`);
          } else {
            console.warn(`âš ï¸ Element ${id} not found when loading HTML`);
          }
        };
        
        const setCheckboxValue = (id, value, defaultValue = false) => {
          const element = document.getElementById(id);
          if (element) {
            element.checked = value !== undefined ? value : defaultValue;
            console.log(`âœ… Restored checkbox ${id}: ${value}`);
          } else {
            console.warn(`âš ï¸ Checkbox ${id} not found`);
          }
        };

        // ğŸ”§ COMPREHENSIVE FIELD RESTORATION: Handle both structured prompts and sector configs
        console.log('ğŸ¯ Detecting config type...', promptState.source || 'unknown');
        console.log('ğŸ”µ DEBUG - promptState has these keys:', Object.keys(promptState));
        console.log('ğŸ”µ DEBUG - promptState.source:', promptState.source);
        console.log('ğŸ”µ DEBUG - has promptState.steps:', !!promptState.steps);
        console.log('ğŸ”µ DEBUG - has promptState.step1Fields:', !!promptState.step1Fields);
        console.log('ğŸ”µ DEBUG - has promptState.formData:', !!promptState.formData);
        
        // ğŸ”„ MIGRATION: Convert old prompt format to new format with step1Fields
        if (!promptState.step1Fields && !promptState.steps && promptState.companyName) {
          console.log('ğŸ”„ Migrating old prompt format to new structure...');
          promptState.step1Fields = {
            companyName: promptState.companyName || '',
            domain: promptState.domain || '',
            industryType: promptState.industryType || '',
            journeyRequirements: promptState.journeyRequirements || '',
            customSteps: promptState.customSteps || '',
            journeyType: promptState.journeyType || '',
            details: promptState.details || '',
            generationMethod: 'copilot'
          };
          promptState.step2Fields = {
            promptText1: promptState.promptText1 || '',
            promptText2: promptState.promptText2 || '',
            promptText1Step2: promptState.promptText1 || '',
            promptText2Step2: promptState.promptText2 || '',
            copilotResponse: promptState.copilotResponse || '',
            copilotResponseStep2: promptState.copilotResponseStep2 || promptState.copilotResponse || ''
          };
          console.log('âœ… Migration complete - created step1Fields and step2Fields');
        }
        
        // Determine if this is a sector-demo config (declare once, use throughout)
        const isSectorDemo = promptState.source === 'sector-demo' || promptState.steps;
        console.log('ğŸ”µ DEBUG - isSectorDemo determined as:', isSectorDemo);
        
        // Handle sector configs (new format from JSON files)
        if (isSectorDemo) {
          console.log('ğŸ“ Loading sector config format...');
          
          // Basic company info
          setElementValue('companyName', promptState.companyName);
          setElementValue('domain', promptState.domain);
          setElementValue('industryType', promptState.industryType);
          setElementValue('journeyType', promptState.journeyType);
          setElementValue('details', promptState.journeyDetail || promptState.journeyType);
          
          // Generate a summary for the journey requirements field
          if (promptState.steps && promptState.steps.length > 0) {
            const journeyDesc = `${promptState.journeyType || 'Business Process'} involving ${promptState.steps.length} main steps: ${promptState.steps.slice(0, 3).map(s => s.stepName).join(', ')}${promptState.steps.length > 3 ? '...' : ''}`;
            setElementValue('journeyRequirements', journeyDesc);
            
            // Generate proper JSON structure for copilot response
            const copilotJsonResponse = {
              journey: {
                companyName: promptState.companyName,
                domain: promptState.domain,
                industryType: promptState.industryType,
                journeyType: promptState.journeyType,
                journeyId: promptState.journeyId || `journey_${promptState.companyName.toLowerCase().replace(/\s+/g, '_')}_${new Date().getFullYear()}`,
                steps: promptState.steps.map((step, index) => ({
                  stepIndex: index + 1,
                  stepName: step.stepName || step.action,  // Use stepName, not action
                  serviceName: step.serviceName || (step.stepName ? step.stepName + 'Service' : null),
                  description: step.description,
                  category: step.category || 'General',
                  timestamp: step.timestamp || new Date().toISOString(),
                  estimatedDuration: step.estimatedDuration || 60,
                  businessRationale: step.businessRationale,
                  substeps: step.substeps || []
                }))
              },
              additionalFields: {
                journeyStartTime: promptState.journeyStartTime || new Date().toISOString(),
                source: 'sector-demo'
              }
            };
            
            const jsonString = JSON.stringify(copilotJsonResponse, null, 2);
            setElementValue('copilotResponse', jsonString);
            setElementValue('copilotResponse-step2', jsonString);
          }
          
          // Store the journey data for simulation
          if (promptState.steps) {
            window.lastJourney = promptState;
            window.currentJourneyData = promptState;
          }
          
          // Enable the Process Response button after loading copilot response
          if (typeof checkResponseInput === 'function') {
            setTimeout(checkResponseInput, 100);
          }
        } 
        // Handle original structured prompt format
        else {
          console.log('ğŸ¯ Restoring Step 1 fields...');
          console.log('ğŸ”µ DEBUG - User-saved prompt branch activated');
          console.log('ğŸ”µ DEBUG - step1Fields:', promptState.step1Fields);
          
          // ğŸ”§ PROCESS COPILOT RESPONSE: If user saved a prompt with copilotResponse, parse and extract journey
          if (promptState.step2Fields?.copilotResponseStep2 || promptState.copilotResponseStep2 || promptState.copilotResponse) {
            try {
              const copilotText = promptState.step2Fields?.copilotResponseStep2 || promptState.copilotResponseStep2 || promptState.copilotResponse;
              if (copilotText) {
                console.log('ğŸ”µ DEBUG - Found copilotResponse, parsing journey data...');
                const parsedResponse = JSON.parse(copilotText);
                if (parsedResponse.journey && parsedResponse.journey.steps) {
                  const journey = parsedResponse.journey;
                  
                  // Update step1Fields with journey metadata if missing
                  if (!promptState.step1Fields.industryType && journey.industryType) {
                    promptState.step1Fields.industryType = journey.industryType;
                  }
                  if (!promptState.step1Fields.journeyType && journey.journeyType) {
                    promptState.step1Fields.journeyType = journey.journeyType;
                  }
                  
                  // Set global journey variables
                  window.lastJourney = {
                    ...journey,
                    additionalFields: parsedResponse.additionalFields || {},
                    customerProfile: parsedResponse.customerProfile || {},
                    traceMetadata: parsedResponse.traceMetadata || {}
                  };
                  window.currentJourneyData = parsedResponse;
                  
                  console.log('âœ… Parsed journey from copilotResponse:', {
                    companyName: journey.companyName,
                    steps: journey.steps.length
                  });
                }
              }
            } catch (err) {
              console.warn('âš ï¸ Could not parse copilotResponse as JSON:', err.message);
            }
          }
          
          console.log('ğŸ¯ Restoring Step 1 fields (after JSON extraction)...');
          console.log('ğŸ¯ Restoring Step 1 fields...');
          console.log('ğŸ”µ DEBUG - User-saved prompt branch activated');
          console.log('ğŸ”µ DEBUG - step1Fields:', promptState.step1Fields);
          
          if (promptState.step1Fields) {
            console.log('ğŸ”µ DEBUG - Restoring step1Fields...');
            setElementValue('companyName', promptState.step1Fields.companyName);
            setElementValue('domain', promptState.step1Fields.domain);
            setElementValue('industryType', promptState.step1Fields.industryType);
            setElementValue('journeyRequirements', promptState.step1Fields.journeyRequirements);
            setElementValue('customSteps', promptState.step1Fields.customSteps);
            setElementValue('journeyType', promptState.step1Fields.journeyType);
            setElementValue('details', promptState.step1Fields.details);
            setElementValue('generationMethod', promptState.step1Fields.generationMethod, 'copilot');
            
            // ğŸ”§ UPDATE TOP-LEVEL FIELDS: Make user-saved prompts populate the same metadata fields as sector-demo configs
            // This ensures dashboard generation gets proper companyName, domain, industryType, journeyType
            if (promptState.step1Fields.companyName) {
              promptState.companyName = promptState.step1Fields.companyName;
            }
            if (promptState.step1Fields.domain) {
              promptState.domain = promptState.step1Fields.domain;
            }
            if (promptState.step1Fields.industryType) {
              promptState.industryType = promptState.step1Fields.industryType;
            }
            if (promptState.step1Fields.journeyType) {
              promptState.journeyType = promptState.step1Fields.journeyType;
            }
            console.log('âœ… Updated top-level metadata:', {
              companyName: promptState.companyName,
              domain: promptState.domain,
              industryType: promptState.industryType,
              journeyType: promptState.journeyType
            });
          } else {
            console.error('ğŸ”´ DEBUG - No step1Fields found in prompt!');
          }
          
          console.log('ğŸ¯ Restoring Step 2 fields...');
          if (promptState.step2Fields) {
            setElementValue('promptText1', promptState.step2Fields.promptText1);
            setElementValue('promptText2', promptState.step2Fields.promptText2);
            setElementValue('promptText1-step2', promptState.step2Fields.promptText1Step2);
            setElementValue('promptText2-step2', promptState.step2Fields.promptText2Step2);
            setElementValue('copilotResponse', promptState.step2Fields.copilotResponse);
            setElementValue('copilotResponse-step2', promptState.step2Fields.copilotResponseStep2);
          }
          
          // Restore journey data from structured format
          if (promptState.lastJourney) {
            window.lastJourney = promptState.lastJourney;
          }
          if (promptState.currentJourneyData) {
            window.currentJourneyData = promptState.currentJourneyData;
          }
          
          // Enable the Process Response button after loading copilot response
          if (typeof checkResponseInput === 'function') {
            setTimeout(checkResponseInput, 100);
          }
        }
        
        console.log('ğŸ¯ Restoring Step 3 fields...');
        if (promptState.step3Fields) {
          if (promptState.step3Fields.journeyOutput) {
            setElementContent('journey-output', promptState.step3Fields.journeyOutput);
          }
          if (promptState.step3Fields.journeyOutputStep3) {
            setElementContent('journey-output-step3', promptState.step3Fields.journeyOutputStep3);
          }
          setCheckboxValue('errorToggle', promptState.step3Fields.errorToggle);
          setCheckboxValue('errorToggle-step3', promptState.step3Fields.errorToggleStep3);
        }
        
        // ğŸ”§ POPULATE JOURNEY OUTPUT: If journey was extracted from copilotResponse, display it
        if (window.currentJourneyData && !promptState.step3Fields?.journeyOutput) {
          const journeyOutputEl = document.getElementById('journey-output');
          if (journeyOutputEl) {
            journeyOutputEl.textContent = JSON.stringify(window.currentJourneyData, null, 2);
            console.log('âœ… Populated journey-output from currentJourneyData');
          }
        }
        
        console.log('ğŸ¯ Restoring Step 4 fields...');
        if (promptState.step4Fields) {
          setElementValue('customerCount', promptState.step4Fields.customerCount, '1');
          setElementValue('thinkTimeMs', promptState.step4Fields.thinkTimeMs, '1000');
          setElementValue('executionType', promptState.step4Fields.executionType, 'chained');
        }
        
        console.log('ğŸ¯ Restoring Step 5 fields...');
        if (promptState.step5Fields) {
          if (promptState.step5Fields.simulationResults) {
            setElementHTML('simulation-results', promptState.step5Fields.simulationResults);
          }
          if (promptState.step5Fields.simulationResultsStep5) {
            setElementHTML('simulation-results-step5', promptState.step5Fields.simulationResultsStep5);
          }
        }

        // Legacy compatibility - restore original form data structure
        // BUT skip this for sector-demo configs where data is already set from the config structure
        // AND only restore if formData has actual values (don't overwrite with empty strings)
        console.log('ğŸ¯ Restoring legacy form data...');
        if (!isSectorDemo && promptState.formData && promptState.formData.companyName) {
          const formData = promptState.formData;
          if (formData.companyName) setElementValue('companyName', formData.companyName);
          if (formData.domain) setElementValue('domain', formData.domain);
          if (formData.journeyRequirements) setElementValue('journeyRequirements', formData.journeyRequirements);
          if (formData.customSteps) setElementValue('customSteps', formData.customSteps);
          if (formData.journeyType) setElementValue('journeyType', formData.journeyType);
          if (formData.details) setElementValue('details', formData.details);
          if (formData.generationMethod) setElementValue('generationMethod', formData.generationMethod, 'copilot');
          if (formData.customerCount) setElementValue('customerCount', formData.customerCount, '1');
          console.log('âœ… Restored legacy formData fields');
        } else {
          console.log('â­ï¸ Skipping legacy formData (already restored from step1Fields or empty)');
        }

        // Restore additional fields if function exists
        if (typeof window.additionalFields !== 'undefined' && typeof window.renderAdditionalFields === 'function') {
          window.additionalFields.length = 0;
          if (promptState.additionalFields) {
            window.additionalFields.push(...promptState.additionalFields);
            window.renderAdditionalFields();
          }
        }

        // Legacy compatibility - restore generated prompts and Copilot response
        console.log('ğŸ¯ Restoring legacy prompt fields...');
        setElementValue('promptText', promptState.generatedPrompt);
        setElementValue('promptText1', promptState.promptText1);
        setElementValue('promptText2', promptState.promptText2);
        setElementValue('copilotResponse', promptState.copilotResponse);

        // Restore global journey data
        console.log('ğŸ¯ Restoring journey data...');
        if (promptState.lastJourney && typeof window !== 'undefined') {
          window.lastJourney = promptState.lastJourney;
          console.log('âœ… Restored window.lastJourney');
        }
        if (promptState.currentJourneyData && typeof window !== 'undefined') {
          window.currentJourneyData = promptState.currentJourneyData;
          console.log('âœ… Restored window.currentJourneyData');
          
          // Auto-generate feature flags based on journey
          autoGenerateFeatureFlags(promptState.currentJourneyData);
          
          // Update journey output displays
          const journeyOutputEl = document.getElementById('journey-output');
          const journeyOutputStep3El = document.getElementById('journey-output-step3');
          const journeyDataText = JSON.stringify(promptState.currentJourneyData, null, 2);
          
          if (journeyOutputEl) {
            journeyOutputEl.textContent = journeyDataText;
          }
          if (journeyOutputStep3El) {
            journeyOutputStep3El.textContent = journeyDataText;
          }
        }

        // ğŸ”„ POST-RESTORATION SYNCHRONIZATION
        console.log('ğŸ¯ Triggering UI synchronization...');
        
        // Trigger form validation and UI updates
        const generationMethod = (promptState.step1Fields?.generationMethod) || (promptState.formData?.generationMethod) || 'copilot';
        const generationMethodEl = document.getElementById('generationMethod');
        if (generationMethodEl) {
          generationMethodEl.value = generationMethod;
          generationMethodEl.dispatchEvent(new Event('change'));
        }
        
        // Trigger any form validation or dependent UI updates
        const companyNameEl = document.getElementById('companyName');
        if (companyNameEl) {
          companyNameEl.dispatchEvent(new Event('input'));
        }
        
        // Sync error toggle states between tabs
        const errorToggle = document.getElementById('errorToggle');
        const errorToggleStep3 = document.getElementById('errorToggle-step3');
        if (errorToggle && errorToggleStep3) {
          errorToggleStep3.checked = errorToggle.checked;
        }
        
        // ğŸ”§ ENHANCED VALIDATION TRIGGERS: Ensure all form validation functions are called with proper timing
        console.log('ğŸ¯ Triggering validation functions...');
        
        // Trigger validation immediately
        if (typeof checkPromptRequirements === 'function') {
          checkPromptRequirements();
          console.log('âœ… checkPromptRequirements called');
        }
        if (typeof checkResponseInput === 'function') {
          checkResponseInput();
          console.log('âœ… checkResponseInput called');
        }
        
        // Also trigger validation with a delay to ensure DOM is fully updated
        setTimeout(() => {
          console.log('ğŸ•’ Delayed validation triggers...');
          if (typeof checkPromptRequirements === 'function') {
            checkPromptRequirements();
          }
          if (typeof checkResponseInput === 'function') {
            checkResponseInput();
          }
          
          // Manually trigger input events on key fields to ensure validation
          const copilotResponseEl = document.getElementById('copilotResponse-step2');
          if (copilotResponseEl && copilotResponseEl.value.trim()) {
            console.log('ğŸ”„ Triggering manual input event on copilotResponse-step2');
            copilotResponseEl.dispatchEvent(new Event('input', { bubbles: true }));
            copilotResponseEl.dispatchEvent(new Event('change', { bubbles: true }));
          }
          
          // Check process button state specifically
          const processBtn = document.getElementById('processJourneyResponse');
          if (processBtn && copilotResponseEl?.value.trim()) {
            processBtn.disabled = false;
            processBtn.classList.remove('opacity-50');
            console.log('âœ… Manually enabled process button');
          }
        }, 200);
        
        console.log('âœ… Prompt state restoration completed successfully!');
        
        // If copilot mode, regenerate the prompt with restored data
        // BUT skip this for sector-demo configs that are already complete
        if (generationMethod === 'copilot' && typeof generateCopilotPrompt === 'function' && !isSectorDemo) {
          setTimeout(() => generateCopilotPrompt(), 100);
        }

        // Auto-navigate to Step 1 - Customer Details after loading journey
        setTimeout(() => {
          if (typeof window.switchTab === 'function') {
            window.switchTab('step1');
            console.log('âœ… Auto-navigated to Step 1 - Customer Details');
          }
        }, 300);

        this.closeSidebar();
        this.showNotification(`Loaded "${promptState.name}" successfully!`);
      }

      deletePrompt(promptId) {
        if (!confirm('Are you sure you want to delete this saved prompt?')) {
          return;
        }

        const savedPrompts = this.getSavedPrompts();
        const filteredPrompts = savedPrompts.filter(p => p.id !== promptId);
        localStorage.setItem(this.storageKey, JSON.stringify(filteredPrompts));
        this.renderSavedPrompts();
        this.updatePromptsCounter();
      }

      clearAllPrompts() {
        if (!confirm('Are you sure you want to delete ALL saved prompts? This cannot be undone.')) {
          return;
        }

        localStorage.removeItem(this.storageKey);
        this.renderSavedPrompts();
        this.updatePromptsCounter();
        this.showNotification('All saved prompts cleared', 'warning');
      }

      exportPrompts() {
        const savedPrompts = this.getSavedPrompts();
        if (savedPrompts.length === 0) {
          this.showNotification('No saved prompts to export', 'warning');
          return;
        }

        const dataStr = JSON.stringify(savedPrompts, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `bizobs-prompts-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        this.showNotification(`Exported ${savedPrompts.length} prompts to file`);
      }

      importPrompts() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedPrompts = JSON.parse(e.target.result);
              if (!Array.isArray(importedPrompts)) {
                throw new Error('Invalid file format');
              }

              const existingPrompts = this.getSavedPrompts();
              const mergedPrompts = [...existingPrompts, ...importedPrompts];
              
              localStorage.setItem(this.storageKey, JSON.stringify(mergedPrompts));
              this.renderSavedPrompts();
              this.updatePromptsCounter();
              
              this.showNotification(`Imported ${importedPrompts.length} prompts successfully!`);
            } catch (error) {
              this.showNotification('Error importing prompts: Invalid file format', 'error');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      autoSaveCurrentState(reason = 'auto') {
        // Only auto-save if there's meaningful content
        const companyName = document.getElementById('companyName').value.trim();
        const industryType = document.getElementById('industryType').value.trim();

        
        if (!companyName) {
          return; // Don't auto-save empty forms
        }

        const autoName = `Auto: ${companyName || 'Unnamed'} - ${reason} (${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})`;
        
        const promptState = this.getCurrentPromptState();
        promptState.name = autoName;
        promptState.id = Date.now().toString();
        promptState.isAutoSave = true;

        const savedPrompts = this.getSavedPrompts();
        
        // Limit auto-saves to prevent clutter (keep only last 5 auto-saves)
        const manualSaves = savedPrompts.filter(p => !p.isAutoSave);
        const autoSaves = savedPrompts.filter(p => p.isAutoSave).slice(-4); // Keep last 4, plus this new one = 5
        
        const updatedPrompts = [...manualSaves, ...autoSaves, promptState];
        localStorage.setItem(this.storageKey, JSON.stringify(updatedPrompts));
        
        this.updatePromptsCounter();
      }

      async renderSavedPrompts() {
        console.log('ğŸ¨ renderSavedPrompts() called');
        
        // Populate User Saved Prompts Dropdown
        const userDropdown = document.getElementById('userSavedPromptsDropdown');
        const defaultDropdown = document.getElementById('defaultPromptsDropdown');
        
        if (!userDropdown) {
          console.error('âŒ userSavedPromptsDropdown not found');
          return;
        }
        if (!defaultDropdown) {
          console.error('âŒ defaultPromptsDropdown not found');
          return;
        }
        
        // User-saved prompts from bizobs-saved-prompts
        const userPrompts = this.getSavedPrompts();

        // Default prompts (24 pre-built) from server API
        let defaultPrompts = [];
        try {
          const response = await fetch('/api/admin/configs');
          if (response.ok) {
            const data = await response.json();
            if (data.ok && data.configs) {
              defaultPrompts = data.configs;
              console.log(`âœ… Loaded ${defaultPrompts.length} default prompts from server`);
            }
          }
        } catch (error) {
          console.error('âŒ Error loading default prompts:', error);
        }

        console.log(`ğŸ“Š Rendering prompts: ${userPrompts.length} user, ${defaultPrompts.length} default`);

        // Populate User Saved dropdown
        if (userPrompts.length === 0) {
          userDropdown.innerHTML = '<option value="">No user-saved prompts</option>';
        } else {
          userDropdown.innerHTML = userPrompts
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .map(prompt => {
              const date = new Date(prompt.timestamp).toLocaleDateString();
              const time = new Date(prompt.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              // Just use the name - it already contains company name from save
              return `<option value="${prompt.id}">${prompt.name} (${date} ${time})</option>`;
            })
            .join('');
        }

        // Populate Default Prompts dropdown (24 pre-built journeys)
        if (defaultPrompts.length === 0) {
          console.warn('âš ï¸ No default prompts found from server');
          defaultDropdown.innerHTML = '<option value="">No default prompts available</option>';
        } else {
          console.log('âœ… Loading default prompts:', defaultPrompts.map(p => p.name || 'Unnamed'));
          defaultDropdown.innerHTML = '<option value="">Select a default prompt...</option>' + 
            defaultPrompts
              .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
              .map(prompt => {
                const name = prompt.name || prompt.companyName || 'Unnamed';
                return `<option value="${prompt.id}">${name}</option>`;
              })
              .join('');
        }
      }

      duplicatePrompt(promptId) {
        const savedPrompts = this.getSavedPrompts();
        const originalPrompt = savedPrompts.find(p => p.id === promptId);
        
        if (!originalPrompt) return;

        const duplicatedPrompt = { ...originalPrompt };
        duplicatedPrompt.id = Date.now().toString();
        duplicatedPrompt.name = `Copy of ${originalPrompt.name}`;
        duplicatedPrompt.timestamp = new Date().toISOString();
        duplicatedPrompt.isQuickSave = false;

        savedPrompts.push(duplicatedPrompt);
        localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));
        
        this.renderSavedPrompts();
        this.updatePromptsCounter();
        
        // Brief success indication
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ…';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 1000);
      }
    }

    // Global functions for dropdown interactions
    window.loadSelectedUserPrompt = function() {
      const dropdown = document.getElementById('userSavedPromptsDropdown');
      const promptId = dropdown.value;
      
      console.log('ğŸ”µ loadSelectedUserPrompt called, promptId:', promptId);
      
      if (!promptId) {
        alert('Please select a user-saved prompt to load');
        return;
      }
      
      const savedPrompts = promptCache.getSavedPrompts();
      console.log('ğŸ”µ Found', savedPrompts.length, 'total saved prompts');
      
      const prompt = savedPrompts.find(p => p.id === promptId);
      console.log('ğŸ”µ Found prompt to load:', prompt ? 'YES' : 'NO');
      
      if (prompt) {
        console.log('ğŸ”µ Prompt data:', JSON.stringify(prompt, null, 2).substring(0, 500));
        promptCache.loadPromptState(prompt);
        promptCache.showNotification(`Loaded: ${prompt.name}`);
        
        // Close sidebar after successful load
        promptCache.closeSidebar();
      } else {
        console.error('ğŸ”´ Prompt not found with ID:', promptId);
        alert('Prompt not found');
      }
    };

    window.duplicateSelectedUserPrompt = function() {
      const dropdown = document.getElementById('userSavedPromptsDropdown');
      const promptId = dropdown.value;
      
      if (!promptId) {
        alert('Please select a prompt to duplicate');
        return;
      }
      
      promptCache.duplicatePrompt(promptId);
      promptCache.showNotification('Prompt duplicated!');
    };

    window.deleteSelectedUserPrompt = function() {
      const dropdown = document.getElementById('userSavedPromptsDropdown');
      const promptId = dropdown.value;
      
      if (!promptId) {
        alert('Please select a prompt to delete');
        return;
      }
      
      const savedPrompts = promptCache.getSavedPrompts();
      const prompt = savedPrompts.find(p => p.id === promptId);
      
      if (prompt && confirm(`Delete "${prompt.name}"?`)) {
        promptCache.deletePrompt(promptId);
        promptCache.showNotification('Prompt deleted');
      }
    };

    window.loadSelectedDefaultPrompt = async function() {
      const dropdown = document.getElementById('defaultPromptsDropdown');
      const configId = dropdown.value;
      
      if (!configId) {
        alert('Please select a default prompt to load');
        return;
      }
      
      try {
        // Fetch the full config from server
        const response = await fetch(`/api/admin/configs/${configId}`);
        if (!response.ok) {
          throw new Error('Failed to load configuration');
        }
        
        const data = await response.json();
        if (data.ok && data.config) {
          promptCache.loadPromptState(data.config);
          promptCache.showNotification(`Loaded: ${data.config.name || 'Default Prompt'}`);
        } else {
          alert('Configuration not found');
        }
      } catch (error) {
        console.error('Error loading default prompt:', error);
        alert(`Error: ${error.message}`);
      }
    };

    // Initialize prompt cache
    console.log('Initializing PromptCache...');
    // Initialize PromptCache after DOM is fully loaded
    let promptCache;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ DOM loaded, initializing PromptCache...');
        promptCache = new PromptCache();
        window.promptCache = promptCache;
        setupBackupEventListeners();
        setTimeout(() => refreshSavedPromptsList(), 200);
        
        // ğŸ”§ NEW: Open sidebar by default on page load
        setTimeout(() => {
          console.log('ğŸ“‚ Opening saved prompts sidebar by default...');
          const sidebar = document.getElementById('savedPromptsSidebar');
          const mainContent = document.getElementById('mainContent');
          if (sidebar) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            if (mainContent) mainContent.classList.add('sidebar-open');
            console.log('âœ… Sidebar opened successfully');
          } else {
            console.error('âŒ Could not find sidebar to open');
          }
        }, 300);
      });
    } else {
      console.log('ğŸš€ DOM already loaded, initializing PromptCache immediately...');
      promptCache = new PromptCache();
      window.promptCache = promptCache;
      setupBackupEventListeners();
      setTimeout(() => refreshSavedPromptsList(), 200);
      
      // ğŸ”§ NEW: Open sidebar by default on page load  
      setTimeout(() => {
        console.log('ğŸ“‚ Opening saved prompts sidebar by default...');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        if (sidebar) {
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
          if (mainContent) mainContent.classList.add('sidebar-open');
          console.log('âœ… Sidebar opened successfully');
        } else {
          console.error('âŒ Could not find sidebar to open');
        }
      }, 300);
    }
    
    // Global save function that works independently
    window.saveCurrentConfiguration = async function() {
      console.log('ğŸ’¾ Global save function called');
      
      const nameInput = document.getElementById('savePromptName');
      const saveBtn = document.getElementById('saveCurrentPrompt');
      const saveStatus = document.getElementById('saveStatus');
      
      let name = nameInput ? nameInput.value.trim() : '';
      
      // If no name provided, generate one based on company and timestamp
      if (!name) {
        const companyName = document.getElementById('companyName')?.value.trim() || 'Unknown';
        const timestamp = new Date().toLocaleString();
        name = `${companyName} - ${timestamp}`;
        console.log('Auto-generated name:', name);
      }

      // Show saving status immediately
      if (saveStatus) {
        saveStatus.classList.remove('hidden');
        saveStatus.innerHTML = '<span class="text-dtcyan">â˜ï¸ Saving configuration...</span>';
      }
      
      // Disable save button during process
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ğŸ’¾ Saving...';
        saveBtn.classList.add('opacity-75');
      }

      try {
        // Get current form state
        const getCurrentState = () => {
          const getElementValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : '';
          };

          return {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: getElementValue('industryType') || getElementValue('details'),
            journeyRequirements: getElementValue('journeyRequirements') || getElementValue('customSteps'),
            copilotResponse: getElementValue('copilotResponse'),
            copilotResponseStep2: getElementValue('copilotResponse-step2'),
            promptText1: getElementValue('promptText1-step2'),
            promptText2: getElementValue('promptText2-step2'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            customSteps: getElementValue('customSteps'),
            lastJourney: typeof window.lastJourney !== 'undefined' ? window.lastJourney : null,
            currentJourneyData: typeof window.currentJourneyData !== 'undefined' ? window.currentJourneyData : null,
            timestamp: new Date().toISOString()
          };
        };

        const promptState = getCurrentState();
        promptState.name = name;
        promptState.id = Date.now().toString();

        // Save to localStorage first (always works)
        const storageKey = 'bizobs-saved-prompts';
        const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
        savedPrompts.push(promptState);
        localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
        
        let serverSaveSuccess = false;
        
        // Also save to server for persistence across app restarts
        try {
          const serverResponse = await fetch('/api/admin/configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promptState)
          });
          const serverResult = await serverResponse.json();
          
          if (serverResult.ok) {
            console.log('âœ… Configuration saved to server:', serverResult.message);
            serverSaveSuccess = true;
            
            if (saveStatus) {
              saveStatus.innerHTML = '<span class="text-dtgreen">âœ… Saved to server & browser</span>';
            }
          } else {
            console.warn('âš ï¸ Server save failed:', serverResult.error);
            if (saveStatus) {
              saveStatus.innerHTML = '<span class="text-yellow-400">âš ï¸ Saved locally only (server failed)</span>';
            }
          }
        } catch (serverError) {
          console.warn('âš ï¸ Server storage error:', serverError.message);
          if (saveStatus) {
            saveStatus.innerHTML = '<span class="text-yellow-400">âš ï¸ Saved locally only (server error)</span>';
          }
        }
        
        // Only clear the input field after successful save
        if (nameInput && serverSaveSuccess) {
          nameInput.value = '';
        }
        
        // Re-enable and update save button
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.classList.remove('opacity-75');
          saveBtn.textContent = 'âœ… Saved!';
          saveBtn.style.background = '#10b981';
          
          // Reset button after delay
          setTimeout(() => {
            saveBtn.textContent = 'ğŸ’¾ Save Current State';
            saveBtn.style.background = '';
          }, 2000);
        }
        
        // Hide status after delay if successful
        if (saveStatus && serverSaveSuccess) {
          setTimeout(() => {
            saveStatus.classList.add('hidden');
          }, 3000);
        }
        
        // Refresh the saved prompts list
        if (typeof refreshSavedPromptsList === 'function') {
          refreshSavedPromptsList();
        }
        
        // Update counter if element exists
        const counter = document.getElementById('promptsCounter');
        if (counter) {
          counter.textContent = savedPrompts.length;
        }
        
        console.log(`âœ… Saved configuration "${name}" successfully!`);
        
        // Show success alert only if server save worked, otherwise show warning
        if (serverSaveSuccess) {
          alert(`âœ… Configuration "${name}" saved successfully!`);
        } else {
          alert(`âš ï¸ Configuration "${name}" saved locally but failed to save to server. It may not persist across app restarts.`);
        }
        
      } catch (error) {
        console.error('âŒ Error saving configuration:', error);
        
        // Re-enable button on error
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.classList.remove('opacity-75');
          saveBtn.textContent = 'âŒ Save Failed';
          saveBtn.style.background = '#ef4444';
          
          setTimeout(() => {
            saveBtn.textContent = 'ğŸ’¾ Save Current State';
            saveBtn.style.background = '';
          }, 3000);
        }
        
        // Show error status
        if (saveStatus) {
          saveStatus.classList.remove('hidden');
          saveStatus.innerHTML = '<span class="text-red-400">âŒ Save failed - please try again</span>';
        }
        
        alert('âŒ Error saving configuration: ' + error.message);
      }
    };

    // Helper function to save configuration data to both localStorage and server
    window.saveConfigurationData = async function(configData) {
      // Save to localStorage first (always works)
      const storageKey = 'bizobs-saved-prompts';
      const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      // Remove existing config with same ID if it exists
      const existingIndex = savedPrompts.findIndex(p => p.id === configData.id);
      if (existingIndex !== -1) {
        savedPrompts[existingIndex] = configData;
      } else {
        savedPrompts.push(configData);
      }
      
      localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
      
      // Also save to server
      try {
        const response = await fetch('/api/admin/configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        if (result.ok) {
          console.log('âœ… Configuration saved to server');
        } else {
          console.warn('âš ï¸ Server save failed:', result.error);
        }
      } catch (error) {
        console.warn('âš ï¸ Server save error:', error.message);
      }
    };

    // Function to refresh the saved prompts list display
    async function refreshSavedPromptsList() {
      console.log('ğŸ”„ refreshSavedPromptsList() called');
      try {
        const listContainer = document.getElementById('savedPromptsList');
        
        if (!listContainer) {
          console.warn('âš ï¸ Saved prompts list container not found');
          return;
        }
        
        console.log('âœ… Found savedPromptsList container, loading data...');
        
        // Show loading state
        listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">Loading saved configurations...</div>';
        
        // ğŸ”§ FIX: Load from server first, then merge with localStorage
        let allPrompts = [];
        
        // Load from server
        try {
          const serverResponse = await fetch('/api/admin/configs');
          if (serverResponse.ok) {
            const serverData = await serverResponse.json();
            if (serverData.ok && serverData.configs) {
              // Get full config data for each server config
              for (const configMeta of serverData.configs) {
                try {
                  const configResponse = await fetch(`/api/admin/configs/${configMeta.id}`);
                  if (configResponse.ok) {
                    const configData = await configResponse.json();
                    if (configData.ok) {
                      configData.config.source = 'server';
                      allPrompts.push(configData.config);
                    }
                  }
                } catch (error) {
                  console.warn(`âš ï¸ Error loading server config ${configMeta.id}:`, error);
                }
              }
              console.log(`ğŸ“¡ Loaded ${allPrompts.length} configurations from server`);
            }
          }
        } catch (error) {
          console.log('ğŸ“¡ Server load failed, checking localStorage:', error.message);
        }
        
        // Load from localStorage as backup (only if not already on server)
        const storageKey = 'bizobs-saved-prompts';
        const localPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
        localPrompts.forEach(localPrompt => {
          const existsOnServer = allPrompts.some(serverPrompt => serverPrompt.id === localPrompt.id);
          if (!existsOnServer) {
            localPrompt.source = 'local';
            allPrompts.push(localPrompt);
          }
        });
        
        console.log(`âœ… Total configurations loaded: ${allPrompts.length}`);
        
        // Add source indicator for localStorage prompts
        
        if (allPrompts.length === 0) {
          listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No saved configurations yet.<br>Save your current configuration to get started!</div>';
          return;
        }
        
        // ğŸ”§ FIXED: Render saved prompts directly without delegation to avoid timing issues
        console.log(`ğŸ¯ Rendering ${allPrompts.length} saved prompts directly`);
        
        // First clear the container
        listContainer.innerHTML = '';
        
        if (allPrompts.length === 0) {
          listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-8">No saved configurations found</div>';
          return;
        }
        
        listContainer.innerHTML = allPrompts.map(prompt => {
          const date = new Date(prompt.timestamp).toLocaleDateString();
          const time = new Date(prompt.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const company = prompt.formData?.companyName || prompt.companyName || 'Unnamed';
          const method = prompt.formData?.generationMethod || 'copilot';
          const industry = prompt.formData?.industryType || 'general';
          const hasJourney = prompt.lastJourney ? 'âœ… Journey' : 'ğŸ“ Config';
          
          let icon = 'ğŸ“Œ';
          if (prompt.isQuickSave) icon = 'âš¡';
          if (prompt.isAutoSave) icon = 'ğŸ¤–';
          
          const sourceIcon = prompt.source === 'server' ? 'â˜ï¸' : 'ğŸ’¾';
          const sourceTitle = prompt.source === 'server' ? 'Stored on server (persistent)' : 'Stored locally (browser only)';
          
          return `
            <div class="bg-dtgray p-3 rounded-lg border border-dtborder hover:border-dtcyan transition-all cursor-pointer" 
                 data-prompt-id="${prompt.id}" 
                 data-prompt-source="${prompt.source || 'local'}"
                 onclick="loadSavedPrompt('${prompt.id}', '${prompt.source || 'local'}')">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <h4 class="text-dtcyan font-medium text-sm">${icon} ${prompt.name || company}</h4>
                    <span class="text-xs" title="${sourceTitle}">${sourceIcon}</span>
                    <span class="text-xs bg-dtblue text-white px-2 py-0.5 rounded">${method}</span>
                  </div>
                  <p class="text-gray-400 text-xs mt-1">${company} â€¢ ${date}</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-500">${time}</span>
                    <span class="text-xs ${prompt.lastJourney ? 'text-green-400' : 'text-yellow-400'}">${hasJourney}</span>
                  </div>
                </div>
                <div class="flex gap-1 ml-2">
                  <button data-action="duplicate" onclick="event.stopPropagation(); duplicatePrompt('${prompt.id}', '${prompt.source || 'local'}')" class="text-dtblue hover:text-dtcyan text-xs p-1 transition-all hover:scale-110" title="Duplicate">ğŸ“„</button>
                  <button data-action="delete" onclick="event.stopPropagation(); deletePrompt('${prompt.id}', '${prompt.source || 'local'}')" class="text-red-400 hover:text-red-300 text-xs p-1 transition-all hover:scale-110" title="Delete">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // ğŸ”§ ENHANCEMENT: Add event delegation for dynamically generated content
        setTimeout(() => {
          // Remove any existing event listeners
          const existingHandler = listContainer.__savedPromptsHandler;
          if (existingHandler) {
            listContainer.removeEventListener('click', existingHandler);
          }
          
          // Add new event delegation handler
          const clickHandler = function(e) {
            const promptCard = e.target.closest('[data-prompt-id]');
            if (!promptCard) return;
            
            const promptId = promptCard.dataset.promptId;
            const promptSource = promptCard.dataset.promptSource || 'local';
            
            // Handle button clicks
            if (e.target.closest('[data-action="duplicate"]')) {
              e.stopPropagation();
              console.log('ğŸ”„ Duplicate button clicked for:', promptId);
              window.duplicatePrompt(promptId, promptSource);
              return;
            }
            
            if (e.target.closest('[data-action="delete"]')) {
              e.stopPropagation();
              console.log('ğŸ—‘ï¸ Delete button clicked for:', promptId);
              window.deletePrompt(promptId, promptSource);
              return;
            }
            
            // Handle card click (load prompt)
            if (!e.target.closest('button')) {
              console.log('ğŸ“‹ Loading saved prompt:', promptId);
              window.loadSavedPrompt(promptId, promptSource);
            }
          };
          
          listContainer.addEventListener('click', clickHandler);
          listContainer.__savedPromptsHandler = clickHandler;
        }, 100);
        
        console.log(`âœ… Refreshed saved prompts list with ${allPrompts.length} items`);
      } catch (error) {
        console.error('âŒ Error refreshing saved prompts list:', error);
      }
    }

    // Load a saved prompt configuration
    window.loadSavedPrompt = async function(promptId, source = 'local') {
      console.log(`ğŸ“‹ Loading saved prompt: ${promptId} from ${source}`);
      try {
        let prompt = null;
        
        if (source === 'server') {
          // Load from server
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                prompt = data.config;
              }
            }
          } catch (error) {
            console.warn('Failed to load from server, trying localStorage:', error);
          }
        }
        
        // Fallback to localStorage if server failed or source is local
        if (!prompt) {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          prompt = savedPrompts.find(p => p.id === promptId);
        }
        
        if (!prompt) {
          alert('Configuration not found');
          return;
        }
        
        // Load form values - handle both structured and sector config formats
        const setElementValue = (id, value) => {
          const el = document.getElementById(id);
          if (el && value !== undefined && value !== null) el.value = value;
        };
        
        // Handle sector configs (new format)
        if (prompt.source === 'sector-demo' || prompt.steps) {
          console.log('ğŸ“ Loading sector config format...');
          
          setElementValue('companyName', prompt.companyName);
          setElementValue('domain', prompt.domain);
          setElementValue('industryType', prompt.industryType);
          setElementValue('journeyType', prompt.journeyType);
          setElementValue('details', prompt.journeyDetail || prompt.journeyType);
          
          // Generate journey requirements from steps
          if (prompt.steps && prompt.steps.length > 0) {
            const journeyDesc = `${prompt.journeyType || 'Business Process'} involving ${prompt.steps.length} main steps: ${prompt.steps.slice(0, 3).map(s => s.stepName).join(', ')}${prompt.steps.length > 3 ? '...' : ''}`;
            setElementValue('journeyRequirements', journeyDesc);
            
            // Generate proper JSON structure for copilot response
            const copilotJsonResponse = {
              journey: {
                companyName: prompt.companyName,
                domain: prompt.domain,
                industryType: prompt.industryType,
                journeyType: prompt.journeyType,
                journeyId: prompt.journeyId || `journey_${prompt.companyName.toLowerCase().replace(/\s+/g, '_')}_${new Date().getFullYear()}`,
                steps: prompt.steps.map((step, index) => ({
                  stepIndex: index + 1,
                  stepName: step.stepName || step.action,
                  serviceName: step.serviceName,
                  description: step.description,
                  category: step.category || 'General',
                  timestamp: step.timestamp || new Date().toISOString(),
                  estimatedDuration: step.estimatedDuration || 60,
                  businessRationale: step.businessRationale,
                  substeps: step.substeps || []
                }))
              },
              additionalFields: {
                journeyStartTime: prompt.journeyStartTime || new Date().toISOString(),
                source: 'sector-demo'
              }
            };
            
            const jsonString = JSON.stringify(copilotJsonResponse, null, 2);
            setElementValue('copilotResponse', jsonString);
            setElementValue('copilotResponse-step2', jsonString);
          }
          
          // Store the journey data for simulation
          if (prompt.steps) {
            window.lastJourney = prompt;
            window.currentJourneyData = prompt;
          }
          
          // Enable the Process Response button after loading copilot response
          if (typeof checkResponseInput === 'function') {
            setTimeout(checkResponseInput, 100);
          }
        } 
        // Handle original structured format
        else {
          setElementValue('companyName', prompt.companyName);
          setElementValue('domain', prompt.domain);
          setElementValue('industryType', prompt.industryType);
          setElementValue('journeyRequirements', prompt.journeyRequirements);
          setElementValue('copilotResponse', prompt.copilotResponse);
          setElementValue('copilotResponse-step2', prompt.copilotResponseStep2);
          setElementValue('journeyType', prompt.journeyType);
          setElementValue('details', prompt.details);
          setElementValue('customSteps', prompt.customSteps);
          
          // Restore journey data
          if (prompt.lastJourney) {
            window.lastJourney = prompt.lastJourney;
          }
          if (prompt.currentJourneyData) {
            window.currentJourneyData = prompt.currentJourneyData;
            // Auto-generate feature flags
            autoGenerateFeatureFlags(prompt.currentJourneyData);
          }
          
          // Enable the Process Response button after loading copilot response
          if (typeof checkResponseInput === 'function') {
            setTimeout(checkResponseInput, 100);
          }
        }
        
        alert('âœ… Loaded configuration "' + prompt.name + '"');
        console.log('âœ… Loaded prompt: ' + prompt.name);
        
      } catch (error) {
        console.error('âŒ Error loading prompt:', error);
        alert('âŒ Error loading prompt: ' + error.message);
      }
    };

    // Duplicate a saved prompt
    window.duplicatePrompt = async function(promptId, source = 'local') {
      try {
        // First load the original prompt
        let prompt = null;
        
        if (source === 'server') {
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                prompt = data.config;
              }
            }
          } catch (error) {
            console.warn('Failed to load from server for duplication:', error);
          }
        }
        
        if (!prompt) {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          prompt = savedPrompts.find(p => p.id === promptId);
        }
        
        if (!prompt) {
          alert('Configuration not found for duplication');
          return;
        }
        
        // Create duplicate
        const duplicate = { ...prompt };
        duplicate.id = Date.now().toString();
        duplicate.name = prompt.name + ' (Copy)';
        duplicate.timestamp = new Date().toISOString();
        
        // Save duplicate (will go to both localStorage and server)
        await window.saveConfigurationData(duplicate);
        
        refreshSavedPromptsList();
        alert(`âœ… Duplicated "${prompt.name}"`);
        
      } catch (error) {
        console.error('âŒ Error duplicating prompt:', error);
        alert('âŒ Error duplicating prompt: ' + error.message);
      }
    };

    // Delete a saved prompt
    window.deletePrompt = async function(promptId, source = 'local') {
      try {
        // First get the prompt name for confirmation
        let promptName = 'Unknown';
        
        if (source === 'server') {
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                promptName = data.config.name;
              }
            }
          } catch (error) {
            console.warn('Could not get prompt name from server:', error);
          }
        } else {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const prompt = savedPrompts.find(p => p.id === promptId);
          if (prompt) promptName = prompt.name;
        }
        
        if (!confirm(`Delete "${promptName}"?\n\nThis will remove it from both local storage and server storage.`)) {
          return;
        }
        
        let success = false;
        
        // Delete from server if it exists there
        try {
          const response = await fetch(`/api/admin/configs/${promptId}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            success = true;
            console.log('âœ… Deleted from server');
          }
        } catch (error) {
          console.warn('Could not delete from server:', error.message);
        }
        
        // Delete from localStorage
        try {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const promptIndex = savedPrompts.findIndex(p => p.id === promptId);
          
          if (promptIndex !== -1) {
            savedPrompts.splice(promptIndex, 1);
            localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
            success = true;
            console.log('âœ… Deleted from localStorage');
          }
        } catch (error) {
          console.warn('Could not delete from localStorage:', error.message);
        }
        
        if (success) {
          refreshSavedPromptsList();
          alert(`âœ… Deleted "${promptName}"`);
        } else {
          alert(`âŒ Could not delete "${promptName}"`);
        }
        
      } catch (error) {
        console.error('âŒ Error deleting prompt:', error);
        alert('âŒ Error deleting prompt: ' + error.message);
      }
    };

    // Backup event listeners in case PromptCache event listeners fail
    function setupBackupEventListeners() {
      setTimeout(() => {
        const saveBtn = document.getElementById('saveCurrentPrompt');
        if (saveBtn) {
          console.log('ğŸ”§ Adding backup event listener for save button');
          
          // Remove any existing listeners
          const newBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newBtn, saveBtn);
          
          // Add the working event listener
          newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ğŸ’¾ Save button clicked - calling global function');
            window.saveCurrentConfiguration();
          });
          
          newBtn.setAttribute('data-listener-added', 'true');
          console.log('âœ… Backup save event listener added successfully');
        }
      }, 100);
    }
    console.log('PromptCache initialized successfully');



    window.runJourneySimulation = async function() {
      console.log('ğŸ”¥ GREEN BUTTON CLICKED! ğŸ”¥');
      
      // Find all possible button variations
      const runJourneySimBtn = document.getElementById('run-journey-simulation') || 
                               document.getElementById('run-journey-simulation-step4') ||
                               document.querySelector('[onclick*="runJourneySimulation"]');
      
      const simStatus = document.getElementById('sim-status') || 
                        document.getElementById('simulation-status-step4') ||
                        document.querySelector('[id*="simulation-status"]');
      
      let flowResultsEl = document.getElementById('flow-results') || 
                          document.getElementById('simulation-results-step4') ||
                          document.querySelector('[id*="simulation-results"]');
      
      // Clear previous results at the start of each simulation
      if (flowResultsEl) {
        flowResultsEl.textContent = '';
        flowResultsEl.innerHTML = '';
      }
      
      if (!flowResultsEl) {
        flowResultsEl = document.createElement('pre');
        flowResultsEl.id = 'dynamic-flow-results';
        flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
        if (simStatus && simStatus.parentElement) {
          simStatus.parentElement.appendChild(flowResultsEl);
        }
      }
      
      try {
        runJourneySimBtn.disabled = true;
        runJourneySimBtn.textContent = 'ğŸ”„ Simulating Journey...';
        simStatus.textContent = 'Starting customer journey simulation...';
        
        // Try to get journey from processed output first
        let processedJourney = null;
        
        // First try to get journey from window.currentJourneyData (from Copilot processing)
        if (window.currentJourneyData && window.currentJourneyData.journey) {
          processedJourney = window.currentJourneyData.journey;
          console.log('âœ… Using Copilot journey data:', processedJourney.companyName, processedJourney.steps.length, 'steps');
        } else if (currentJourneyData && currentJourneyData.journey) {
          processedJourney = currentJourneyData.journey;
          console.log('Using local currentJourneyData:', processedJourney);
        }
        // If not available, try to parse from journey output element
        else {
          const journeyOutputEl = document.getElementById('journey-output');
          if (journeyOutputEl && journeyOutputEl.textContent.trim()) {
            try {
              const parsedOutput = JSON.parse(journeyOutputEl.textContent);
              if (parsedOutput.journey) {
                processedJourney = parsedOutput.journey;
                console.log('Parsed journey from output:', processedJourney);
              }
            } catch (e) {
              console.error('Failed to parse journey output:', e);
            }
          }
        }
        
        // Use the parsed journey data or fallback to window.lastJourney or create test
        console.log('ğŸ” Journey data analysis:');
        console.log('  - processedJourney:', processedJourney);
        console.log('  - window.lastJourney:', window.lastJourney);
        console.log('  - currentJourneyData:', window.currentJourneyData);
        
        if (processedJourney && processedJourney.steps && processedJourney.steps.length > 0) {
          window.lastJourney = processedJourney;
          lastJourney = processedJourney;
          const errorModeText = errorSimulationEnabled ? ' with errors' : ' (error-free)';
          simStatus.textContent = `ğŸš€ Running ${processedJourney.companyName} simulation (${processedJourney.steps.length} steps)${errorModeText}...`;
          console.log('âœ… Using processed journey with steps:', processedJourney.steps.map(s => s.stepName || s.name || 'unnamed').join(', '));
        } else if (window.lastJourney && window.lastJourney.steps && window.lastJourney.steps.length > 0) {
          lastJourney = window.lastJourney;
          const errorModeText = errorSimulationEnabled ? ' with errors' : ' (error-free)';
          simStatus.textContent = `ğŸš€ Running ${lastJourney.companyName} simulation (${lastJourney.steps.length} steps)${errorModeText}...`;
          console.log('âœ… Using window.lastJourney with steps:', lastJourney.steps.map(s => s.stepName || s.name || 'unnamed').join(', '));
        } else if (!lastJourney || !lastJourney.steps || lastJourney.steps.length === 0) {
          simStatus.textContent = 'âš ï¸ No journey data available. Creating test journey for simulation...';
          
          lastJourney = {
            companyName: 'SimTestCorp',
            domain: 'simtestcorp.com',
            industryType: 'Simulation Testing',
            journeyType: 'Test Simulation',
            steps: [
              { stepName: 'Discovery', description: 'Customer discovery phase' },
              { stepName: 'Evaluation', description: 'Product evaluation' },
              { stepName: 'Decision', description: 'Purchase decision' },
              { stepName: 'Transaction', description: 'Complete transaction' }
            ]
          };
          
          simStatus.textContent = 'âœ… Test journey created! Starting simulation...';
        }
        
        const customerId = `customer_${Date.now()}`;
        const journeyId = `journey_${Date.now()}`;
        
        // Build comprehensive journey data with all available fields
        console.log('ğŸ”§ Processing journey steps for error simulation...');
        const processedSteps = (lastJourney.steps || []).map(step => {
          const processedStep = { ...step };
          
          // Enhanced error simulation processing
          if (errorSimulationEnabled && step.errorHint) {
            console.log(`  - Step "${step.stepName}": Error ${step.errorHint.type} (${step.errorHint.httpStatus}) - Likelihood: ${step.errorHint.likelihood}`);
            processedStep.errorSimulationConfig = {
              enabled: true,
              errorType: step.errorHint.type,
              httpStatus: step.errorHint.httpStatus,
              likelihood: step.errorHint.likelihood,
              shouldSimulateError: Math.random() < step.errorHint.likelihood
            };
          } else if (errorSimulationEnabled) {
            // Fallback error simulation if no errorHint
            processedStep.errorSimulationConfig = {
              enabled: true,
              errorType: 'generic_error',
              httpStatus: 500,
              likelihood: 0.1,
              shouldSimulateError: Math.random() < 0.1
            };
          } else {
            processedStep.errorSimulationConfig = {
              enabled: false,
              shouldSimulateError: false
            };
          }
          
          return processedStep;
        });
        
        console.log(`ğŸ¯ Error simulation mode: ${errorSimulationEnabled ? 'ENABLED' : 'DISABLED'}`);
        console.log(`ğŸ¯ DEBUGGING: errorSimulationEnabled value being sent:`, errorSimulationEnabled, typeof errorSimulationEnabled);
        if (errorSimulationEnabled) {
          const errorSteps = processedSteps.filter(s => s.errorSimulationConfig?.shouldSimulateError);
          console.log(`  - ${errorSteps.length}/${processedSteps.length} steps will simulate errors:`, 
                     errorSteps.map(s => `${s.stepName} (${s.errorSimulationConfig.errorType})`));
        }
        
        const journeyData = {
          steps: processedSteps,
          journeyId: lastJourney.id || journeyId,
          companyName: lastJourney.companyName || 'DefaultCompany',
          domain: lastJourney.domain || 'default.com',
          industryType: lastJourney.industryType || 'general',
          journeyType: lastJourney.journeyType || lastJourney.industryType || lastJourney.companyName || 'DefaultJourney',
          description: lastJourney.description || `${lastJourney.companyName || 'Customer'} journey`,
          
          // Include all additional fields from the AI processing (check multiple sources)
          additionalFields: lastJourney.additionalFields || currentJourneyData?.additionalFields || {
            sessionId: `session_${Date.now()}`,
            deviceType: 'desktop',
            userAgent: navigator.userAgent || 'Chrome/118.0.0.0',
            campaignSource: 'organic_search',
            customerSegment: 'premium',
            behaviorScore: 8.5,
            abandonmentRisk: 'low',
            timestamp: new Date().toISOString(),
            simulationMode: true
          },
          
          customerProfile: lastJourney.customerProfile || currentJourneyData?.customerProfile || {
            customerId: customerId,
            age: 32,
            gender: 'F',
            loyaltyTier: 'gold',
            previousPurchases: 15,
            avgOrderValue: 125.50,
            preferredChannel: 'mobile',
            registrationDate: new Date(Date.now() - 365*24*60*60*1000).toISOString(),
            lastLoginDate: new Date().toISOString()
          },
          
          traceMetadata: lastJourney.traceMetadata || currentJourneyData?.traceMetadata || {
            experimentId: 'exp_2025_q4',
            testVariant: 'control',
            featureFlags: ['checkout_v2', 'ai_recommendations'],
            abTestGroup: 'A',
            correlationId: journeyId,
            parentSpanId: null,
            traceId: `trace_${Date.now()}`
          },
          
          // Include business context from form inputs (using safe access)
          formContext: {
            customSteps: safeGetElementValue('customSteps'),
            journeyType: safeGetElementValue('journeyType'),
            details: safeGetElementValue('details'),
            generationMethod: safeGetElementValue('generationMethod', 'copilot')
          },
          
          // Include dynamic additional fields defined by user
          userDefinedFields: (function() {
            try {
              if (typeof additionalFields !== 'undefined' && Array.isArray(additionalFields)) {
                return additionalFields.reduce((acc, field) => {
                  acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                   field.type === 'boolean' ? Math.random() > 0.5 :
                                   field.type === 'array' ? ['sample', 'data'] :
                                   `sample_${field.name}_value`;
                  return acc;
                }, {});
              }
              return {};
            } catch (e) {
              console.warn('additionalFields not available:', e.message);
              return {};
            }
          })(),
            
          // Include comprehensive business event metadata
          businessMetadata: {
            timestamp: new Date().toISOString(),
            sessionId: `session_${Date.now()}`,
            deviceType: 'desktop',
            userAgent: navigator.userAgent || 'Unknown',
            campaignSource: 'simulation',
            customerSegment: lastJourney.customerSegment || 'standard',
            behaviorScore: lastJourney.behaviorScore || Math.floor(Math.random() * 10) + 1,
            abandonmentRisk: lastJourney.abandonmentRisk || 'low',
            experimentId: `exp_${Date.now()}`,
            testVariant: 'simulation',
            featureFlags: lastJourney.featureFlags || ['simulation_mode'],
            abTestGroup: 'simulation',
            region: 'us-east-1',
            environment: 'simulation'
          }
        };
        
        let errorStatusText = '';
        if (errorSimulationEnabled) {
          const errorSteps = processedSteps.filter(s => s.errorSimulationConfig?.shouldSimulateError);
          if (errorSteps.length > 0) {
            const errorTypes = errorSteps.map(s => s.errorSimulationConfig.errorType).join(', ');
            errorStatusText = ` (ğŸ”´ ${errorSteps.length} steps with errors: ${errorTypes})`;
          } else {
            errorStatusText = ' (ğŸŸ¡ Error simulation enabled but no errors will trigger this run)';
          }
        } else {
          errorStatusText = ' (âœ… Error-free mode)';
        }
        simStatus.textContent = `ğŸš€ Running customer journey simulation${errorStatusText}...`;
        
        // Get customer count from UI with validation (defensive programming)
        const customerCountElement = document.getElementById('customerCount');
        const customerCount = customerCountElement ? parseInt(customerCountElement.value) || 1 : 1;
        
        // Validate customer limit
        if (customerCount > 1) {
          simStatus.textContent = 'âŒ Customer limit exceeded. Maximum allowed: 1 customer';
          alert('Customer limit exceeded!\n\nMaximum allowed: 1 customer\nYou entered: ' + customerCount + ' customers\n\nPlease reduce the number and try again.');
          return;
        }
        
        console.log(`Running simulation for ${customerCount} customers`);
        
        // Use appropriate endpoint based on customer count
        const endpoint = customerCount > 1 ? '/api/journey-simulation/simulate-multiple-journeys' : '/api/journey-simulation/simulate-journey';
        
        // Build comprehensive request body with all available data
        const requestBody = {
          journeyId,
          customerId,
          journey: journeyData,  // Complete journey object with all fields
          companyName: journeyData.companyName,
          domain: journeyData.domain,
          industryType: journeyData.industryType,
          journeyType: journeyData.journeyType,
          description: journeyData.description,
          
          // Include all context data in request body for tracing
          additionalFields: journeyData.additionalFields || {},
          customerProfile: journeyData.customerProfile || {},
          traceMetadata: journeyData.traceMetadata || {},
          formContext: journeyData.formContext || {},
          userDefinedFields: journeyData.userDefinedFields || {},
          businessMetadata: journeyData.businessMetadata || {},
          
          // Simulation parameters with feature flags
          chained: false,
          simulationId: `sim_${Date.now()}`,
          batchId: `batch_${Date.now()}`,
          customerCount: 1,
          featureFlags: window.getActiveFeatureFlags ? window.getActiveFeatureFlags() : {}
        };
        
        // Add customers parameter for multiple journey endpoint
        if (customerCount > 1) {
          requestBody.customers = customerCount;
        }
        
        console.log(`ğŸš€ About to POST to ${endpoint} with company: ${journeyData.companyName}`);
        console.log('ğŸ“¦ Request body keys:', Object.keys(requestBody));
        
        const res = await fetch(endpoint, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(requestBody) 
        });
        
        console.log(`âœ… Fetch completed, status: ${res.status}`);
        const json = await res.json();
        console.log(`âœ… Response parsed, success: ${json.success}`);
        
        if (json.success) {
          // Handle multiple customers response
          if (json.loadTestSummary && customerCount > 1) {
            const summary = json.loadTestSummary;
            
            // Analyze errors to provide better status message
            const errors = json.errors || [];
            const incompleteCount = errors.filter(err => err.includes('incomplete')).length;
            const failureCount = errors.filter(err => !err.includes('incomplete')).length;
            
            let statusIcon = 'âœ…';
            let statusText = '';
            
            if (summary.successfulCustomers === summary.customersProcessed) {
              statusText = `All ${summary.customersProcessed} customers completed successfully!`;
            } else if (summary.successfulCustomers > 0) {
              statusIcon = 'âš ï¸';
              if (incompleteCount > 0) {
                statusText = `${summary.successfulCustomers} completed, ${incompleteCount} partially completed, ${failureCount} failed`;
              } else {
                statusText = `${summary.successfulCustomers} completed successfully, ${summary.failedCustomers} encountered issues`;
              }
            } else {
              statusIcon = 'âŒ';
              if (incompleteCount === summary.customersProcessed) {
                statusText = `All ${summary.customersProcessed} customers partially completed journeys`;
              } else {
                statusText = `${summary.customersProcessed} customers encountered issues (${incompleteCount} partial, ${failureCount} failed)`;
              }
            }
            
            simStatus.textContent = `${statusIcon} ${customerCount} Customer Journey Simulation Complete! ${statusText}`;
            
            const summaryText = [
              `Load Test Results:`,
              `â€¢ Customers Processed: ${summary.customersProcessed}`,
              `â€¢ Successful: ${summary.successfulCustomers}`,
              `â€¢ Failed: ${summary.failedCustomers}`, 
              `â€¢ Success Rate: ${summary.successRate}`,
              `â€¢ Average Completion Time: ${summary.averageCompletionTime}`,
              `â€¢ Average Steps Completed: ${summary.averageStepsCompleted}`,
              ``,
              `Correlation IDs: ${json.correlationIds ? json.correlationIds.slice(0, 3).join(', ') : 'N/A'}${json.correlationIds && json.correlationIds.length > 3 ? '...' : ''}`
            ];
            
            if (json.journeyExample) {
              summaryText.push(``, `Example Journey Execution:`, json.journeyExample.execution);
              summaryText.push(``, `Services Used: ${json.journeyExample.servicesUsed}`);
            }
            
            // Display formatted results
            const timestamp = new Date().toLocaleTimeString();
            flowResultsEl.innerHTML = `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; color: #ffffff;">
                <h4 style="color: #28a745; margin-top: 0;">ğŸ¯ Load Test Complete - ${timestamp}</h4>
                <div style="font-family: 'Courier New', monospace; line-height: 1.6; color: #ffffff;">
                  ${summaryText.join('<br>')}
                </div>
              </div>
            `;
            
          } else {
            // Handle single customer response - enhanced status reporting
            const journey = json.journey;
            const completedSteps = journey.steps.filter(step => step.status === 'completed').length;
            const errorSteps = journey.steps.filter(step => step.status === 'failed' || step.status === 'error').length;
            const totalSteps = journey.totalSteps || journey.steps.length;
            
            // ğŸ’¾ SAVE JOURNEY DATA FOR DASHBOARD DEPLOYMENT
            // Use journeyData from request (has complete config) or window.lastJourney as fallback
            console.log('[DEBUG] About to save journey data. Available sources:', {
              hasJourneyData: !!journeyData,
              hasWindowLastJourney: !!window.lastJourney,
              hasRequestBodyJourney: !!requestBody.journey
            });
            
            const journeyConfigForDashboard = journeyData || window.lastJourney || requestBody.journey;
            
            if (!journeyConfigForDashboard) {
              console.error('âŒ CRITICAL: No journey config available to save!');
            }
            
            window.currentJourneyData = {
              journey: journeyConfigForDashboard,  // Complete journey config with steps
              correlationId: journey.correlationId,
              executionResult: json  // Save the execution result too
            };
            
            console.log('âœ… Journey data saved to currentJourneyData for dashboard deployment:', {
              companyName: journeyConfigForDashboard?.companyName,
              stepsCount: journeyConfigForDashboard?.steps?.length,
              correlationId: journey.correlationId,
              hasStepsArray: Array.isArray(journeyConfigForDashboard?.steps),
              firstStepName: journeyConfigForDashboard?.steps?.[0]?.stepName
            });
            
            let statusMessage = '';
            if (errorSteps === 0) {
              statusMessage = `âœ… Journey Complete! All ${completedSteps} steps successful`;
            } else if (completedSteps > 0) {
              statusMessage = `âš ï¸ Journey Partial: ${completedSteps} successful steps, ${errorSteps} steps with errors`;
            } else {
              statusMessage = `âŒ Journey Failed: ${errorSteps} steps encountered errors`;
            }
            statusMessage += ` | Correlation: ${journey.correlationId}`;
            
            simStatus.textContent = statusMessage;
            
            const stepSummary = journey.steps.map((step, idx) => {
              let status = 'â“';
              if (step.status === 'completed') status = 'âœ…';
              else if (step.status === 'failed' || step.status === 'error') status = 'âŒ';
              else if (step.fallback) status = 'ğŸ”„';
              
              const serviceName = step.serviceName || (step.stepName + 'Service');
              const timing = step.processingTime ? `${step.processingTime}ms` : 'N/A';
              const errorInfo = step.error ? ` (${step.error})` : '';
              return `${status} Step ${idx + 1}: ${serviceName} (${timing})${errorInfo}`;
            }).join('\n');
            
            // ğŸ”§ ARCHITECTURAL IMPROVEMENT: Show actual error configuration from journey data
            const stepsWithErrorsConfigured = window.lastJourney?.steps?.filter(step => step.hasError === true).length || 0;
            const errorConfigDisplay = stepsWithErrorsConfigured > 0 
              ? `ğŸ”´ Error Simulation: ${stepsWithErrorsConfigured}/${totalSteps} steps configured with errors`
              : `âœ… Error Simulation: All steps configured for success`;
              
            const resultSummary = [
              `Customer Journey Execution (${errorConfigDisplay}):`,
              stepSummary,
              ``,
              `Summary: ${completedSteps} successful, ${errorSteps} errors, ${totalSteps} total steps`,
              `Services Used: ${journey.stepNames ? journey.stepNames.join(' â†’ ') : 'N/A'}`,
              `Correlation ID: ${journey.correlationId}`
            ];
            
            // Display formatted results
            const timestamp = new Date().toLocaleTimeString();
            flowResultsEl.innerHTML = `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; color: #ffffff;">
                <h4 style="color: #007bff; margin-top: 0;">ğŸš€ Journey Simulation Complete - ${timestamp}</h4>
                <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-line; color: #ffffff;">
                  ${resultSummary.join('\n')}
                </div>
              </div>
            `;
          }
          
        } else {
          simStatus.textContent = `âŒ Journey simulation failed: ${json.error}`;
          // Display formatted error results
          const timestamp = new Date().toLocaleTimeString();
          flowResultsEl.innerHTML = `
            <div style="background: #2d1b1b; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; color: #ffffff;">
              <h4 style="color: #dc3545; margin-top: 0;">âŒ Journey Simulation Failed - ${timestamp}</h4>
              <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">
                ${JSON.stringify(json, null, 2)}
              </div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Journey Simulation error:', error);
        simStatus.textContent = `âŒ Journey simulation error: ${error.message}`;
        // Display formatted catch error results
        const timestamp = new Date().toLocaleTimeString();
        flowResultsEl.innerHTML = `
          <div style="background: #2d1b1b; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; color: #ffffff;">
            <h4 style="color: #dc3545; margin-top: 0;">ğŸ’¥ Simulation Error - ${timestamp}</h4>
            <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">
              ${error.stack}
            </div>
          </div>
        `;
      } finally {
        runJourneySimBtn.disabled = false;
        runJourneySimBtn.textContent = 'ğŸš€ Step 4 - Run Journey Simulation';
      }
    };

    window.resetServices = async function() {
      console.log('Reset button clicked');
      const chainStatus = document.getElementById('chain-status');
      try {
        chainStatus.textContent = 'Resetting services and restarting essentials...';
        const res = await fetch('/api/admin/reset-and-restart', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: '{}' 
        });
        const json = await res.json();
        chainStatus.textContent = json.ok ? `âœ… ${json.message}` : `âŒ Reset failed: ${json.error || 'Unknown error'}`;
      } catch (e) {
        chainStatus.textContent = `âŒ Reset error: ${e.message}`;
      }
    };



    // Function to update service status display
    window.updateServiceStatus = async function() {
      console.log('ğŸ”„ updateServiceStatus called');
      
      try {
        
        console.log('ğŸ“¡ Fetching services and ports data...');
        
        // Fetch services data with timeout and better error handling
        let servicesData = { ok: false, services: [] };
        try {
          console.log('ğŸš€ Starting services API call...');
          const servicesController = new AbortController();
          const servicesTimeout = setTimeout(() => servicesController.abort(), 10000);
          
          const servicesRes = await fetch('/api/admin/services/status', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            signal: servicesController.signal
          });
          clearTimeout(servicesTimeout);
          servicesData = await servicesRes.json();
          console.log('ğŸ“Š Services API response:', servicesRes.status, servicesData);
        } catch (servicesError) {
          console.error('âŒ Services API error:', servicesError);
          servicesData = { ok: false, error: servicesError.message };
        }
        
        // Fetch ports data with timeout and better error handling
        let portsData = { ok: false };
        try {
          console.log('ğŸš€ Starting ports API call...');
          const portsController = new AbortController();
          const portsTimeout = setTimeout(() => portsController.abort(), 10000);
          
          const portsRes = await fetch('/api/admin/ports', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            signal: portsController.signal
          });
          clearTimeout(portsTimeout);
          portsData = await portsRes.json();
          console.log('ï¿½ Ports API response:', portsRes.status, portsData);
        } catch (portsError) {
          console.error('âŒ Ports API error:', portsError);
          portsData = { ok: false, error: portsError.message };
        }
        
        // Update service list with better error handling
        const servicesList = document.getElementById('service-status-list');
        const servicesLoading = document.getElementById('service-status-loading');
        const servicesListHeader = document.getElementById('service-status-list-header');
        const servicesLoadingHeader = document.getElementById('service-status-loading-header');
        
        if (servicesData.ok && servicesData.services && Array.isArray(servicesData.services) && servicesData.services.length > 0) {
          console.log(`âœ… Found ${servicesData.services.length} running services`);
          
          // Update main service list (if exists)
          if (servicesLoading && servicesList) {
            servicesLoading.classList.add('hidden');
            servicesList.classList.remove('hidden');
            servicesList.innerHTML = servicesData.services.map(service => 
              `<div class="flex justify-between items-center text-xs py-1">
                <div class="flex items-center gap-2 flex-1">
                  <span class="text-dtcyan truncate">${service.service || service.name || 'Unknown Service'}</span>
                  <span class="text-dtgreen">:${service.port || 'N/A'}</span>
                </div>
                <div class="flex gap-1">
                  <button onclick="resetService('${service.service || service.name}', ${service.port})" 
                          class="bg-dtyellow hover:bg-yellow-600 text-black px-2 py-1 rounded text-xs font-bold transition-all" 
                          title="Reset this service">ğŸ”„</button>
                  <button onclick="killService('${service.service || service.name}', ${service.port})" 
                          class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold transition-all" 
                          title="Kill this service">âŒ</button>
                </div>
              </div>`
            ).join('');
          }
          
          // Update header service list (if exists)
          if (servicesLoadingHeader && servicesListHeader) {
            servicesLoadingHeader.classList.add('hidden');
            servicesListHeader.classList.remove('hidden');
            servicesListHeader.innerHTML = servicesData.services.map(service => 
              `<div class="flex justify-between items-center">
                <span class="text-dtcyan">${(service.service || service.name || 'Unknown').substring(0, 12)}${(service.service || service.name || '').length > 12 ? '...' : ''}</span>
                <span class="text-dtgreen">:${service.port || 'N/A'}</span>
              </div>`
            ).join('');
          }

          // Update dropdown service list
          const servicesDropdownLoading = document.getElementById('service-status-loading-dropdown');
          const servicesDropdownList = document.getElementById('service-status-list-dropdown');
          const servicesCount = document.getElementById('services-count');
          
          if (servicesDropdownLoading && servicesDropdownList) {
            servicesDropdownLoading.classList.add('hidden');
            servicesDropdownList.classList.remove('hidden');
            servicesDropdownList.innerHTML = servicesData.services.map(service => {
              // ğŸ”§ IMPROVED SERVICE NAME FORMATTING
              const serviceName = service.service || service.name || 'Unknown Service';
              const stepName = service.stepName || serviceName;  // Use stepName if available
              
              // Clean up long service names for better readability
              let displayName = stepName;
              
              // If we have stepName and company, format nicely
              if (service.stepName && service.companyContext && service.companyContext.companyName !== 'unknown') {
                displayName = `${service.stepName} (${service.companyContext.companyName})`;
              } else if (serviceName.includes('-')) {
                // For names like "GroceryBrowseAndBasketBuildService-Asda"
                const parts = serviceName.split('-');
                if (parts.length >= 2) {
                  const serviceType = parts[0].replace(/Service$/, ''); // Remove "Service" suffix
                  const company = parts[1];
                  
                  // Add spaces before capital letters for readability
                  const readableServiceType = serviceType.replace(/([A-Z])/g, ' $1').trim();
                  displayName = `${readableServiceType} (${company})`;
                }
              } else if (serviceName.includes('Service')) {
                // For names like "DiscoveryService-DefaultCompany"
                displayName = serviceName.replace(/([A-Z])/g, ' $1').trim().replace('Service', '');
              }
              
              return `<div class="bg-dtgray rounded-lg p-3 border border-dtborder hover:border-dtcyan transition-all">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1 min-w-0 mr-3">
                    <div class="text-dtcyan text-sm font-semibold leading-tight break-words">${displayName}</div>
                    <div class="text-xs text-gray-400 mt-1 font-mono">
                      <span class="inline-block mr-3">ğŸ“¡ Port ${service.port || 'N/A'}</span>
                      <span class="inline-block">ğŸ”§ PID ${service.pid || 'N/A'}</span>
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <span class="bg-dtgreen text-black px-2 py-1 rounded-full text-xs font-bold inline-flex items-center">
                      <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span>
                      Running
                    </span>
                  </div>
                </div>
                <div class="text-xs text-gray-500 bg-black bg-opacity-30 rounded px-2 py-1 font-mono truncate" title="${serviceName}">
                  ${serviceName}
                </div>
              </div>`;
            }).join('');
          }
          
          // Update services count in button
          if (servicesCount) {
            servicesCount.textContent = `${servicesData.services.length} Services`;
          }
        } else {
          console.log('âš ï¸ No services found or API error:', servicesData);
          
          // Update main service list (if exists)
          if (servicesLoading && servicesList) {
            servicesLoading.classList.remove('hidden');
            servicesList.classList.add('hidden');
            
            if (servicesData.error) {
              servicesLoading.textContent = `Error: ${servicesData.error}`;
            } else if (!servicesData.ok) {
              servicesLoading.textContent = 'API connection failed - services may not be running';
            } else {
              servicesLoading.textContent = 'No services currently running';
            }
          }
          
          // Update header service list (if exists)
          if (servicesLoadingHeader && servicesListHeader) {
            servicesLoadingHeader.classList.remove('hidden');
            servicesListHeader.classList.add('hidden');
            servicesLoadingHeader.textContent = servicesData.error ? 'Error' : '0 running';
          }

          // Update dropdown service list
          const servicesDropdownLoading = document.getElementById('service-status-loading-dropdown');
          const servicesDropdownList = document.getElementById('service-status-list-dropdown');
          const servicesCount = document.getElementById('services-count');
          
          if (servicesDropdownLoading && servicesDropdownList) {
            servicesDropdownLoading.classList.remove('hidden');
            servicesDropdownList.classList.add('hidden');
            
            if (servicesData.error) {
              servicesDropdownLoading.textContent = `Error: ${servicesData.error}`;
            } else if (!servicesData.ok) {
              servicesDropdownLoading.textContent = 'API connection failed - services may not be running';
            } else {
              servicesDropdownLoading.textContent = 'No services currently running';
            }
          }
          
          // Update services count in button
          if (servicesCount) {
            servicesCount.textContent = servicesData.error ? 'Error' : '0 Services';
          }
        }
        
        // Update port status with better error handling
        if (portsData.ok && portsData.portStatus) {
          console.log('ğŸ”Œ Updating port status display');
          const totalPortsEl = document.getElementById('total-ports');
          const availablePortsEl = document.getElementById('available-ports');
          const allocatedPortsEl = document.getElementById('allocated-ports');
          const portRangeEl = document.getElementById('port-range');
          
          if (totalPortsEl) totalPortsEl.textContent = portsData.portStatus.total || '0';
          if (availablePortsEl) availablePortsEl.textContent = portsData.portStatus.available || '0';
          if (allocatedPortsEl) allocatedPortsEl.textContent = portsData.portStatus.allocated || '0';
          if (portRangeEl) portRangeEl.textContent = portsData.portStatus.range || 'N/A';
        } else {
          console.log('âŒ Port status data unavailable:', portsData);
          // Show fallback values when ports API fails (only if elements exist)
          const totalPortsEl = document.getElementById('total-ports');
          const availablePortsEl = document.getElementById('available-ports');
          const allocatedPortsEl = document.getElementById('allocated-ports');
          const portRangeEl = document.getElementById('port-range');
          
          if (totalPortsEl) totalPortsEl.textContent = 'Error';
          if (availablePortsEl) availablePortsEl.textContent = 'Error';
          if (allocatedPortsEl) allocatedPortsEl.textContent = 'Error';
          if (portRangeEl) portRangeEl.textContent = 'Error';
        }
        
        // Update last refresh time
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const lastUpdateEl = document.getElementById('last-update-time');
        if (lastUpdateEl) {
          lastUpdateEl.textContent = `Updated: ${timeString}`;
        }
        
        console.log('âœ… Service status update completed successfully');
        
      } catch (e) {
        console.error('âŒ Error updating service status:', e);
        const servicesLoading = document.getElementById('service-status-loading');
        if (servicesLoading) {
          servicesLoading.textContent = `Connection error: ${e.message}`;
          servicesLoading.classList.remove('hidden');
        }
        
        // Show error in port status too (only if elements exist)
        const totalPortsEl = document.getElementById('total-ports');
        const availablePortsEl = document.getElementById('available-ports');
        const allocatedPortsEl = document.getElementById('allocated-ports');
        const portRangeEl = document.getElementById('port-range');
        
        if (totalPortsEl) totalPortsEl.textContent = 'Error';
        if (availablePortsEl) availablePortsEl.textContent = 'Error';
        if (allocatedPortsEl) allocatedPortsEl.textContent = 'Error';
        if (portRangeEl) portRangeEl.textContent = 'Error';
      } finally {
        // Service status update completed
        console.log('ğŸ”„ Service status refresh finished');
      }
    };

    // ============ SERVICE MANAGEMENT DASHBOARD ============
    
    let currentDashboardTab = 'services';
    let dashboardRefreshInterval = null;
    
    /**
     * Switch dashboard tabs
     */
    window.switchDashboardTab = function(tabName) {
      currentDashboardTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.dashboard-tab').forEach(btn => {
        btn.classList.remove('active', 'bg-dtcyan', 'text-black');
        btn.classList.add('bg-dtgray', 'text-gray-400');
      });
      document.getElementById(`tab-${tabName}`)?.classList.add('active', 'bg-dtcyan', 'text-black');
      document.getElementById(`tab-${tabName}`)?.classList.remove('bg-dtgray', 'text-gray-400');
      
      // Hide all content
      document.getElementById('dashboard-content-services')?.classList.add('hidden');
      document.getElementById('dashboard-content-loadtests')?.classList.add('hidden');
      document.getElementById('dashboard-content-history')?.classList.add('hidden');
      
      // Show selected content
      document.getElementById(`dashboard-content-${tabName}`)?.classList.remove('hidden');
      
      // Refresh content based on tab
      if (tabName === 'services') {
        refreshServicesTab();
      } else if (tabName === 'loadtests') {
        refreshLoadTestsTab();
      } else if (tabName === 'history') {
        refreshHistoryTab();
      }
    };
    
    /**
     * Open the comprehensive service dashboard modal
     */
    window.openServiceDashboard = async function() {
      console.log('ğŸ“Š Opening Service Management Dashboard');
      const modal = document.getElementById('service-dashboard-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        await refreshServiceDashboard();
        
        // Start auto-refresh every 5 seconds
        if (dashboardRefreshInterval) {
          clearInterval(dashboardRefreshInterval);
        }
        console.log('â° Starting dashboard auto-refresh (5s interval)');
        dashboardRefreshInterval = setInterval(async () => {
          console.log('ğŸ”„ Auto-refreshing dashboard...');
          await refreshServiceDashboard();
        }, 5000);
      }
    };
    
    /**
     * Close the service dashboard modal
     */
    window.closeServiceDashboard = function(event) {
      // If event is provided and target is the modal itself (not a child), close it
      if (event && event.target.id !== 'service-dashboard-modal') {
        return;
      }
      
      const modal = document.getElementById('service-dashboard-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // Stop auto-refresh
        if (dashboardRefreshInterval) {
          console.log('â¹ï¸ Stopping dashboard auto-refresh');
          clearInterval(dashboardRefreshInterval);
          dashboardRefreshInterval = null;
        }
      }
    };
    
    /**
     * Refresh the service dashboard with latest data
     */
    window.refreshServiceDashboard = async function() {
      console.log('ğŸ”„ Refreshing Service Dashboard...');
      
      const loadingEl = document.getElementById('service-dashboard-loading');
      loadingEl?.classList.remove('hidden');
      
      try {
        // Fetch load test status
        const loadTestRes = await fetch('/api/admin/loadtest/status');
        const loadTestData = await loadTestRes.json();
        document.getElementById('stat-active-loadtests').textContent = loadTestData.count || 0;
        
        // Refresh current tab
        if (currentDashboardTab === 'services') {
          await refreshServicesTab();
        } else if (currentDashboardTab === 'loadtests') {
          await refreshLoadTestsTab();
        } else if (currentDashboardTab === 'history') {
          await refreshHistoryTab();
        }
        
        loadingEl?.classList.add('hidden');
      } catch (error) {
        console.error('âŒ Error refreshing dashboard:', error);
        loadingEl?.classList.add('hidden');
      }
    };
    
    /**
     * Refresh Services Tab â€” with action toolbar (dropdowns for stop by service/company/industry/all)
     */
    window.refreshServicesTab = async function() {
      const contentEl = document.getElementById('dashboard-content-services');
      const emptyEl = document.getElementById('service-dashboard-empty');
      const loadingEl = document.getElementById('service-dashboard-loading');
      
      contentEl?.classList.add('hidden');
      emptyEl?.classList.add('hidden');
      
      try {
        const response = await fetch('/api/admin/services/by-company');
        if (!response.ok) throw new Error('Failed to fetch services');
        
        const data = await response.json();
        console.log('ğŸ“Š Service data received:', data);
        
        // Update stats
        document.getElementById('stat-total-companies').textContent = data.totalCompanies || 0;
        document.getElementById('stat-running-services').textContent = data.totalRunningServices || 0;
        document.getElementById('stat-total-services').textContent = data.totalServices || 0;
        
        // Check if empty
        if (!data.companies || data.companies.length === 0) {
          if (loadingEl) loadingEl.classList.add('hidden');
          if (emptyEl) emptyEl.classList.remove('hidden');
          return;
        }
        
        // Store full data for cascading filter logic
        window._svcDashboardData = data;
        
        // Build cascading filter toolbar
        const companyNames = data.companies.map(c => c.companyName).sort();
        
        const toolbarHtml = `
          <div class="bg-dtgray rounded-xl border-2 border-dtborder p-4 mb-6">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-lg">ğŸ”</span>
              <h3 class="text-sm font-bold text-white uppercase tracking-wider">Filter Services</h3>
              <span class="text-xs text-gray-500 ml-auto">${data.totalRunningServices} services across ${data.totalCompanies} companies</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              
              <!-- Filter 1: Company -->
              <div class="bg-dtcard rounded-lg border border-dtborder p-3">
                <label class="text-xs text-dtcyan font-semibold block mb-1.5">ğŸ¢ Company</label>
                <select id="svc-filter-company" onchange="svcFilterCompanyChanged()" class="w-full bg-dtgray border border-dtborder rounded-lg p-2 text-white text-sm focus:border-dtcyan outline-none">
                  <option value="">All Companies</option>
                  ${companyNames.map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>
              </div>
              
              <!-- Filter 2: Industry (populated based on company) -->
              <div class="bg-dtcard rounded-lg border border-dtborder p-3">
                <label class="text-xs text-dtyellow font-semibold block mb-1.5">ğŸ­ Industry</label>
                <select id="svc-filter-industry" onchange="svcFilterIndustryChanged()" class="w-full bg-dtgray border border-dtborder rounded-lg p-2 text-white text-sm focus:border-dtcyan outline-none">
                  <option value="">All Industries</option>
                </select>
              </div>
              
              <!-- Filter 3: Individual Service (populated based on industry) -->
              <div class="bg-dtcard rounded-lg border border-dtborder p-3">
                <label class="text-xs text-dtgreen font-semibold block mb-1.5">ğŸ”§ Service</label>
                <select id="svc-filter-service" onchange="svcFilterServiceChanged()" class="w-full bg-dtgray border border-dtborder rounded-lg p-2 text-white text-sm focus:border-dtcyan outline-none">
                  <option value="">All Services</option>
                </select>
              </div>
            </div>
           </div>
          
          <!-- Global Actions -->
          <div class="bg-gradient-to-r from-red-900 to-red-700 rounded-xl border-2 border-red-500 p-4 mb-6">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl">âš ï¸</span>
                <div>
                  <h3 class="text-sm font-bold text-white uppercase tracking-wider">Global Actions</h3>
                  <p class="text-xs text-red-200 mt-0.5">Stop services across company, industry, or everything</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="svcStopByCompany()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-red-400">
                  ğŸ¢ Stop by Company
                </button>
                <button onclick="svcStopByIndustry()" class="bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border border-red-400">
                  ğŸ­ Stop by Industry
                </button>
                <button onclick="svcStopEverything()" class="bg-red-900 hover:bg-red-800 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all border-2 border-red-300 shadow-lg">
                  ğŸ’€ STOP EVERYTHING
                </button>
              </div>
            </div>
          </div>
        `;
        
        if (contentEl) {
          contentEl.innerHTML = toolbarHtml + '<div id="svc-filtered-content"></div>';
          contentEl.classList.remove('hidden');
          // Initialize cascading filters and render
          svcFilterCompanyChanged();
        }
        if (loadingEl) loadingEl.classList.add('hidden');
        
        console.log('âœ… Service Dashboard refreshed successfully');
        
      } catch (error) {
        console.error('âŒ Error refreshing service dashboard:', error);
        if (loadingEl) loadingEl.classList.add('hidden');
        if (contentEl) {
          contentEl.innerHTML = `
            <div class="text-center py-12">
              <div class="text-6xl mb-4">âŒ</div>
              <div class="text-xl text-red-500 mb-2">Failed to Load Services</div>
              <p class="text-sm text-gray-400">${error.message}</p>
              <button onclick="refreshServiceDashboard()" class="mt-4 bg-dtpurple hover:bg-dtcyan text-white hover:text-black px-6 py-2 rounded-lg font-bold transition-all">
                ğŸ”„ Retry
              </button>
            </div>
          `;
          contentEl.classList.remove('hidden');
        }
      }
    };
    
    /**
     * Format time ago helper
     */
    function timeAgo(ms) {
      if (!ms) return 'Never';
      const seconds = Math.floor(ms / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }
    
    /**
     * Stop individual service
     */
    window.stopService = async function(serviceName) {
      if (!confirm(`Stop service ${serviceName}?`)) return;
      
      try {
        const response = await fetch('/api/admin/services/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serviceName })
        });
        
        if (!response.ok) throw new Error('Failed to stop service');
        
        const data = await response.json();
        alert(`âœ… Service ${serviceName} stopped`);
        await refreshServiceDashboard();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Stop all services for a company
     */
    window.stopCompanyServices = async function(companyName) {
      if (!confirm(`Stop ALL services for ${companyName}?`)) return;
      
      try {
        const response = await fetch('/api/admin/services/stop-by-company', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyName })
        });
        
        if (!response.ok) throw new Error('Failed to stop services');
        
        const data = await response.json();
        alert(`âœ… Stopped ${data.stoppedServices.length} services for ${companyName}`);
        await refreshServiceDashboard();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Service Controls â€” Global action handlers
     */
    window.svcStopByCompany = async function() {
      const data = window._svcDashboardData;
      if (!data || !data.companies || data.companies.length === 0) {
        alert('No companies with running services found!');
        return;
      }
      
      // Build list of companies
      const companies = data.companies.map(c => c.companyName).sort();
      const companyName = prompt(`Enter company name to stop all its services:\n\nAvailable: ${companies.join(', ')}`, companies[0] || '');
      
      if (!companyName) return;
      if (!companies.includes(companyName)) {
        alert(`Company "${companyName}" not found. Available: ${companies.join(', ')}`);
        return;
      }
      
      await stopCompanyServices(companyName);
    };
    
    window.svcStopByIndustry = async function() {
      const data = window._svcDashboardData;
      if (!data || !data.companies || data.companies.length === 0) {
        alert('No services running!');
        return;
      }
      
      // Build list of unique industries
      const industries = [...new Set(data.companies.map(c => c.industryType || 'unknown'))].sort();
      const industryType = prompt(`Enter industry type to stop all its services:\n\nAvailable: ${industries.join(', ')}`, industries[0] || '');
      
      if (!industryType) return;
      if (!industries.includes(industryType)) {
        alert(`Industry "${industryType}" not found. Available: ${industries.join(', ')}`);
        return;
      }
      
      if (!confirm(`Stop ALL services for the "${industryType}" industry?`)) return;
      
      try {
        const response = await fetch('/api/admin/services/stop-by-industry', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ industryType })
        });
        
        if (!response.ok) throw new Error('Failed to stop services');
        
        const data = await response.json();
        alert(`âœ… Stopped ${data.stoppedServices.length} services for industry "${industryType}"`);
        await refreshServiceDashboard();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    window.svcStopEverything = async function() {
      if (!confirm('âš ï¸ STOP EVERYTHING?\n\nThis will kill ALL services, load tests, and generators across every company on the server.')) return;
      if (!confirm('Are you sure? This cannot be undone.')) return;
      
      try {
        const response = await fetch('/api/admin/services/stop-everything', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Failed to stop everything');
        
        const data = await response.json();
        alert('ğŸ’€ Everything stopped!\n\nAll services, load tests, and generators have been terminated.');
        await refreshServiceDashboard();
        if (window.updateServiceStatus) updateServiceStatus();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Cascading filter: Company changed â†’ update Industry dropdown â†’ update Service dropdown â†’ render
     */
    window.svcFilterCompanyChanged = function() {
      const data = window._svcDashboardData;
      if (!data) return;
      
      const companyVal = document.getElementById('svc-filter-company')?.value || '';
      const industrySelect = document.getElementById('svc-filter-industry');
      const serviceSelect = document.getElementById('svc-filter-service');
      
      // Filter companies
      const filtered = companyVal 
        ? data.companies.filter(c => c.companyName === companyVal)
        : data.companies;
      
      // Populate industry dropdown based on filtered companies
      const industries = [...new Set(filtered.map(c => c.industryType || 'unknown'))].sort();
      if (industrySelect) {
        industrySelect.innerHTML = '<option value="">All Industries</option>' +
          industries.map(i => `<option value="${i}">${i.charAt(0).toUpperCase() + i.slice(1)}</option>`).join('');
      }
      
      // Reset service dropdown
      if (serviceSelect) {
        serviceSelect.innerHTML = '<option value="">All Services</option>';
      }
      
      // Cascade to industry change (which cascades to service + render)
      svcFilterIndustryChanged();
    };
    
    /**
     * Cascading filter: Industry changed â†’ update Service dropdown â†’ render
     */
    window.svcFilterIndustryChanged = function() {
      const data = window._svcDashboardData;
      if (!data) return;
      
      const companyVal = document.getElementById('svc-filter-company')?.value || '';
      const industryVal = document.getElementById('svc-filter-industry')?.value || '';
      const serviceSelect = document.getElementById('svc-filter-service');
      
      // Filter companies by selected company & industry
      let filtered = data.companies;
      if (companyVal) filtered = filtered.filter(c => c.companyName === companyVal);
      if (industryVal) filtered = filtered.filter(c => (c.industryType || 'unknown') === industryVal);
      
      // Collect all services from filtered companies
      const allServices = [];
      filtered.forEach(c => {
        c.services.forEach(s => {
          allServices.push({ name: s.serviceName, display: `${s.displayName} (${c.companyName})` });
        });
      });
      
      // Populate service dropdown
      if (serviceSelect) {
        serviceSelect.innerHTML = '<option value="">All Services</option>' +
          allServices.map(s => `<option value="${s.name}">${s.display}</option>`).join('');
      }
      
      // Render filtered results
      svcRenderFilteredServices();
    };
    
    /**
     * Cascading filter: Service changed â†’ render
     */
    window.svcFilterServiceChanged = function() {
      svcRenderFilteredServices();
    };
    
    /**
     * Render service cards based on current filter state
     */
    window.svcRenderFilteredServices = function() {
      const data = window._svcDashboardData;
      if (!data) return;
      
      const companyVal = document.getElementById('svc-filter-company')?.value || '';
      const industryVal = document.getElementById('svc-filter-industry')?.value || '';
      const serviceVal = document.getElementById('svc-filter-service')?.value || '';
      const container = document.getElementById('svc-filtered-content');
      if (!container) return;
      
      // Apply filters
      let companies = data.companies;
      if (companyVal) companies = companies.filter(c => c.companyName === companyVal);
      if (industryVal) companies = companies.filter(c => (c.industryType || 'unknown') === industryVal);
      
      // If a specific service is selected, filter services within companies
      if (serviceVal) {
        companies = companies.map(c => ({
          ...c,
          services: c.services.filter(s => s.serviceName === serviceVal)
        })).filter(c => c.services.length > 0);
      }
      
      if (companies.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="text-4xl mb-3">ğŸ”</div>
            <div class="text-gray-400">No services match the selected filters</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = companies.map(company => `
        <div class="bg-dtgray rounded-xl border-2 border-dtborder overflow-hidden mb-4">
          <!-- Company Header -->
          <div class="bg-gradient-to-r from-dtpurple to-dtblue p-4">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                  <span>ğŸ¢</span>
                  ${company.companyName}
                  <span class="text-xs bg-black bg-opacity-30 px-2 py-0.5 rounded-full text-gray-300 font-normal">${company.industryType || 'unknown'}</span>
                </h3>
                <div class="text-sm text-gray-300 mt-1">
                  ${company.services.length} service${company.services.length !== 1 ? 's' : ''} shown
                  ${company.totalRequests > 0 ? ` Â· ${company.totalRequests} requests` : ''}
                  ${company.totalErrors > 0 ? ` Â· <span class="text-red-400">${company.totalErrors} errors</span>` : ''}
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right mr-2">
                  <div class="text-2xl font-bold text-dtgreen">${company.runningServices}</div>
                  <div class="text-xs text-gray-300">Active</div>
                </div>
                <button onclick="stopCompanyServices('${company.companyName}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all">
                  ğŸ›‘ Stop All
                </button>
              </div>
            </div>
          </div>
          
          <!-- Services -->
          <div class="p-4">
            <div class="grid grid-cols-1 gap-3">
              ${company.services.map(service => {
                const statusColor = service.status === 'running' ? 'dtgreen' : 'gray-500';
                const healthColor = service.healthStatus === 'healthy' ? 'dtgreen' : 
                                   service.healthStatus === 'unhealthy' ? 'yellow-500' : 
                                   service.healthStatus === 'stopped' ? 'gray-500' : 'red-500';
                const healthIcon = service.healthStatus === 'healthy' ? 'âœ…' : 
                                  service.healthStatus === 'unhealthy' ? 'âš ï¸' : 
                                  service.healthStatus === 'stopped' ? 'â¹ï¸' : 'âŒ';
                
                return `
                  <div class="bg-dtcard rounded-lg p-4 border border-dtborder hover:border-dtcyan transition-all">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <!-- Service Info -->
                      <div>
                        <div class="text-dtcyan font-bold mb-1">${service.displayName}</div>
                        <div class="text-xs text-gray-400 font-mono truncate">${service.serviceName}</div>
                        <div class="flex items-center gap-2 mt-2">
                          <span class="bg-${statusColor} text-black px-2 py-1 rounded-full text-xs font-bold">
                            ${service.status.toUpperCase()}
                          </span>
                          <span class="text-${healthColor} text-xs font-bold flex items-center gap-1">
                            ${healthIcon} ${service.healthStatus}
                          </span>
                        </div>
                      </div>
                      
                      <!-- Metrics -->
                      <div class="grid grid-cols-2 gap-3 text-xs">
                        <div>
                          <div class="text-gray-400">Port</div>
                          <div class="text-white font-mono">ğŸ“¡ ${service.port}</div>
                        </div>
                        <div>
                          <div class="text-gray-400">PID</div>
                          <div class="text-white font-mono">ğŸ”§ ${service.pid}</div>
                        </div>
                        <div>
                          <div class="text-gray-400">Uptime</div>
                          <div class="text-dtcyan font-bold">â±ï¸ ${service.uptimeFormatted}</div>
                        </div>
                        <div>
                          <div class="text-gray-400">Requests</div>
                          <div class="text-white font-bold">ğŸ“Š ${service.requests}</div>
                        </div>
                      </div>
                      
                      <!-- Performance + Stop -->
                      <div class="grid grid-cols-2 gap-3 text-xs">
                        <div>
                          <div class="text-gray-400">Avg Response</div>
                          <div class="text-dtgreen font-bold">${service.avgResponseTime}ms</div>
                        </div>
                        <div>
                          <div class="text-gray-400">Error Rate</div>
                          <div class="text-${service.errors > 0 ? 'red-500' : 'dtgreen'} font-bold">
                            ${service.errorRate}%
                          </div>
                        </div>
                        <div>
                          <div class="text-gray-400">Errors</div>
                          <div class="text-${service.errors > 0 ? 'red-500' : 'white'} font-bold">
                            ${service.errors > 0 ? 'âŒ' : 'âœ…'} ${service.errors}
                          </div>
                        </div>
                        <div>
                          <button onclick="stopService('${service.serviceName}')" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs font-bold transition-all w-full">
                            ğŸ›‘ Stop
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `).join('');
    };
    
    /**
     * Refresh Load Tests Tab
     */
    window.refreshLoadTestsTab = async function() {
      const contentEl = document.getElementById('dashboard-content-loadtests');
      
      try {
        const response = await fetch('/api/admin/loadtest/status');
        if (!response.ok) throw new Error('Failed to fetch load tests');
        
        const data = await response.json();
        
        const html = data.activeTests.length === 0 ? `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">âš¡</div>
            <div class="text-xl text-gray-400 mb-2">No Load Tests Running</div>
            <p class="text-sm text-gray-500">Start a load test from the form below</p>
          </div>
        ` : data.activeTests.map(test => `
          <div class="bg-dtgray rounded-xl border border-dtborder p-4">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-lg font-bold text-dtcyan">âš¡ ${test.companyName}</h4>
                <div class="text-sm text-gray-400 mt-1">
                  Scenario: ${test.scenarioType} â€¢ PID: ${test.pid} â€¢ Uptime: ${Math.floor(test.uptime / 60)}m
                </div>
              </div>
              <button onclick="stopLoadTest('${test.companyName}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition-all">
                ğŸ›‘ Stop
              </button>
            </div>
          </div>
        `).join('');
        
        const formHtml = `
          <div class="bg-dtcard rounded-xl border-2 border-dtcyan p-6 mt-6">
            <h4 class="text-lg font-bold text-dtcyan mb-4">â–¶ï¸ Start New Load Test</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input id="loadtest-company" type="text" placeholder="Company Name" class="bg-dtgray border border-dtborder rounded-lg px-4 py-2 text-white">
              <select id="loadtest-scenario" class="bg-dtgray border border-dtborder rounded-lg px-4 py-2 text-white">
                <option value="light-load">Light Load</option>
                <option value="medium-load">Medium Load</option>
                <option value="heavy-load">Heavy Load</option>
              </select>
              <button onclick="startLoadTest()" class="bg-dtgreen hover:bg-green-600 text-black px-6 py-2 rounded-lg font-bold transition-all">
                â–¶ï¸ Start
              </button>
            </div>
          </div>
        `;
        
        contentEl.innerHTML = html + formHtml;
        contentEl.classList.remove('hidden');
      } catch (error) {
        console.error('âŒ Error refreshing load tests:', error);
        contentEl.innerHTML = `<div class="text-red-500">Failed to load: ${error.message}</div>`;
        contentEl.classList.remove('hidden');
      }
    };
    
    /**
     * Start load test
     */
    window.startLoadTest = async function() {
      const companyName = document.getElementById('loadtest-company').value;
      const scenarioType = document.getElementById('loadtest-scenario').value;
      
      if (!companyName) {
        alert('Please enter a company name');
        return;
      }
      
      try {
        const response = await fetch('/api/admin/loadtest/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyName, scenarioType })
        });
        
        if (!response.ok) throw new Error('Failed to start load test');
        
        const data = await response.json();
        alert(`âœ… Load test started for ${companyName}`);
        document.getElementById('loadtest-company').value = '';
        await refreshLoadTestsTab();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Stop load test
     */
    window.stopLoadTest = async function(companyName) {
      if (!confirm(`Stop load test for ${companyName}?`)) return;
      
      try {
        const response = await fetch('/api/admin/loadtest/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyName })
        });
        
        if (!response.ok) throw new Error('Failed to stop load test');
        
        alert(`âœ… Load test stopped for ${companyName}`);
        await refreshLoadTestsTab();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Refresh History Tab
     */
    window.refreshHistoryTab = async function() {
      try {
        // Fetch user saved configs
        const historyRes = await fetch('/api/admin/services/history');
        const historyData = await historyRes.json();
        
        const userSelect = document.getElementById('user-saved-configs');
        userSelect.innerHTML = '<option value="">Select configuration...</option>';
        
        if (historyData.success && historyData.configurations) {
          historyData.configurations.forEach((config, idx) => {
            const option = document.createElement('option');
            option.value = config.timestamp;
            option.textContent = `Config ${idx + 1} - ${new Date(config.timestamp).toLocaleString()} (${config.runningServices.length} services)`;
            userSelect.appendChild(option);
          });
        }
        
        // Load default prompts from localStorage
        const defaultSelect = document.getElementById('default-prompts');
        defaultSelect.innerHTML = '<option value="">Select prompt...</option>';
        
        const prompts = JSON.parse(localStorage.getItem('saved_prompts') || '[]');
        prompts.forEach((prompt, idx) => {
          const option = document.createElement('option');
          option.value = idx;
          option.textContent = prompt.name || prompt.companyName || `Prompt ${idx + 1}`;
          defaultSelect.appendChild(option);
        });
        
        // Add change listeners for preview
        userSelect.onchange = showConfigPreview;
        defaultSelect.onchange = showPromptPreview;
      } catch (error) {
        console.error('âŒ Error refreshing history:', error);
      }
    };
    
    /**
     * Show configuration preview
     */
    window.showConfigPreview = async function() {
      const select = document.getElementById('user-saved-configs');
      const timestamp = select.value;
      const previewDiv = document.getElementById('config-preview');
      
      if (!timestamp) {
        previewDiv.innerHTML = `
          <div class="text-center text-gray-400 py-12">
            <div class="text-6xl mb-4">ğŸ‘ˆ</div>
            <div class="text-xl mb-2">Select a Configuration</div>
            <p class="text-sm">Choose a saved config or default prompt to preview</p>
          </div>`;
        return;
      }
      
      try {
        const response = await fetch('/api/admin/services/history');
        const data = await response.json();
        
        if (data.success) {
          const config = data.configurations.find(c => c.timestamp === timestamp);
          if (config) {
            const date = new Date(config.timestamp);
            previewDiv.innerHTML = `
              <div class="space-y-4">
                <div class="bg-dtcard rounded-lg p-4 border border-dtcyan">
                  <div class="text-dtcyan font-bold mb-2">â±ï¸ Saved: ${date.toLocaleString()}</div>
                  <div class="text-sm text-gray-300">Services: ${config.runningServices.length}</div>
                </div>
                
                <div class="bg-dtcard rounded-lg p-4">
                  <h4 class="font-bold text-white mb-3">ğŸ”§ Running Services:</h4>
                  <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${config.runningServices.map(service => `
                      <div class="flex items-center gap-2 text-sm">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                        <span class="text-white font-mono">${service.serviceName}</span>
                        <span class="text-gray-400">:${service.port}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error showing config preview:', error);
      }
    };
    
    /**
     * Show prompt preview
     */
    window.showPromptPreview = function() {
      const select = document.getElementById('default-prompts');
      const index = select.value;
      const previewDiv = document.getElementById('config-preview');
      
      if (index === '') {
        previewDiv.innerHTML = `
          <div class="text-center text-gray-400 py-12">
            <div class="text-6xl mb-4">ğŸ‘ˆ</div>
            <div class="text-xl mb-2">Select a Configuration</div>
            <p class="text-sm">Choose a saved config or default prompt to preview</p>
          </div>`;
        return;
      }
      
      const prompts = JSON.parse(localStorage.getItem('saved_prompts') || '[]');
      const prompt = prompts[parseInt(index)];
      
      if (prompt) {
        previewDiv.innerHTML = `
          <div class="space-y-4">
            <div class="bg-dtcard rounded-lg p-4 border border-dtyellow">
              <div class="text-dtyellow font-bold mb-2">ğŸ“š ${prompt.name || prompt.companyName || 'Default Prompt'}</div>
              <div class="text-sm text-gray-300">Journey: ${prompt.journeyType || 'N/A'}</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${prompt.companyName ? `
                <div class="bg-dtcard rounded-lg p-3">
                  <div class="text-xs text-gray-400 mb-1">Company</div>
                  <div class="text-white font-mono">${prompt.companyName}</div>
                </div>
              ` : ''}
              ${prompt.sector ? `
                <div class="bg-dtcard rounded-lg p-3">
                  <div class="text-xs text-gray-400 mb-1">Sector</div>
                  <div class="text-white">${prompt.sector}</div>
                </div>
              ` : ''}
              ${prompt.industryType ? `
                <div class="bg-dtcard rounded-lg p-3">
                  <div class="text-xs text-gray-400 mb-1">Industry</div>
                  <div class="text-white">${prompt.industryType}</div>
                </div>
              ` : ''}
              ${prompt.numServices ? `
                <div class="bg-dtcard rounded-lg p-3">
                  <div class="text-xs text-gray-400 mb-1">Services</div>
                  <div class="text-white">${prompt.numServices}</div>
                </div>
              ` : ''}
            </div>
            
            ${prompt.fullPrompt ? `
              <div class="bg-dtcard rounded-lg p-4">
                <div class="text-xs text-gray-400 mb-2">Prompt:</div>
                <div class="text-sm text-white leading-relaxed max-h-48 overflow-y-auto">
                  ${prompt.fullPrompt.substring(0, 500)}${prompt.fullPrompt.length > 500 ? '...' : ''}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }
    };
    
    /**
     * Save current configuration
     */
    window.saveCurrentConfig = async function() {
      try {
        const response = await fetch('/api/admin/services/save-config', {
          method: 'POST'
        });
        
        if (!response.ok) throw new Error('Failed to save configuration');
        
        const data = await response.json();
        alert(`âœ… Configuration saved! (${data.config.services.length} services)`);
        await refreshHistoryTab();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Delete user configuration
     */
    window.deleteUserConfig = async function() {
      const select = document.getElementById('user-saved-configs');
      const timestamp = select.value;
      
      if (!timestamp) {
        alert('Please select a configuration to delete');
        return;
      }
      
      if (!confirm('Delete this configuration? This action cannot be undone.')) return;
      
      try {
        const response = await fetch('/api/admin/services/history/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ timestamp })
        });
        
        if (!response.ok) throw new Error('Failed to delete configuration');
        
        const data = await response.json();
        alert(data.message || 'âœ… Configuration deleted');
        await refreshHistoryTab();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };

    /**
     * Restore user configuration
     */
    window.restoreUserConfig = async function() {
      const select = document.getElementById('user-saved-configs');
      const timestamp = select.value;
      
      if (!timestamp) {
        alert('Please select a configuration to restore');
        return;
      }
      
      if (!confirm('Restore this configuration? This will start the services.')) return;
      
      try {
        const response = await fetch('/api/admin/services/restore', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ timestamp })
        });
        
        if (!response.ok) throw new Error('Failed to restore configuration');
        
        const data = await response.json();
        alert(data.message);
        await refreshServiceDashboard();
      } catch (error) {
        alert(`âŒ Error: ${error.message}`);
      }
    };
    
    /**
     * Load default prompt
     */
    window.loadDefaultPrompt = function() {
      const select = document.getElementById('default-prompts');
      const idx = select.value;
      
      if (idx === null || idx === undefined) {
        alert('Please select a prompt to load');
        return;
      }
      
      const prompts = JSON.parse(localStorage.getItem('saved_prompts') || '[]');
      const prompt = prompts[parseInt(idx)];
      
      if (!prompt) {
        alert('Prompt not found');
        return;
      }
      
      // Load prompt data into form
      if (prompt.companyName) document.getElementById('company-name')?.setValue(prompt.companyName);
      if (prompt.domain) document.getElementById('company-domain')?.setValue(prompt.domain);
      if (prompt.industryType) document.getElementById('industry-type')?.setValue(prompt.industryType);
      if (prompt.journeyDescription) document.getElementById('journey-description')?.setValue(prompt.journeyDescription);
      
      alert(`âœ… Loaded: ${prompt.name || 'Prompt'}`);
      closeServiceDashboard();
    };


    // Service Management Functions (all use working backend endpoints)

    // LoadRunner Integration Functions
    let currentTestId = null;
    let testPollingInterval = null;

    // Add delay utility function for LoadRunner testing
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    window.startLoadRunnerTest = async function() {
      const startBtn = document.getElementById('agent-start-loadrunner-test');
      const statusEl = document.getElementById('agent-loadrunner-test-status');
      const resultsEl = document.getElementById('agent-loadrunner-results');
      const profileSelect = document.getElementById('agent-loadrunner-profile');
      const durationInput = document.getElementById('agent-loadrunner-duration');

      try {
        if (!lastJourney || !lastJourney.steps || !lastJourney.steps.length) {
          statusEl.textContent = 'âš ï¸ No journey available! Please select a journey in AI Agent Hub.';
          statusEl.className = 'text-xs text-red-400 font-medium min-h-[80px]';
          return;
        }

        startBtn.disabled = true;
        startBtn.textContent = 'ğŸ”„ Starting Test...';
        statusEl.textContent = 'ğŸš€ Initializing LoadRunner test...';
        statusEl.className = 'text-xs text-dtyellow font-medium min-h-[80px]';
        resultsEl.classList.add('hidden');

        // Get error configuration from AI Load panel
        const errorsPerTransaction = parseFloat(document.getElementById('agent-errors-per-transaction')?.value || 0.1);
        const regenerateEvery = parseInt(document.getElementById('agent-regenerate-every')?.value || 100);
        
        const errorConfig = {
          errors_per_transaction: errorsPerTransaction,
          errors_per_visit: errorsPerTransaction * 0.01, // 1% of per-transaction rate
          errors_per_minute: errorsPerTransaction * 0.5, // Derived value
          regenerate_every_n_transactions: regenerateEvery
        };

        const testConfig = {
          testProfile: profileSelect.value,
          durationMinutes: parseInt(durationInput.value) || 10,
          errorConfig: errorConfig
        };
        
        console.log('LoadRunner test payload:', {
          journeyConfig: lastJourney,
          errorConfig: errorConfig,
          ...testConfig
        });

        const response = await fetch('/api/loadrunner/start-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            journeyConfig: lastJourney,
            errorSimulationEnabled: errorSimulationEnabled,
            ...testConfig
          })
        });

        console.log('LoadRunner response status:', response.status);
        console.log('LoadRunner response ok:', response.ok);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (result.success) {
          currentTestId = result.testId;
          const errorModeStatus = errorSimulationEnabled ? 'ğŸ”´ With Errors' : 'âœ… Error-Free Mode';
          statusEl.innerHTML = `
            âœ… Test started successfully!<br>
            ğŸ“Š Method: ${result.method}<br>
            â±ï¸ Duration: ${result.estimatedDuration}<br>
            ğŸ¯ Mode: ${errorModeStatus}<br>
            ğŸ†” Test ID: ${result.testId.substring(0, 8)}...
          `;
          statusEl.className = 'text-xs text-dtgreen font-medium min-h-[80px]';
          
          startBtn.textContent = 'ğŸƒ Test Running...';
          
          // Start polling for test status
          startTestPolling();
        } else {
          throw new Error(result.error || 'Failed to start test');
        }

      } catch (error) {
        console.error('LoadRunner test error:', error);
        console.error('Error details:', error.message, error.stack);
        
        let errorMessage = 'Unknown error occurred';
        if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Network connection failed - check server status';
        } else if (error.message.includes('HTTP')) {
          errorMessage = error.message;
        } else {
          errorMessage = error.message;
        }
        
        statusEl.textContent = `âŒ Error: ${errorMessage}`;
        statusEl.className = 'text-xs text-red-400 font-medium min-h-[80px]';
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ Start LoadRunner Test';
      }
    };

    window.stopLoadRunnerTest = async function() {
      if (!currentTestId) return;

      try {
        const response = await fetch(`/api/loadrunner/stop/${currentTestId}`, {
          method: 'POST'
        });

        const result = await response.json();
        
        if (result.success) {
          var statusEl = document.getElementById('agent-loadrunner-test-status');
          if (statusEl) {
            statusEl.textContent = 'â¹ï¸ Test stopped by user';
            statusEl.className = 'text-xs text-dtyellow font-medium min-h-[80px]';
          }
          stopTestPolling();
          resetLoadRunnerUI();
        }
      } catch (error) {
        console.error('Error stopping test:', error);
      }
    };

    window.viewLoadRunnerResults = async function() {
      if (!currentTestId) return;

      try {
        const response = await fetch(`/api/loadrunner/results/${currentTestId}`);
        
        if (response.ok) {
          const resultsWindow = window.open('', '_blank');
          const resultsHtml = await response.text();
          resultsWindow.document.write(resultsHtml);
          resultsWindow.document.close();
        } else {
          alert('Test results not yet available. Please wait for the test to complete.');
        }
      } catch (error) {
        console.error('Error viewing results:', error);
        alert('Error loading test results');
      }
    };

    function startTestPolling() {
      if (testPollingInterval) clearInterval(testPollingInterval);
      
      testPollingInterval = setInterval(async () => {
        if (!currentTestId) return;

        try {
          const response = await fetch(`/api/loadrunner/status/${currentTestId}`);
          const status = await response.json();

          if (status.success) {
            updateTestStatus(status);
            
            if (status.status === 'completed' || status.status === 'failed' || status.status === 'stopped') {
              stopTestPolling();
              showTestResults(status);
            }
          }
        } catch (error) {
          console.error('Error polling test status:', error);
        }
      }, 5000); // Poll every 5 seconds
    }

    function stopTestPolling() {
      if (testPollingInterval) {
        clearInterval(testPollingInterval);
        testPollingInterval = null;
      }
    }

    function updateTestStatus(status) {
      const statusEl = document.getElementById('agent-loadrunner-test-status');
      if (!statusEl) return;
      const elapsedTime = status.startTime ? 
        Math.floor((new Date() - new Date(status.startTime)) / 1000) : 0;
      
      statusEl.innerHTML = `
        ğŸƒ Test in progress...<br>
        ğŸ“Š Method: ${status.method}<br>
        â±ï¸ Elapsed: ${Math.floor(elapsedTime / 60)}:${(elapsedTime % 60).toString().padStart(2, '0')}<br>
        ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}<br>
        ğŸ¯ Company: ${status.journeyConfig.companyName}<br>
        ğŸ“‹ Steps: ${status.journeyConfig.stepCount}
      `;
      statusEl.className = 'text-xs text-dtblue font-medium min-h-[80px]';
    }

    function showTestResults(status) {
      const statusEl = document.getElementById('agent-loadrunner-test-status');
      const resultsEl = document.getElementById('agent-loadrunner-results');
      const summaryEl = document.getElementById('agent-loadrunner-summary');
      if (!statusEl) return;

      if (status.status === 'completed') {
        statusEl.innerHTML = `
          âœ… Test completed successfully!<br>
          â±ï¸ Duration: ${status.testConfig.duration / 60} minutes<br>
          ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}<br>
          ğŸ“Š Method: ${status.method}
        `;
        statusEl.className = 'text-xs text-dtgreen font-medium min-h-[80px]';

        if (summaryEl) {
          summaryEl.innerHTML = `
            <div class="text-xs space-y-1">
              <div>Company: <span class="text-dtcyan">${status.journeyConfig.companyName}</span></div>
              <div>Journey Steps: <span class="text-dtcyan">${status.journeyConfig.stepCount}</span></div>
              <div>Virtual Users: <span class="text-dtcyan">${status.testConfig.virtualUsers}</span></div>
              <div>Test Duration: <span class="text-dtcyan">${status.testConfig.duration / 60} minutes</span></div>
              <div>Status: <span class="text-dtgreen">âœ… Completed</span></div>
            </div>
          `;
        }

        if (resultsEl) resultsEl.classList.remove('hidden');
      } else {
        statusEl.innerHTML = `
          âŒ Test ${status.status}<br>
          â±ï¸ Duration: ${status.testConfig.duration / 60} minutes<br>
          ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}
        `;
        statusEl.className = 'text-xs text-red-400 font-medium min-h-[80px]';
      }

      resetLoadRunnerUI();
    }

    function resetLoadRunnerUI() {
      const startBtn = document.getElementById('agent-start-loadrunner-test');
      if (startBtn) {
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ Start LoadRunner Test';
      }
    }

    // Handle generation method change
    document.getElementById('generationMethod').addEventListener('change', (e) => {
      const copilotWorkflow = document.getElementById('copilotWorkflow');
      const templateExample = document.getElementById('templateExample');
      const customStepsContainer = document.getElementById('customStepsContainer');
      const optionalFieldsContainer = document.getElementById('optionalFieldsContainer');
      const journeyForm = document.getElementById('journey-form');
      
      if (e.target.value === 'copilot') {
        copilotWorkflow.classList.remove('hidden');
        templateExample.classList.add('hidden');
        // In Copilot mode: show basic form fields, hide template-specific fields
        journeyForm.classList.remove('hidden');
        customStepsContainer.style.display = 'none';
        optionalFieldsContainer.style.display = 'none';
        generateCopilotPrompt();
      } else {
        copilotWorkflow.classList.add('hidden');
        templateExample.classList.remove('hidden');
        // In Template mode: show all form fields except journey requirements
        journeyForm.classList.remove('hidden');
        customStepsContainer.style.display = 'block';
        optionalFieldsContainer.style.display = 'block';
        journeyRequirementsContainer.style.display = 'none';
        
        // Pre-fill form fields with retail example values
        document.getElementById('companyName').value = 'ShopMart';
        document.getElementById('domain').value = 'shopmart.com';
        document.getElementById('industryType').value = 'retail';
        document.getElementById('customSteps').value = 'Product Discovery, Product Selection, Cart Addition, Checkout Process, Order Confirmation, Post Purchase';
        document.getElementById('journeyType').value = 'E-commerce Purchase';
        document.getElementById('details').value = 'Customer journey for online retail shopping experience';
      }
    });

    // Add event listeners to form inputs to auto-update prompt
    document.getElementById('companyName').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });
    
    document.getElementById('domain').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });
    // Additional Fields listeners
    let additionalFields = [];

    // Helper functions for industry-specific data (moved up to be available early)
    function getIndustryDemographic(industry) {
      const demographics = {
        'telecommunications': 'mobile users aged 25-45',
        'banking': 'working professionals aged 30-55',
        'retail': 'consumers aged 18-65',
        'travel': 'leisure travelers aged 25-60',
        'insurance': 'policy holders aged 25-50',
        'healthcare': 'patients aged 20-70',
        'education': 'learners aged 18-40',
        'technology': 'tech professionals aged 25-45'
      };
      return demographics[industry.toLowerCase()] || 'general consumers';
    }

    function getIndustryPainPoints(industry) {
      const painPoints = {
        'telecommunications': ['poor network coverage', 'expensive bills'],
        'banking': ['complex fees', 'poor customer service'],
        'retail': ['high prices', 'limited selection'],
        'travel': ['complicated booking', 'hidden fees'],
        'insurance': ['confusing policies', 'high premiums'],
        'healthcare': ['long wait times', 'complex scheduling'],
        'education': ['course complexity', 'time constraints'],
        'technology': ['learning curve', 'integration challenges']
      };
      return painPoints[industry.toLowerCase()] || ['complexity', 'cost'];
    }

    function getIndustryGoals(industry, company) {
      const goals = {
        'telecommunications': ['reliable connectivity', 'value for money'],
        'banking': ['financial security', 'easy banking'],
        'retail': ['quality products', 'good prices'],
        'travel': ['smooth booking', 'great experience'],
        'insurance': ['comprehensive coverage', 'fair pricing'],
        'healthcare': ['quality care', 'convenient access'],
        'education': ['skill development', 'career advancement'],
        'technology': ['improved efficiency', 'seamless integration']
      };
      return goals[industry.toLowerCase()] || ['good service', 'value for money'];
    }

    function getIndustryValue(industry) {
      const values = {
        'telecommunications': 2000,
        'banking': 5000,
        'retail': 1500,
        'travel': 3000,
        'insurance': 4000,
        'healthcare': 2500,
        'education': 1800,
        'technology': 3500
      };
      return values[industry.toLowerCase()] || 2000;
    }

    function getIndustryLocation(industry) {
      const locations = {

        'retail': 'Manchester, UK',
        'travel': 'Edinburgh, UK',
        'insurance': 'Birmingham, UK',
        'healthcare': 'Leeds, UK',
        'education': 'Oxford, UK',
        'technology': 'Cambridge, UK'
      };
      return locations[industry.toLowerCase()] || 'Global';
    }

    function getIndustryConversion(industry) {
      const conversions = {
        'telecommunications': 0.65,
        'banking': 0.45,
        'retail': 0.75,
        'travel': 0.55,
        'insurance': 0.35,
        'healthcare': 0.60,
        'education': 0.50,
        'technology': 0.40
      };
      return conversions[industry.toLowerCase()] || 0.50;
    }

    function getIndustryTags(industry) {
      const tags = {
        'telecommunications': ['mobile', 'connectivity'],
        'banking': ['finance', 'security'],
        'retail': ['shopping', 'products'],
        'travel': ['booking', 'leisure'],
        'insurance': ['protection', 'coverage'],
        'healthcare': ['wellness', 'care'],
        'education': ['learning', 'skills'],
        'technology': ['innovation', 'efficiency']
      };
      return tags[industry.toLowerCase()] || ['service', 'quality'];
    }
    function renderAdditionalFields() {
      const list = document.getElementById('additionalFieldsList');
      list.innerHTML = '';
      additionalFields.forEach((field, idx) => {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center mb-1';
        div.innerHTML = `<span class="text-xs text-dtcyan">${field.name}</span><span class="text-xs text-gray-400">(${field.type})</span><button type="button" class="bg-dtpurple text-white px-2 py-0 rounded text-xs" data-remove="${idx}">Remove</button>`;
        list.appendChild(div);
      });
      Array.from(list.querySelectorAll('button[data-remove]')).forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.getAttribute('data-remove'));
          additionalFields.splice(idx, 1);
          renderAdditionalFields();
          generateCopilotPrompt();
        };
      });
    }
    document.getElementById('addFieldBtn').onclick = () => {
      const name = document.getElementById('newFieldName').value.trim();
      const type = document.getElementById('newFieldType').value;
      if (!name) return;
      additionalFields.push({ name, type });
      document.getElementById('newFieldName').value = '';
      document.getElementById('newFieldType').value = 'string';
      renderAdditionalFields();
      generateCopilotPrompt();
    };
    


    document.getElementById('journeyRequirements').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });

    document.getElementById('customSteps').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });

  // Generate Copilot Prompt
    function generateCopilotPrompt() {
      console.log('generateCopilotPrompt called');
      
      try {
        const companyName = document.getElementById('companyName')?.value || '[Company Name]';
        const domain = document.getElementById('domain')?.value || '[company-domain.com]';
        const journeyRequirements = document.getElementById('journeyRequirements')?.value || '[Journey Requirements]';
        
        console.log('Debug - Company:', companyName, 'Domain:', domain);
        console.log('Debug - Journey Requirements:', journeyRequirements);
        console.log('Generating prompts...');



        // Generate Copilot Prompt 1: Business Observability Context Analysis
        const csuitePrompt = `${companyName} at ${domain} is the focus for this chat.

You are a Business Observability specialist creating realistic customer journey simulations for application monitoring and business analytics platforms.

Your goal is to analyze ${companyName}'s digital business model to create accurate observability scenarios with proper business events, revenue tracking, and customer experience metrics that would be monitored in production.

Focus on ${companyName}'s digital touchpoints and business-critical user flows that generate measurable business outcomes. Analyze their:

**DIGITAL BUSINESS ARCHITECTURE:**
1. **Primary Revenue Streams**: What are their main monetization methods and typical transaction values?
2. **Critical User Journeys**: What are the 3 most important customer flows that drive revenue?
3. **Journey Classification**: What specific industry type and concise journey names describe their flows (e.g. "Trial Signup", "Purchase Journey")?
4. **Technology Stack**: What platforms, APIs, and services likely power their digital experience?

**OBSERVABILITY REQUIREMENTS:**
1. **Business Events**: What key business moments should be tracked (purchases, signups, upgrades, cancellations)?
2. **Revenue Attribution**: How do customer actions translate to measurable business value?
3. **Experience Metrics**: What user experience indicators impact their business outcomes?

**MONITORING PRIORITIES:**
1. **Performance Impact**: Which slow services would hurt their revenue most?
2. **Error Consequences**: What failures would cause immediate business loss?
3. **Conversion Tracking**: What steps in their funnel need observability data?

Return a structured analysis focusing on:
- Specific business events that need monitoring
- Revenue impact of different user actions
- Technology dependencies that affect customer experience
- Realistic conversion rates and transaction values for their industry
- Key performance indicators that matter for their business model

Base your analysis on publicly available information about ${companyName}'s business model, but focus on practical observability scenarios rather than generic business strategy.`;

        // Generate Copilot Prompt 2: Business Observability Journey Simulation
        const journeyPrompt = `Create a business observability customer journey JSON for ${companyName} (${domain}) based on your previous analysis.

ğŸ¯ SPECIFIC JOURNEY REQUIREMENTS: "${journeyRequirements}"

The customer journey MUST model the exact observability scenario described above. Design realistic business events, user interactions, and measurable outcomes that would appear in application monitoring dashboards and business analytics platforms.

âš ï¸ CRITICAL: Must include duration fields and business value tracking or response will be rejected âš ï¸

Return JSON with this structure:
{
  "journey": {
    "companyName": "${companyName}",
    "domain": "${domain}",
    "industryType": "[Use industry from C-suite analysis]",
    "journeyType": "[Concise journey name like 'Trial Signup', 'Purchase Journey', 'Subscription Flow']",
    "journeyDetail": "[Same as journeyType - concise 2-3 word description]",
    "journeyId": "journey_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_2025",
    "journeyStartTime": "2025-11-21T00:00:00.000Z",
    "steps": [
      {
        "stepIndex": 1,
        "stepName": "[IndustrySpecificStepName]",
        "serviceName": "[IndustrySpecificStepNameService]",
        "description": "[What happens in this step]",
        "category": "[StepCategory]",
        "timestamp": "2025-11-21T00:00:00.000Z",
        "estimatedDuration": "[realistic_minutes]",
        "businessRationale": "[Why this duration for this industry]",
        "substeps": [
          {"substepName": "[substep description]", "duration": "[minutes]"},
          {"substepName": "[substep description]", "duration": "[minutes]"}
        ]
      }
    ]
  },
  "customerProfile": {
    "userId": "user_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_001",
    "email": "testuser@${domain.replace(/^https?:\/\//, '').replace(/^www\./, '')}",
    "userSegment": "[High-value|Standard|New - based on ${companyName}'s segmentation]",
    "digitalBehaviorPattern": "[How they typically interact with ${companyName}]",
    "businessValueTier": "[Revenue potential of this user type]",
    "experienceExpectations": "[Performance and UX standards they expect]",
    "conversionLikelihood": "[Probability of completing business goal]",
    "technologyProfile": "[Device preferences, browser, connectivity affecting UX]"
  },
  "traceMetadata": {
    "correlationId": "trace_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_2025",
    "sessionId": "session_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_001",
    "businessContext": {
      "campaignSource": "[e.g. Organic Search, Paid Search, Social Media]",
      "customerSegment": "[e.g. premium, standard, enterprise]",
      "businessValue": "[e.g. Â£1,250]",
      "revenueImpact": "[e.g. Â£450 per customer]",
      "transactionAmount": "[e.g. Â£89.99]"
    }
  },
  "additionalFields": {
    "<<DYNAMICALLY GENERATE 20-40 fields based on your C-suite analysis, the industry, and this specific journey. Each field name should be camelCase. Use your knowledge of ${companyName}'s business model to create fields that would appear in real observability dashboards.

FIELD TYPE MIX â€” use all of these where applicable:
- REVENUE: numeric currency values (e.g. transactionValue: 67.49)
- METRIC: numeric decimals/integers for rates, scores, percentages (e.g. conversionRate: 0.72, netPromoterScore: 65)
- STRING: descriptive text, categories, statuses (e.g. loyaltyStatus: 'vip', pricingTier: 'Gold')
- PRODUCT ARRAYS: arrays of product names, SKUs, prices, and categories that represent the items in this journey (e.g. productName: ['Widget Pro', 'Widget Lite'], productSKU: ['SKU-WP-001', 'SKU-WL-002'], productPrice: [29.99, 19.99], productCategory: ['Electronics', 'Accessories'])

ARRAY RULES:
- Product-related fields MUST be arrays with 2-5 items representing realistic products for ${companyName}
- Parallel arrays must have the same length (e.g. if productName has 3 items, productSKU and productPrice must also have 3)
- Use industry-appropriate product names, SKU formats, and price points
- Other fields that naturally have multiple values may also be arrays (e.g. paymentMethods: ['card', 'paypal'], deliveryOptions: ['standard', 'express'])

Include fields for: revenue/financial data, customer behaviour, conversion metrics, risk/compliance, operational efficiency, product details (as arrays), engagement scores, and any industry-specific KPIs relevant to this journey.>>"
  }
}

Requirements:
- Create exactly 6 business-critical steps that generate measurable business events
- Every step needs estimatedDuration (minutes) and businessRationale explaining revenue/experience impact
- Every substep needs duration (minutes) - substeps must add up to step duration
- ServiceName = StepName + 'Service' in PascalCase format (for microservice architecture)
- Use realistic durations that match industry performance expectations
- Only step 1 needs timestamp field
- Replace ALL placeholders with actual values based on ${companyName}'s business model
- **CRITICAL: Set industryType to specific industry (e.g. "Cloud Software", "Streaming Media", "E-commerce")**
- **CRITICAL: Set journeyType and journeyDetail to concise 2-3 word journey name (e.g. "Trial Signup", "Purchase Journey", "Support Request")**
- **CRITICAL: additionalFields must be 20-40 key-value pairs â€” no nested objects. Dynamically generate field names based on this company and journey. Product-related fields (names, SKUs, prices, categories) MUST be parallel arrays with 2-5 items. Other fields are flat scalars. Each field must have a real value, not a placeholder.**
- **Field type rules: Revenue fields = numeric (e.g. 67.49), Metric fields = numeric (e.g. 0.72), String fields = text (e.g. "premium"), Product fields = identifiers (e.g. "SKU-001")**
- Focus on user actions that create business value and generate observable events
- Include realistic business metrics: conversion rates, transaction values, performance thresholds
- All business values should be realistic for their industry and market position
- All percentage values should be numeric (e.g. 0.72 not "72%")
- Durations must be numeric integers, not strings
- Focus on scenarios that would appear in business observability dashboards

Return the response in JSON code format that can be copied from this UI

âš ï¸ BUSINESS EVENT TRACKING REQUIRED: Each step must produce measurable business outcomes âš ï¸`;

        console.log('Setting prompt text 1:', csuitePrompt.substring(0, 100) + '...');
        console.log('Setting prompt text 2:', journeyPrompt.substring(0, 100) + '...');
        
        const promptText1Element = document.getElementById('promptText1-step2');
        const promptText2Element = document.getElementById('promptText2-step2');
        
        if (promptText1Element) {
          promptText1Element.value = csuitePrompt;
          console.log('Prompt 1 set successfully, length:', csuitePrompt.length);
        } else {
          console.error('promptText1-step2 element not found!');
        }
        
        if (promptText2Element) {
          promptText2Element.value = journeyPrompt;
          console.log('Prompt 2 set successfully, length:', journeyPrompt.length);
        } else {
          console.error('promptText2-step2 element not found!');
        }

        // Keep backward compatibility with old promptText element
        const promptTextElement = document.getElementById('promptText');
        if (promptTextElement) {
          promptTextElement.value = csuitePrompt + '\n\n---\n\n' + journeyPrompt;
        console.log('Prompt set successfully, length:', prompt.length);
        // Force a visual refresh
        promptTextElement.style.display = 'none';
        promptTextElement.offsetHeight; // trigger reflow
        promptTextElement.style.display = '';
      } else {
        console.error('promptText element not found!');
      }
      } catch (error) {
        console.error('Error generating prompt:', error);
        const promptTextElement = document.getElementById('promptText');
        if (promptTextElement) {
          promptTextElement.value = 'Error generating prompt. Please refresh the page.';
        }
      }
    }

    // Add event listeners to update prompt when fields change
    ['companyName', 'domain'].forEach(fieldId => {
      document.getElementById(fieldId).addEventListener('input', () => {
        if (document.getElementById('generationMethod').value === 'copilot') {
          generateCopilotPrompt();
        }
      });
    });

    // Industry-specific step name generation
    function getIndustrySpecificSteps(industry, company) {
      const steps = {
        'telecommunications': ['Discovery', 'PlanExploration', 'ServiceSelection', 'AccountSetup', 'ServiceActivation', 'PostActivation'],
        'banking': ['Discovery', 'ProductExploration', 'ApplicationStart', 'IdentityVerification', 'AccountOpening', 'FirstTransaction'],
        'retail': ['Discovery', 'ProductBrowsing', 'ItemSelection', 'Checkout', 'OrderConfirmation', 'PostPurchase'],
        'travel': ['Discovery', 'DestinationExploration', 'BookingSelection', 'ReservationProcess', 'BookingConfirmation', 'TripManagement'],
        'insurance': ['Discovery', 'QuoteExploration', 'PolicySelection', 'ApplicationProcess', 'PolicyIssuance', 'PolicyManagement'],
        'healthcare': ['Discovery', 'ServiceExploration', 'AppointmentScheduling', 'Registration', 'ServiceDelivery', 'FollowUp'],
        'education': ['Discovery', 'CourseExploration', 'EnrollmentProcess', 'Registration', 'LearningStart', 'ProgressTracking'],
        'technology': ['Discovery', 'FeatureExploration', 'TrialSignup', 'Implementation', 'GoLive', 'Optimization']
      };
      return steps[industry.toLowerCase()] || ['Discovery', 'Exploration', 'Selection', 'ProcessStart', 'Completion', 'PostProcess'];
    }

    function getIndustryExample(industry, company, domain) {
      const examples = {
        'telecommunications': '{"searchTerm": "' + company + ' mobile plans", "referrer": "google", "device": "mobile"}',
        'banking': '{"searchTerm": "' + company + ' savings account", "referrer": "google", "device": "desktop"}',
        'retail': '{"searchTerm": "' + company + ' products", "referrer": "social", "device": "mobile"}',
        'travel': '{"searchTerm": "' + company + ' flights", "referrer": "google", "device": "tablet"}',
        'insurance': '{"searchTerm": "' + company + ' car insurance", "referrer": "comparison", "device": "desktop"}',
        'healthcare': '{"searchTerm": "' + company + ' appointments", "referrer": "direct", "device": "mobile"}',
        'education': '{"searchTerm": "' + company + ' courses", "referrer": "google", "device": "desktop"}',
        'technology': '{"searchTerm": "' + company + ' software", "referrer": "google", "device": "desktop"}'
      };
      return examples[industry.toLowerCase()] || '{"searchTerm": "' + company + '", "referrer": "google", "device": "mobile"}';
    }

    // COMPLETELY REWRITTEN COPY FUNCTIONALITY
    function setupCopyButtons() {
      console.log('ğŸ”§ Setting up copy buttons with new method...');
      
      // Modern copy function that actually works
      async function copyToClipboard(text) {
        console.log('ğŸ“‹ Attempting to copy:', text.length, 'characters');
        
        try {
          // Try modern clipboard API first
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            console.log('âœ… Copied with modern API');
            return true;
          }
        } catch (err) {
          console.log('Modern API failed, trying fallback:', err);
        }
        
        // Fallback method
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          
          // Make the textarea visible but off-screen
          textArea.style.position = 'absolute';
          textArea.style.left = '-9999px';
          textArea.style.top = '0';
          textArea.style.width = '1px';
          textArea.style.height = '1px';
          textArea.style.opacity = '0';
          
          document.body.appendChild(textArea);
          
          // Focus and select all text
          textArea.focus();
          textArea.select();
          textArea.setSelectionRange(0, text.length);
          
          // Try to copy
          const result = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (result) {
            console.log('âœ… Copied with fallback method');
            return true;
          } else {
            console.log('âŒ Fallback method failed');
            return false;
          }
        } catch (err) {
          console.error('âŒ All copy methods failed:', err);
          return false;
        }
      }
      
      // Direct button setup without waiting
      console.log('ğŸ”§ Setting up copy buttons immediately...');
      
      // Copy Prompt 1
      const btn1 = document.getElementById('copyPrompt1');
      if (btn1) {
        btn1.onclick = async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ¯ Copy Prompt 1 clicked!');
          
          const textarea = document.getElementById('promptText1');
          if (!textarea || !textarea.value.trim()) {
            alert('Please generate the prompts first! Fill in Company Name and Domain, then click "Generate Copilot Prompts".');
            return;
          }
          
          const success = await copyToClipboard(textarea.value);
          if (success) {
            const original = btn1.textContent;
            btn1.textContent = 'âœ… Copied!';
            btn1.style.backgroundColor = '#10b981';
            setTimeout(() => {
              btn1.textContent = original;
              btn1.style.backgroundColor = '';
            }, 2000);
          } else {
            alert('Copy failed! Please manually select and copy the text from the textarea below.');
          }
        };
        console.log('âœ… Button 1 setup complete');
      }
      
      // Copy Prompt 2  
      const btn2 = document.getElementById('copyPrompt2');
      if (btn2) {
        btn2.onclick = async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ¯ Copy Prompt 2 clicked!');
          
          const textarea = document.getElementById('promptText2');
          if (!textarea || !textarea.value.trim()) {
            alert('Please generate the prompts first! Fill in Company Name and Domain, then click "Generate Copilot Prompts".');
            return;
          }
          
          const success = await copyToClipboard(textarea.value);
          if (success) {
            const original = btn2.textContent;
            btn2.textContent = 'âœ… Copied!';
            btn2.style.backgroundColor = '#10b981';
            setTimeout(() => {
              btn2.textContent = original;
              btn2.style.backgroundColor = '';
            }, 2000);
          } else {
            alert('Copy failed! Please manually select and copy the text from the textarea below.');
          }
        };
        console.log('âœ… Button 2 setup complete');
      }
    }

    // Process Copilot Response - Fixed to ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const processBtn = document.getElementById('processResponse');
      if (processBtn) {
        console.log('âœ… Process button found, attaching event listener');
        processBtn.addEventListener('click', () => {
          console.log('ğŸš€ Step 4 - Process button clicked');
          const responseText = document.getElementById('copilotResponse').value.trim();
          console.log('Response text length:', responseText.length);
          
          if (!responseText) {
            alert('Please paste your Copilot response first');
            return;
          }

          try {
            const parsedResponse = JSON.parse(responseText);
            if (parsedResponse.journey && parsedResponse.journey.steps) {
              // ğŸ”§ UPDATE FORM FIELDS: Extract metadata from journey and populate form
              const journey = parsedResponse.journey;
              if (journey.companyName) {
                const companyField = document.getElementById('companyName');
                if (companyField) companyField.value = journey.companyName;
              }
              if (journey.domain) {
                const domainField = document.getElementById('domain');
                if (domainField) domainField.value = journey.domain;
              }
              if (journey.industryType) {
                const industryField = document.getElementById('industryType');
                if (industryField) industryField.value = journey.industryType;
              }
              if (journey.journeyType) {
                const journeyTypeField = document.getElementById('journeyType');
                if (journeyTypeField) journeyTypeField.value = journey.journeyType;
              }
              console.log('âœ… Form fields updated:', {
                companyName: journey.companyName,
                domain: journey.domain,
                industryType: journey.industryType,
                journeyType: journey.journeyType
              });
              
              // Set the global variables for journey simulation with complete data
              lastJourney = {
                ...parsedResponse.journey,
                additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
                customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
                traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
              };
              currentJourneyData = parsedResponse;

              // Display journey with additional fields info
              const displayData = {
                journey: parsedResponse.journey,
                customerProfile: parsedResponse.customerProfile,
                traceMetadata: parsedResponse.traceMetadata,
                additionalFields: parsedResponse.additionalFields
              };

              // Get elements by ID to ensure they exist
              const journeyOutputEl = document.getElementById('journey-output');
              const journeyProviderEl = document.getElementById('journey-provider');
              const journeySourcesEl = document.getElementById('journey-sources');
              
              console.log('Setting journey output...');

              if (journeyOutputEl) {
                journeyOutputEl.textContent = JSON.stringify(displayData, null, 2);
                console.log('âœ… Journey output set, length:', journeyOutputEl.textContent.length);
              } else {
                console.error('âŒ journey-output element not found');
              }
              
              if (journeyProviderEl) {
                journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
              } else {
                console.error('âŒ journey-provider element not found');
              }
              
              if (journeySourcesEl) {
                journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
              } else {
                console.error('âŒ journey-sources element not found');
              }

              const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
              alert('Journey processed successfully! Includes ' + fieldsCount + ' additional tracking fields.');
            } else {
              alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
            }
          } catch (error) {
            console.error('JSON Parse Error:', error);
            alert('Invalid JSON format. Error: ' + error.message);
          }
        });
      } else {
        console.error('âŒ Process button not found!');
      }
    });

    // Reset Workflow - RESTORED ORIGINAL LOGIC
    document.getElementById('resetWorkflow').addEventListener('click', () => {
      console.log('ğŸ”„ Reset workflow clicked');
      document.getElementById('copilotResponse').value = '';
      
      const journeyOutputEl = document.getElementById('journey-output');
      const journeyProviderEl = document.getElementById('journey-provider');  
      const journeySourcesEl = document.getElementById('journey-sources');
      
      if (journeyOutputEl) journeyOutputEl.textContent = '';
      if (journeyProviderEl) journeyProviderEl.textContent = '';
      if (journeySourcesEl) journeySourcesEl.innerHTML = '';
      
      if (typeof generateCopilotPrompt === 'function') {
        generateCopilotPrompt();
      }
    });

    // Generate Journey (Both Template and Copilot Mode)
    document.getElementById('generateJourney').addEventListener('click', async () => {
      const generationMethod = document.getElementById('generationMethod').value;
      
      if (generationMethod === 'copilot') {
        // For Copilot mode, create a basic journey structure with the provided requirements
        const companyName = document.getElementById('companyName').value || 'YourCompany';
        const domain = document.getElementById('domain').value || 'yourcompany.com';
        const industryType = document.getElementById('industryType').value || 'general';
        const journeyRequirements = document.getElementById('journeyRequirements').value || 'Standard customer journey';
        
        // Create a simple journey structure for simulation with proper service names
        const basicJourney = {
          companyName,
          domain,
          industryType,
          steps: [
            { 
              stepName: 'Discovery', 
              description: 'Initial customer discovery',
              serviceName: 'DiscoveryService',
              substeps: [{ serviceName: 'DiscoveryService' }]
            },
            { 
              stepName: 'Awareness', 
              description: 'Customer becomes aware',
              serviceName: 'AwarenessService',
              substeps: [{ serviceName: 'AwarenessService' }]
            },
            { 
              stepName: 'Consideration', 
              description: 'Customer considers options',
              serviceName: 'ConsiderationService',
              substeps: [{ serviceName: 'ConsiderationService' }]
            },
            { 
              stepName: 'Purchase', 
              description: 'Customer makes purchase',
              serviceName: 'PurchaseService',
              substeps: [{ serviceName: 'PurchaseService' }]
            },
            { 
              stepName: 'Retention', 
              description: 'Customer retention activities',
              serviceName: 'RetentionService',
              substeps: [{ serviceName: 'RetentionService' }]
            },
            { 
              stepName: 'Advocacy', 
              description: 'Customer becomes advocate',
              serviceName: 'AdvocacyService',
              substeps: [{ serviceName: 'AdvocacyService' }]
            }
          ],
          requirements: journeyRequirements
        };
        
        lastJourney = basicJourney;
        currentJourneyData = { journey: basicJourney };
        journeyOutput.textContent = JSON.stringify({ journey: basicJourney }, null, 2);
        setupFlowButtons();
        alert('Basic journey structure created! You can now simulate this journey or use the Copilot workflow above for AI-generated journeys.');
        return;
      }

      // Template mode logic - Generate ShopMart retail example locally
      const companyName = document.getElementById('companyName').value || 'ShopMart';
      const domain = document.getElementById('domain').value || 'shopmart.com';
      const industryType = document.getElementById('industryType').value || 'retail';
      const customStepsInput = document.getElementById('customSteps').value.trim();
      
      // Use custom steps if provided, otherwise use default retail steps
      const steps = customStepsInput ? 
        customStepsInput.split(',').map(step => step.trim()).filter(step => step) :
        ['Product Discovery', 'Product Selection', 'Add to Cart', 'Checkout Process', 'Payment Processing', 'Order Confirmation'];
      
      const retailJourney = {
        companyName,
        domain,
        industryType,
        journeyId: `journey_${Date.now()}`,
        steps: steps.map((stepName, index) => ({
          stepName,
          serviceName: stepName.replace(/\s+/g, '') + 'Service',
          description: `Customer ${stepName.toLowerCase()} step`,
          order: index + 1,
          endpoints: [`/${stepName.toLowerCase().replace(/\s+/g, '-')}`],
          substeps: [{ serviceName: stepName.replace(/\s+/g, '') + 'Service' }],
          metadata: {
            stepType: 'retail',
            processingTime: Math.floor(Math.random() * 200) + 100,
            businessValue: Math.floor(Math.random() * 500) + 100
          }
        })),
        provider: 'Quick Template (Retail Example)',
        generated: new Date().toISOString()
      };
      
      lastJourney = retailJourney;
      currentJourneyData = { journey: retailJourney };
      
      journeyOutput.textContent = JSON.stringify({ journey: retailJourney }, null, 2);
      journeySources.innerHTML = '<div>Source: Built-in retail template</div>';
      journeyProvider.textContent = 'Provider: Quick Template (Retail Example)';
      
      setupFlowButtons();
      
      // Auto-save when journey is generated
      promptCache.autoSaveCurrentState('journey generated');
      
      alert(`${companyName} retail journey created! Ready for simulation with ${steps.length} steps.`);
    });

    // Simulate Events (batch 6-step chained)
    simulateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentJourneyData || !currentJourneyData.journey) {
        alert('Please generate or load a journey first');
        return;
      }
      const customers = Number(new FormData(simulateForm).get('duration')) || 10;
      const thinkTimeMs = 100;
      simStatus.textContent = `Starting ${customers} customer(s) 6-step chained flow...`;
      // Build comprehensive journey payload with all available fields
      const journey = currentJourneyData.journey;
      const journeyPayload = {
        companyName: journey.companyName || 'DefaultCompany',
        domain: journey.domain || 'default.com',
        industryType: journey.industryType || 'general',
        steps: journey.steps || [],
        
        // Include journey metadata
        journeyId: journey.journeyId || journey.id || `journey_${Date.now()}`,
        journeyType: journey.journeyType || journey.industryType || journey.companyName || 'DefaultJourney',
        description: journey.description || `${journey.companyName || 'Customer'} journey`,
        
        // Include all additional fields from the AI processing (check both locations)
        additionalFields: journey.additionalFields || currentJourneyData.additionalFields || {},
        
        // Include customer and context data (check both locations)
        customerProfile: journey.customerProfile || currentJourneyData.customerProfile || {},
        traceMetadata: journey.traceMetadata || currentJourneyData.traceMetadata || {},
        
        // Include business context from form inputs
        formContext: {
          customSteps: document.getElementById('customSteps')?.value || '',
          journeyType: document.getElementById('journeyType')?.value || '',
          details: document.getElementById('details')?.value || '',
          generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
        },
        
        // Include dynamic additional fields defined by user
        userDefinedFields: typeof additionalFields !== 'undefined' ? 
          additionalFields.reduce((acc, field) => {
            acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                             field.type === 'boolean' ? Math.random() > 0.5 :
                             field.type === 'array' ? ['sample', 'data'] :
                             `sample_${field.name}_value`;
            return acc;
          }, {}) : {},
          
        // Include comprehensive business event metadata
        businessMetadata: {
          timestamp: new Date().toISOString(),
          sessionId: `session_${Date.now()}`,
          deviceType: 'desktop',
          userAgent: navigator.userAgent || 'Unknown',
          campaignSource: 'simulation',
          customerSegment: journey.customerSegment || 'standard',
          behaviorScore: journey.behaviorScore || Math.floor(Math.random() * 10) + 1,
          abandonmentRisk: journey.abandonmentRisk || 'low',
          experimentId: `exp_${Date.now()}`,
          testVariant: 'simulation',
          featureFlags: journey.featureFlags || ['simulation_mode'],
          abTestGroup: 'simulation'
        }
      };
      const res = await fetch('/api/journey-simulation/simulate-batch-chained', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customers, thinkTimeMs, journey: journeyPayload })
      });
      const json = await res.json();
      if (json.ok) {
        simStatus.textContent = `âœ… Batch complete: ${json.summary.completed}/${json.summary.customers} succeeded, ${json.summary.failed} failed`;
        flowResultsEl.textContent = `Sample (first 5):\n${JSON.stringify(json.sample, null, 2)}`;
      } else {
        simStatus.textContent = `âŒ Batch failed: ${json.error || 'Unknown error'}`;
        flowResultsEl.textContent = '';
      }
    });

    // Add a details area for flow results
    let flowResultsEl = document.getElementById('flow-results');
    if (!flowResultsEl) {
      flowResultsEl = document.createElement('pre');
      flowResultsEl.id = 'flow-results';
      flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
      simStatus.parentElement.appendChild(flowResultsEl);
    }

    async function refreshMetrics() {
      const res = await fetch('/api/metrics');
      const json = await res.json();
      metricsEl.textContent = JSON.stringify(json, null, 2);
    }
    setInterval(refreshMetrics, 2000);
    refreshMetrics();

    // Use Retail Example functionality
    document.getElementById('useRetailExample').addEventListener('click', () => {
      const retailJourney = {
        "journey": {
          "companyName": "ShopMart",
          "domain": "shopmart.com", 
          "industryType": "retail",
          "journeyId": "journey_retail_example",
          "steps": [
            {
              "stepIndex": 1,
              "stepName": "Product Discovery",
              "description": "Customer exploring product catalog",
              "duration": "3-8 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Browse_Catalog",
                  "description": "Customer browsing main catalog",
                  "serviceName": "ProductDiscoveryService",
                  "endpoint": "/api/product-discovery",
                  "duration": 1200,
                  "eventType": "browse_initiated",
                  "metadata": {"searchTerm": "winter jackets", "category": "clothing", "device": "mobile"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Filter_Results", 
                  "description": "Customer applying search filters",
                  "serviceName": "ProductDiscoveryService",
                  "endpoint": "/api/filter",
                  "duration": 800,
                  "eventType": "filter_applied",
                  "metadata": {"filters": ["size:M", "color:black"], "resultsCount": 24}
                }
              ]
            },
            {
              "stepIndex": 2,
              "stepName": "Product Selection",
              "description": "Customer evaluating specific items", 
              "duration": "2-5 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "View_Details",
                  "description": "Customer viewing product details",
                  "serviceName": "ProductSelectionService",
                  "endpoint": "/api/product-selection",
                  "duration": 900,
                  "eventType": "product_viewed",
                  "metadata": {"productId": "jacket_123", "price": 89.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Check_Reviews",
                  "description": "Customer reading reviews and ratings",
                  "serviceName": "ProductSelectionService", 
                  "endpoint": "/api/reviews",
                  "duration": 600,
                  "eventType": "reviews_viewed",
                  "metadata": {"rating": 4.5, "reviewCount": 127}
                }
              ]
            },
            {
              "stepIndex": 3,
              "stepName": "Cart Addition",
              "description": "Customer adding items to cart",
              "duration": "1-3 minutes", 
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Add_To_Cart",
                  "description": "Customer adding product to shopping cart",
                  "serviceName": "CartAdditionService",
                  "endpoint": "/api/cart-addition", 
                  "duration": 500,
                  "eventType": "cart_add",
                  "metadata": {"quantity": 1, "cartValue": 89.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "View_Cart",
                  "description": "Customer reviewing cart contents",
                  "serviceName": "CartAdditionService",
                  "endpoint": "/api/cart",
                  "duration": 400,
                  "eventType": "cart_viewed", 
                  "metadata": {"itemCount": 1, "totalValue": 89.99}
                }
              ]
            },
            {
              "stepIndex": 4,
              "stepName": "Checkout Process",
              "description": "Customer proceeding through checkout",
              "duration": "3-7 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Enter_Details",
                  "description": "Customer entering shipping and payment info",
                  "serviceName": "CheckoutProcessService",
                  "endpoint": "/api/checkout-process",
                  "duration": 1800,
                  "eventType": "checkout_started",
                  "metadata": {"paymentMethod": "credit_card", "shippingMethod": "standard"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Apply_Promotion",
                  "description": "Customer applying discount code",
                  "serviceName": "CheckoutProcessService",
                  "endpoint": "/api/promotions",
                  "duration": 300,
                  "eventType": "promotion_applied",
                  "metadata": {"promoCode": "SAVE10", "discount": 9.00}
                }
              ]
            },
            {
              "stepIndex": 5,
              "stepName": "Order Confirmation",
              "description": "Customer completing purchase",
              "duration": "1-2 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Process_Payment",
                  "description": "Payment processing and order completion",
                  "serviceName": "OrderConfirmationService",
                  "endpoint": "/api/order-confirmation",
                  "duration": 1000,
                  "eventType": "order_completed",
                  "metadata": {"orderId": "ORD_789", "finalAmount": 80.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Send_Confirmation",
                  "description": "Sending order confirmation email",
                  "serviceName": "OrderConfirmationService",
                  "endpoint": "/api/confirmation-email",
                  "duration": 200,
                  "eventType": "confirmation_sent",
                  "metadata": {"email": "customer@example.com", "estimatedDelivery": "3-5 days"}
                }
              ]
            },
            {
              "stepIndex": 6,
              "stepName": "Post Purchase",
              "description": "Customer post-purchase activities",
              "duration": "varies",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Track_Order",
                  "description": "Customer tracking order status",
                  "serviceName": "PostPurchaseService",
                  "endpoint": "/api/post-purchase",
                  "duration": 400,
                  "eventType": "order_tracked",
                  "metadata": {"trackingNumber": "TRK123456", "status": "shipped"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Leave_Review",
                  "description": "Customer leaving product review",
                  "serviceName": "PostPurchaseService",
                  "endpoint": "/api/reviews/create",
                  "duration": 600,
                  "eventType": "review_submitted",
                  "metadata": {"rating": 5, "reviewText": "Great quality jacket!"}
                }
              ]
            }
          ]
        },
        "customerProfile": {
          "userId": "user_retail_demo",
          "email": "customer@example.com",
          "demographic": "consumers aged 18-65",
          "painPoints": ["high prices", "limited selection"],
          "goals": ["quality products", "good prices"]
        },
        "traceMetadata": {
          "correlationId": "trace_retail_example",
          "sessionId": "session_retail_demo",
          "businessContext": {"campaignSource": "organic", "customerSegment": "consumer", "businessValue": 500}
        },
        "additionalFields": {
          "deviceType": "mobile", "browser": "Chrome", "entryChannel": "organic",
          "customerIntent": "purchase", "loyaltyStatus": "new", "abandonmentRisk": "medium",
          "conversionProbability": 0.85, "personalizationTags": ["shopping", "products"]
        }
      };
      
      lastJourney = retailJourney.journey;
      currentJourneyData = retailJourney;
      
      journeyOutput.textContent = JSON.stringify(retailJourney, null, 2);
      journeyProvider.textContent = 'Provider: Retail Template Example';
      journeySources.innerHTML = '<div>Source: Built-in retail journey template</div>';
      
      setupFlowButtons();
      alert('Retail journey example loaded! You can now use this for simulation or modify the form to create your own.');
    });

    // Setup button handlers function - ensures buttons work properly
    function setupFlowButtons() {
      console.log('Setting up flow buttons (safe mode)...');

      // Query DOM elements locally to avoid referencing undefined globals
      const runChainedBtnLocal = document.getElementById('run-chained-flow');
      const runJourneySimBtnLocal = document.getElementById('run-journey-simulation');
      const chainStatusLocal = document.getElementById('chain-status');

      if (!runChainedBtnLocal || !runJourneySimBtnLocal) {
        console.error('Button elements not found during setupFlowButtons');
        return;
      }

      // Enable buttons
      runChainedBtnLocal.disabled = false;
      runJourneySimBtnLocal.disabled = false;

      // Update button text to show they're ready
      runChainedBtnLocal.innerHTML = 'ğŸ”— Run Distributed Flow (Ready)';
      runJourneySimBtnLocal.innerHTML = 'ğŸš€ Run Journey Simulation (Ready)';
      
      // Add continuous mode toggle if not exists
      if (!document.getElementById('continuousModeToggle')) {
        const toggleHtml = `
          <div style="margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 5px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="continuousModeToggle" style="width: 18px; height: 18px;">
              <strong>ğŸ”„ Continuous Load Test Mode</strong>
              <span style="font-size: 0.9em; color: #666;">(Keep generating journeys every 5 seconds)</span>
            </label>
          </div>
        `;
        runJourneySimBtnLocal.insertAdjacentHTML('beforebegin', toggleHtml);
      }

      console.log('Flow buttons are now enabled and ready! (safe mode)');

      // Show status
      if (chainStatusLocal) {
        chainStatusLocal.textContent = 'âœ… Buttons enabled! Journey loaded and ready for simulation.';
      }
    }

    // Initialize the page with Copilot method selected by default
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Content Loaded - Starting button setup...');
      
      // Copy button functionality removed per user request
      
      // Get all required elements and verify they exist
      const runChainedBtn = document.getElementById('run-chained-flow');
      const resetPortsBtn = document.getElementById('reset-ports');
      const chainStatus = document.getElementById('chain-status');
      const chainedTraceOutput = document.getElementById('chained-trace-output');
      const runJourneySimBtn = document.getElementById('run-journey-simulation');
      const simStatus = document.getElementById('sim-status');
      
      console.log('Button elements found:');
      console.log('- runChainedBtn:', !!runChainedBtn, runChainedBtn);
      console.log('- runJourneySimBtn:', !!runJourneySimBtn, runJourneySimBtn);
      console.log('- chainStatus:', !!chainStatus);
      console.log('- simStatus:', !!simStatus);
      
      if (!runChainedBtn) {
        console.error('âŒ Blue button (run-chained-flow) not found!');
        return;
      }
      
      if (!runJourneySimBtn) {
        console.error('âŒ Green button (run-journey-simulation) not found!');
        return;
      }
      
      // Add a details area for flow results
      let flowResultsEl = document.getElementById('flow-results');
      if (!flowResultsEl) {
        flowResultsEl = document.createElement('pre');
        flowResultsEl.id = 'flow-results';
        flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
        if (simStatus && simStatus.parentElement) {
          simStatus.parentElement.appendChild(flowResultsEl);
        }
      }
      const generationMethod = document.getElementById('generationMethod');
      const copilotWorkflow = document.getElementById('copilotWorkflow');
      const templateExample = document.getElementById('templateExample');
      const customStepsContainer = document.getElementById('customStepsContainer');
      const optionalFieldsContainer = document.getElementById('optionalFieldsContainer');
      const journeyRequirementsContainer = document.getElementById('journeyRequirementsContainer');

      // Always set Copilot as default and show Copilot workflow
      generationMethod.value = 'copilot';
      copilotWorkflow.classList.remove('hidden');
      if (templateExample) templateExample.classList.add('hidden');
      customStepsContainer.style.display = 'none';
      optionalFieldsContainer.style.display = 'none';
      journeyRequirementsContainer.style.display = 'block';

      // Clear form fields for Copilot mode
      document.getElementById('companyName').value = '';
      document.getElementById('domain').value = '';
      document.getElementById('industryType').value = '';
      document.getElementById('journeyRequirements').value = '';

      // Always generate the Copilot prompt and show it
      generateCopilotPrompt();
      
      // Ensure it's populated even if there was an initial delay
      setTimeout(generateCopilotPrompt, 100);

      // Also regenerate prompt when switching to Copilot mode
      generationMethod.addEventListener('change', (e) => {
        if (e.target.value === 'copilot') {
          generateCopilotPrompt();
          copilotWorkflow.classList.remove('hidden');
          customStepsContainer.style.display = 'none';
          optionalFieldsContainer.style.display = 'none';
          journeyRequirementsContainer.style.display = 'block';
        } else if (e.target.value === 'template') {
          // Quick Template mode - populate with ShopMart retail example
          copilotWorkflow.classList.add('hidden');
          customStepsContainer.style.display = 'block';
          optionalFieldsContainer.style.display = 'block';
          journeyRequirementsContainer.style.display = 'none';
          
          // Populate form with ShopMart retail example
          document.getElementById('companyName').value = 'ShopMart';
          document.getElementById('domain').value = 'shopmart.com';
          document.getElementById('industryType').value = 'retail';
          document.getElementById('customSteps').value = 'Product Discovery, Product Selection, Add to Cart, Checkout Process, Payment Processing, Order Confirmation';
          document.getElementById('journeyType').value = 'E-commerce Purchase Journey';
          document.getElementById('details').value = 'Complete retail customer journey from product discovery to order confirmation';
          
          // Clear additional fields for template mode
          additionalFields.length = 0;
          renderAdditionalFields();
          
          // Auto-generate the retail journey
          setTimeout(() => {
            document.getElementById('generateJourney').click();
          }, 500);
        }
      });

      // Force initial prompt generation after a short delay to ensure helper functions are loaded
      setTimeout(() => {
        generateCopilotPrompt();
      }, 100);

      // Set initial status messages to show buttons are ready
      setTimeout(() => {
        console.log('Setting initial button status...');
        console.log('runChainedBtn found:', !!runChainedBtn);
        console.log('runJourneySimBtn found:', !!runJourneySimBtn);
        console.log('chainStatus found:', !!chainStatus);
        console.log('simStatus found:', !!simStatus);
        
        if (chainStatus) {
          chainStatus.textContent = 'ğŸ¯ Ready to test! Blue button will work even without a generated journey.';
        }
        if (simStatus) {
          simStatus.textContent = 'ğŸ¯ Ready to simulate! Green button will work even without a generated journey.';
        }
        
        // Add simple test handlers to verify buttons work
        if (runChainedBtn) {
          console.log('Blue button found and handler will be attached');
        } else {
          console.error('Blue button (run-chained-flow) not found!');
        }
        
        if (runJourneySimBtn) {
          console.log('Green button found and handler will be attached');
        } else {
          console.error('Green button (run-journey-simulation) not found!');
        }
      }, 500);

      // Setup button event handlers
      // Enhanced chained flow with automatic seeding and better error handling
      runChainedBtn.onclick = async () => {
        console.log('ğŸ”¥ BLUE BUTTON CLICKED! ğŸ”¥');
        alert('Blue button clicked! Distributed Flow starting...');
        try {
          chainStatus.textContent = 'ğŸš€ Starting distributed flow... Seeding journey and starting services...';
          chainedTraceOutput.textContent = '';
          runChainedBtn.disabled = true;
          runChainedBtn.textContent = 'ğŸ”„ Running...';

          // First, ensure we have a journey to work with
          if (!lastJourney || !lastJourney.steps || !lastJourney.steps.length) {
            chainStatus.textContent = 'âš ï¸ No journey data available. Creating test journey...';
            
            // Create a simple test journey
            lastJourney = {
              companyName: 'TestCorp',
              domain: 'testcorp.com',
              industryType: 'Technology',
              journeyType: 'Distributed Flow Test',
              steps: [
                { stepName: 'Discovery', description: 'Customer discovery' },
                { stepName: 'Selection', description: 'Product selection' },
                { stepName: 'Purchase', description: 'Purchase process' }
              ]
            };
            
            chainStatus.textContent = 'âœ… Test journey created! Running distributed flow...';
          }

          // Build steps from the journey
          let stepNames = lastJourney.steps.slice(0, 6).map(s => s.stepName || s.name || String(s));
          
          // Normalize to exactly 6
          while (stepNames.length < 6) stepNames.push(`Step${stepNames.length + 1}`);
          stepNames = stepNames.slice(0, 6);

          // Build comprehensive body with all available journey data
          const body = { 
            steps: stepNames.map(n => ({ stepName: n })),
            thinkTimeMs: 200, // Increased think time for better service startup
            companyName: lastJourney?.companyName || 'DefaultCompany',
            domain: lastJourney?.domain || 'default.com',
            industryType: lastJourney?.industryType || 'general',
            
            // Include additional context data for comprehensive tracing
            additionalFields: lastJourney?.additionalFields || {},
            customerProfile: lastJourney?.customerProfile || {},
            traceMetadata: lastJourney?.traceMetadata || {},
            
            // Include business context from form inputs
            formContext: {
              customSteps: document.getElementById('customSteps')?.value || '',
              journeyType: document.getElementById('journeyType')?.value || '',
              details: document.getElementById('details')?.value || '',
              generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
            },
            
            // Include dynamic additional fields defined by user
            userDefinedFields: typeof additionalFields !== 'undefined' ? 
              additionalFields.reduce((acc, field) => {
                acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                 field.type === 'boolean' ? Math.random() > 0.5 :
                                 field.type === 'array' ? ['sample', 'data'] :
                                 `sample_${field.name}_value`;
                return acc;
              }, {}) : {},
              
            // Include simulation metadata
            simulationMetadata: {
              timestamp: new Date().toISOString(),
              simulationType: 'distributed-chained',
              sessionId: `session_${Date.now()}`,
              correlationId: `dist_chain_${Date.now()}`
            }
          };
          
          chainStatus.textContent = 'ğŸ”— Running distributed flow with OneAgent tracing...';
          
          const res = await fetch('/api/steps/step1-chained', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const json = await res.json();

          if (!json.ok) {
            chainStatus.textContent = `âŒ Chained flow failed: ${json.error || 'Unknown error'}`;
            chainedTraceOutput.textContent = `Error Details:\n${JSON.stringify(json, null, 2)}`;
            return;
          }

          const trace = json.result?.trace || [];
          const stepsStr = trace.map(t => t.stepName).join(' â†’ ');
          const totalDuration = trace.reduce((sum, t) => sum + (t.duration || 0), 0);
          chainStatus.textContent = `âœ… Distributed flow completed! ${trace.length} spans traced (${totalDuration}ms total) â€¢ ${stepsStr}`;
          chainedTraceOutput.textContent = JSON.stringify(trace, null, 2);
        } catch (e) {
          chainStatus.textContent = `âŒ Error: ${e.message}`;
          chainedTraceOutput.textContent = `Error Details:\n${e.stack}`;
        } finally {
          runChainedBtn.disabled = false;
          runChainedBtn.textContent = 'ğŸ”— Run Distributed Flow';
        }
      };

      // Reset dynamic services to free ports
      resetPortsBtn.onclick = async () => {
        try {
          chainStatus.textContent = 'Resetting dynamic services...';
          const res = await fetch('/api/admin/reset-ports', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
          const json = await res.json();
          chainStatus.textContent = json.ok ? 'âœ… Dynamic services reset.' : `âŒ Reset failed: ${json.error || 'Unknown error'}`;
        } catch (e) {
          chainStatus.textContent = `âŒ Reset error: ${e.message}`;
        }
      };

      // Journey Simulation button handler
      runJourneySimBtn.onclick = async () => {
        console.log('ğŸ”¥ Journey Simulation Button Clicked! ğŸ”¥');
        
        // Handle stop request in continuous mode
        if (runJourneySimBtn.dataset.running === 'true') {
          console.log('ğŸ›‘ Stop requested for continuous load test');
          runJourneySimBtn.dataset.stopRequested = 'true';
          runJourneySimBtn.disabled = true;
          runJourneySimBtn.textContent = 'â³ Stopping...';
          if (simStatus) {
            simStatus.textContent = 'ğŸ›‘ Stopping continuous load test after current journey...';
          }
          return;
        }
        
        try {
          console.log('Journey Simulation button clicked!');
          
          const continuousMode = document.getElementById('continuousModeToggle')?.checked;
          
          if (runJourneySimBtn) {
            runJourneySimBtn.disabled = true;
            runJourneySimBtn.textContent = continuousMode ? 'ğŸ”„ Running Load Test...' : 'ğŸ”„ Simulating Journey...';
          }
          if (simStatus) {
            simStatus.textContent = continuousMode ? 
              'ğŸ”„ Starting continuous load test (click button to stop)...' : 
              'Starting customer journey simulation...';
          }
          
          if (!lastJourney) {
            if (simStatus) {
              simStatus.textContent = 'âš ï¸ No journey data available. Creating test journey for simulation...';
            }
            
            // Create a simple test journey
            lastJourney = {
              companyName: 'SimTestCorp',
              domain: 'simtestcorp.com',
              industryType: 'Simulation Testing',
              journeyType: 'Continuous Load Test',
              steps: [
                { stepName: 'Discovery', description: 'Customer discovery phase' },
                { stepName: 'Evaluation', description: 'Product evaluation' },
                { stepName: 'Decision', description: 'Purchase decision' },
                { stepName: 'Transaction', description: 'Complete transaction' }
              ]
            };
            
            if (simStatus) {
              simStatus.textContent = 'âœ… Test journey created! Starting simulation...';
            }
          }
          
          const customerId = `customer_${Date.now()}`;
          const journeyId = `journey_${Date.now()}`;
          
          // Get company data from form fields (PRIORITY) or fallback to lastJourney data
          const formCompanyName = document.getElementById('companyName')?.value?.trim() || '';
          const formDomain = document.getElementById('domain')?.value?.trim() || '';
          const formIndustryType = document.getElementById('industryType')?.value?.trim() || '';
          
          console.log('ğŸ¢ Form company data:', { formCompanyName, formDomain, formIndustryType });
          console.log('ğŸ“Š LastJourney company data:', { 
            companyName: lastJourney?.companyName, 
            domain: lastJourney?.domain, 
            industryType: lastJourney?.industryType 
          });
          
          // Build comprehensive journey data with all available fields (consistent with main function)
          const journeyData = {
            steps: lastJourney.steps || [],
            journeyId: lastJourney.id || journeyId,
            companyName: formCompanyName || lastJourney.companyName || 'DefaultCompany',
            domain: formDomain || lastJourney.domain || 'default.com',
            industryType: formIndustryType || lastJourney.industryType || 'general',
            journeyType: lastJourney.journeyType || lastJourney.industryType || lastJourney.companyName || 'DefaultJourney',
            description: lastJourney.description || `${lastJourney.companyName || 'Customer'} journey`,
            
            // Include all additional fields from the AI processing
            additionalFields: lastJourney.additionalFields || {
              sessionId: `session_${Date.now()}`,
              deviceType: 'desktop',
              userAgent: navigator.userAgent || 'Chrome/118.0.0.0',
              campaignSource: 'organic_search',
              customerSegment: 'premium',
              behaviorScore: 8.5,
              abandonmentRisk: 'low',
              timestamp: new Date().toISOString(),
              simulationMode: true
            },
            
            customerProfile: lastJourney.customerProfile || {
              customerId: customerId,
              age: 32,
              gender: 'F',
              loyaltyTier: 'gold',
              previousPurchases: 15,
              avgOrderValue: 125.50,
              preferredChannel: 'mobile',
              registrationDate: new Date(Date.now() - 365*24*60*60*1000).toISOString(),
              lastLoginDate: new Date().toISOString()
            },
            
            traceMetadata: lastJourney.traceMetadata || {
              experimentId: 'exp_2025_q4',
              testVariant: 'control',
              featureFlags: ['checkout_v2', 'ai_recommendations'],
              abTestGroup: 'A',
              correlationId: journeyId,
              parentSpanId: null,
              traceId: `trace_${Date.now()}`
            },
            
            // Include business context from form inputs
            formContext: {
              customSteps: document.getElementById('customSteps')?.value || '',
              journeyType: document.getElementById('journeyType')?.value || '',
              details: document.getElementById('details')?.value || '',
              generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
            },
            
            // Include dynamic additional fields defined by user
            userDefinedFields: typeof additionalFields !== 'undefined' ? 
              additionalFields.reduce((acc, field) => {
                acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                 field.type === 'boolean' ? Math.random() > 0.5 :
                                 field.type === 'array' ? ['sample', 'data'] :
                                 `sample_${field.name}_value`;
                return acc;
              }, {}) : {},
              
            // Include comprehensive business event metadata
            businessMetadata: {
              timestamp: new Date().toISOString(),
              sessionId: `session_${Date.now()}`,
              deviceType: 'desktop',
              userAgent: navigator.userAgent || 'Unknown',
              campaignSource: 'simulation',
              customerSegment: lastJourney.customerSegment || 'standard',
              behaviorScore: lastJourney.behaviorScore || Math.floor(Math.random() * 10) + 1,
              abandonmentRisk: lastJourney.abandonmentRisk || 'low',
              experimentId: `exp_${Date.now()}`,
              testVariant: 'simulation',
              featureFlags: lastJourney.featureFlags || ['simulation_mode'],
              abTestGroup: 'simulation',
              region: 'us-east-1',
              environment: 'simulation'
            }
          };
          
          simStatus.textContent = 'ğŸš€ Running customer journey simulation...';
          
          // Get customer count from UI
          const customerCount = parseInt(document.getElementById('customerCount').value) || 1;
          console.log(`Running simulation for ${customerCount} customers`);
          
          // Use appropriate endpoint based on customer count
          const endpoint = customerCount > 1 ? '/api/journey-simulation/simulate-multiple-journeys' : '/api/journey-simulation/simulate-journey';
          
          // Build comprehensive request body with all available data (consistent with main function)
          const requestBody = {
            journeyId,
            customerId,
            journey: journeyData,  // Complete journey object with all fields
            companyName: journeyData.companyName,
            domain: journeyData.domain,
            industryType: journeyData.industryType,
            journeyType: journeyData.journeyType,
            description: journeyData.description,
            
            // Include all context data in request body for tracing
            additionalFields: journeyData.additionalFields || {},
            customerProfile: journeyData.customerProfile || {},
            traceMetadata: journeyData.traceMetadata || {},
            formContext: journeyData.formContext || {},
            userDefinedFields: journeyData.userDefinedFields || {},
            businessMetadata: journeyData.businessMetadata || {},
            
            // Simulation parameters
            chained: false, // Use step-by-step execution for consistency
            simulationId: `sim_${Date.now()}`,
            batchId: `batch_${Date.now()}`,
            customerCount: 1
          };
          
          // Add customers parameter for multiple journey endpoint
          if (customerCount > 1) {
            requestBody.customers = customerCount;
          }
          
          const res = await fetch(endpoint, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(requestBody) 
          });
          
          const json = await res.json();
          
          if (json.success) {
            // Handle multiple customers response
            if (json.loadTestSummary && customerCount > 1) {
              const summary = json.loadTestSummary;
              
              // Analyze errors to provide better status message
              const errors = json.errors || [];
              const incompleteCount = errors.filter(err => err.includes('incomplete')).length;
              const failureCount = errors.filter(err => !err.includes('incomplete')).length;
              
              let statusIcon = 'âœ…';
              let statusText = '';
              
              if (summary.successfulCustomers === summary.customersProcessed) {
                statusText = `All ${summary.customersProcessed} customers completed successfully!`;
              } else if (summary.successfulCustomers > 0) {
                statusIcon = 'âš ï¸';
                if (incompleteCount > 0) {
                  statusText = `${summary.successfulCustomers} completed, ${incompleteCount} partially completed, ${failureCount} failed`;
                } else {
                  statusText = `${summary.successfulCustomers} completed successfully, ${summary.failedCustomers} encountered issues`;
                }
              } else {
                statusIcon = 'âŒ';
                if (incompleteCount === summary.customersProcessed) {
                  statusText = `All ${summary.customersProcessed} customers partially completed journeys`;
                } else {
                  statusText = `${summary.customersProcessed} customers encountered issues (${incompleteCount} partial, ${failureCount} failed)`;
                }
              }
              
              simStatus.textContent = `${statusIcon} ${customerCount} Customer Journey Simulation Complete! ${statusText}`;
              
              const summaryText = [
                `Load Test Results:`,
                `â€¢ Customers Processed: ${summary.customersProcessed}`,
                `â€¢ Successful: ${summary.successfulCustomers}`,
                `â€¢ Failed: ${summary.failedCustomers}`, 
                `â€¢ Success Rate: ${summary.successRate}`,
                `â€¢ Average Completion Time: ${summary.averageCompletionTime}`,
                `â€¢ Average Steps Completed: ${summary.averageStepsCompleted}`,
                ``,
                `Correlation IDs: ${json.correlationIds ? json.correlationIds.slice(0, 3).join(', ') : 'N/A'}${json.correlationIds && json.correlationIds.length > 3 ? '...' : ''}`
              ];
              
              if (json.journeyExample) {
                summaryText.push(``, `Example Journey Execution:`, json.journeyExample.execution);
                summaryText.push(``, `Services Used: ${json.journeyExample.servicesUsed}`);
              }
              
              flowResultsEl.textContent = summaryText.join('\n');
              
            } else {
              // Handle single customer response
              const journey = json.journey;
              if (simStatus) {
                simStatus.textContent = `âœ… Customer Journey complete! ${journey.completedSteps}/${journey.totalSteps} steps successful. Correlation: ${journey.correlationId}`;
              }
              
              // Show detailed results with service names (same as 6-step flow)
              const stepSummary = journey.steps.map((step, idx) => {
                const status = step.status === 'completed' ? 'âœ…' : 'âŒ';
                const serviceName = step.serviceName || (step.stepName + 'Service');
                return `${status} Step ${idx + 1}: ${serviceName} (${step.processingTime || 0}ms)`;
              }).join('\n');
              
              if (flowResultsEl) {
                flowResultsEl.textContent = `Customer Journey Execution:\n${stepSummary}\n\nServices Used: ${journey.stepNames ? journey.stepNames.join(' â†’ ') : 'N/A'}\n\nCorrelation ID: ${journey.correlationId}`;
              }
            }
            
          } else {
            if (simStatus) {
              simStatus.textContent = `âŒ Journey simulation failed: ${json.error}`;
            }
            if (flowResultsEl) {
              flowResultsEl.textContent = `Journey Error Details:\n${JSON.stringify(json, null, 2)}`;
            }
          }
          
        } catch (error) {
          console.error('Journey Simulation error:', error);
          if (simStatus) {
            simStatus.textContent = `âŒ Journey simulation error: ${error.message}`;
          }
          if (flowResultsEl) {
            flowResultsEl.textContent = `Error Details:\n${error.stack}`;
          }
        } finally {
          // Check if continuous mode is enabled
          const continuousMode = document.getElementById('continuousModeToggle')?.checked;
          
          if (continuousMode && runJourneySimBtn && !runJourneySimBtn.dataset.stopRequested) {
            // Keep running in continuous mode
            console.log('ğŸ”„ Continuous mode: Scheduling next journey in 5 seconds...');
            runJourneySimBtn.textContent = 'ğŸ›‘ Stop Load Test';
            runJourneySimBtn.dataset.running = 'true';
            
            setTimeout(() => {
              if (continuousMode && !runJourneySimBtn.dataset.stopRequested) {
                runJourneySimBtn.click(); // Trigger next journey
              }
            }, 5000);
          } else {
            // Single run mode or stop requested
            if (runJourneySimBtn) {
              runJourneySimBtn.disabled = false;
              runJourneySimBtn.textContent = 'ğŸš€ Run Journey Simulation';
              delete runJourneySimBtn.dataset.running;
              delete runJourneySimBtn.dataset.stopRequested;
            }
          }
        }
      };
      
      // Event listeners moved back outside DOMContentLoaded to restore original logic
    });

    // Fetch domain label from response header
    (async () => {
      try {
        const res = await fetch('/api/health');
        const label = res.headers.get('X-App-Domain-Label');
        if (label) document.getElementById('host-label').textContent = `Domain: ${label}`;
      } catch {}
    })();

    // Initialize service status display and set up periodic updates
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ DOM loaded - Initializing auto-refresh for service status...');
      
      // Wait a moment for everything to be ready
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Check if updateServiceStatus function exists
      if (typeof window.updateServiceStatus !== 'function') {
        console.error('âŒ updateServiceStatus function not found!');
        return;
      }
      
      // Initial load
      console.log('ğŸ“¡ Running initial service status update...');
      try {
        await window.updateServiceStatus();
      } catch (error) {
        console.error('âŒ Initial service status update failed:', error);
      }
      
      // Update every 10 seconds for real-time visibility
      console.log('â° Setting up 10-second auto-refresh interval');
      setInterval(() => {
        console.log('ğŸ”„ Auto-refresh triggered');
        try {
          window.updateServiceStatus();
        } catch (error) {
          console.error('âŒ Auto-refresh failed:', error);
        }
      }, 10000);
      
      console.log('âœ… Auto-refresh initialization complete');
    });

    // Add customer count validation
    document.getElementById('customerCount').addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      const simStatus = document.getElementById('sim-status');
      
      if (value > 1) {
        e.target.style.borderColor = '#ef4444'; // Red border
        if (simStatus) {
          simStatus.textContent = 'âš ï¸ Warning: Maximum 1 customer allowed';
          simStatus.style.color = '#ef4444';
        }
      } else {
        e.target.style.borderColor = '#00D4FF'; // Reset to cyan
        if (simStatus) {
          simStatus.textContent = '';
          simStatus.style.color = '#FFD23F';
        }
      }
    });

    // Prevent values above 1 on change
    document.getElementById('customerCount').addEventListener('change', (e) => {
      const value = parseInt(e.target.value);
      if (value > 1) {
        e.target.value = 1;
        alert('Customer limit is 1. Value has been adjusted to maximum allowed.');
      } else if (value < 1) {
        e.target.value = 1;
      }
    });

    // BACKUP: Ensure processResponse button works - attach at the very end
    console.log('ğŸ”§ Setting up backup processResponse event listener');
    setTimeout(() => {
      const processBtn = document.getElementById('processResponse');
      if (processBtn) {
        console.log('âœ… Backup: Process button found');
        // Remove any existing listeners and add a fresh one
        processBtn.replaceWith(processBtn.cloneNode(true));
        const newProcessBtn = document.getElementById('processResponse');
        newProcessBtn.addEventListener('click', function() {
          console.log('ğŸš€ BACKUP: Step 4 - Process button clicked');
          const responseText = document.getElementById('copilotResponse').value.trim();
          console.log('Response text length:', responseText.length);
          
          if (!responseText) {
            alert('Please paste your Copilot response first');
            return;
          }

          try {
            const parsedResponse = JSON.parse(responseText);
            if (parsedResponse.journey && parsedResponse.journey.steps) {
              // Set the global variables for journey simulation with complete data
              window.lastJourney = {
                ...parsedResponse.journey,
                additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
                customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
                traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
              };
              window.currentJourneyData = parsedResponse;

              // Auto-generate feature flags based on journey
              autoGenerateFeatureFlags(parsedResponse);

              // Display journey with additional fields info
              const displayData = {
                journey: parsedResponse.journey,
                customerProfile: parsedResponse.customerProfile,
                traceMetadata: parsedResponse.traceMetadata,
                additionalFields: parsedResponse.additionalFields
              };

              // Get elements by ID to ensure they exist
              const journeyOutputEl = document.getElementById('journey-output');
              const journeyProviderEl = document.getElementById('journey-provider');
              const journeySourcesEl = document.getElementById('journey-sources');
              
              console.log('Setting journey output...');

              if (journeyOutputEl) {
                journeyOutputEl.textContent = JSON.stringify(displayData, null, 2);
                console.log('âœ… Journey output set, length:', journeyOutputEl.textContent.length);
              } else {
                console.error('âŒ journey-output element not found');
              }
              
              if (journeyProviderEl) {
                journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
              }
              
              if (journeySourcesEl) {
                journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
              }

              const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
              alert('Journey processed successfully! Includes ' + fieldsCount + ' additional tracking fields.');
            } else {
              alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
            }
          } catch (error) {
            console.error('JSON Parse Error:', error);
            alert('Invalid JSON format. Error: ' + error.message);
          }
        });
        console.log('âœ… Backup process button listener attached');
      } else {
        console.error('âŒ Backup: Process button not found!');
      }
    }, 1000);

    // Add delay function to prevent 'delay is not defined' errors
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Make delay available globally for any scripts that might need it
    window.delay = delay;
    
    // Sidebar is now permanently pinned - no toggle functionality needed
    
    // ============================================
    // Dynatrace Integration Functions
    // ============================================
    
    // Deploy Dynatrace Dashboard
    async function deployDynatraceDashboard() {
      const statusEl = document.getElementById('dynatrace-status');
      
      // DEBUG: Log what we have
      console.log('[DEBUG] deployDynatraceDashboard called');
      console.log('[DEBUG] window.currentJourneyData:', window.currentJourneyData);
      console.log('[DEBUG] window.lastJourney:', window.lastJourney);
      
      // Use window.currentJourneyData explicitly
      if (!window.currentJourneyData || !window.currentJourneyData.journey) {
        statusEl.textContent = 'âŒ Error: No journey loaded. Please generate or load a journey first.';
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        console.error('[DEBUG] currentJourneyData check failed:', {
          exists: !!window.currentJourneyData,
          hasJourney: !!(window.currentJourneyData && window.currentJourneyData.journey),
          windowKeys: Object.keys(window).filter(k => k.includes('journey') || k.includes('Journey'))
        });
        return;
      }
      
      const journey = window.currentJourneyData.journey;
      
      statusEl.textContent = `ï¿½ Generating dashboard JSON for ${journey.companyName}...`;
      statusEl.className = 'mt-3 p-3 bg-blue-900 bg-opacity-50 rounded text-xs font-mono text-blue-300';
      
      try {
        // Generate dashboard JSON (no deployment, just download)
        console.log('[Dashboard] Generating dashboard JSON...');
        
        const response = await fetch('/api/dynatrace/generate-dashboard-json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            journeyConfig: journey
          })
        });
        
        console.log('[Dashboard] Response status:', response.status);
        const result = await response.json();
        console.log('[Dashboard] Response data:', result);
        
        if (result.ok && result.dashboardJson) {
          // Auto-download the JSON file
          const blob = new Blob([JSON.stringify(result.dashboardJson, null, 2)], { 
            type: 'application/json' 
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = result.fileName || 'dynatrace-dashboard.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          statusEl.textContent = `âœ… Dashboard JSON downloaded: ${result.fileName}\n\nğŸ“¤ To upload to Dynatrace:\n1. Go to your Dynatrace environment\n2. Navigate to Dashboards\n3. Click "Import dashboard"\n4. Upload the downloaded JSON file`;
          statusEl.className = 'mt-3 p-3 bg-green-900 bg-opacity-50 rounded text-xs font-mono text-green-300 whitespace-pre-wrap';
        } else {
          const errorMsg = result.error || 'Unknown error';
          statusEl.textContent = `âŒ Dashboard generation failed:\n${errorMsg}`;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        }
      } catch (error) {
        console.error('[Dashboard] Generation error:', error);
        statusEl.textContent = `âŒ Request failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
      }
    }
    
    async function generateAIDashboard() {
      const statusEl = document.getElementById('dynatrace-status');
      
      console.log('[AI Dashboard] generateAIDashboard called');
      console.log('[AI Dashboard] window.currentJourneyData:', window.currentJourneyData);
      
      if (!window.currentJourneyData || !window.currentJourneyData.journey) {
        statusEl.textContent = 'âŒ Error: No journey loaded. Please generate or load a journey first.';
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        return;
      }
      
      const journey = window.currentJourneyData.journey;
      
      statusEl.textContent = `ğŸ¤– AI generating dashboard for ${journey.companyName} ${journey.journeyType}...`;
      statusEl.className = 'mt-3 p-3 bg-purple-900 bg-opacity-50 rounded text-xs font-mono text-purple-300 animate-pulse';
      
      try {
        const startTime = Date.now();
        
        // Call AI dashboard generation endpoint
        const response = await fetch('/api/ai-dashboard/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            journeyData: {
              company: journey.companyName,
              industry: journey.industryType || 'Technology',
              journeyType: journey.journeyType,
              steps: journey.steps.map(s => ({
                name: s.stepName,
                serviceName: s.serviceName,
                category: s.category || '',
                description: s.description || '',
                estimatedDuration: s.estimatedDuration || 0,
                hasError: s.hasError || false
              })),
              // Forward ALL rich context for smart field detection
              additionalFields: window.currentJourneyData.additionalFields || {},
              customerProfile: window.currentJourneyData.customerProfile || {},
              traceMetadata: window.currentJourneyData.traceMetadata || {}
            }
          })
        });
        
        const duration = ((Date.now() - startTime) / 1000).toFixed(1);
        const result = await response.json();
        
        console.log('[AI Dashboard] Response:', result);
        
        if (result.success && result.dashboard) {
          // Auto-download the AI-generated dashboard JSON
          const dashboardJson = result.dashboard.content || result.dashboard;
          const blob = new Blob([JSON.stringify(dashboardJson, null, 2)], { 
            type: 'application/json' 
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${journey.companyName}-${journey.journeyType}-ai-dashboard.json`.replace(/\s+/g, '-').toLowerCase();
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          const method = result.generationMethod || result.metadata?.generationMethod || 'unknown';
          const tilesCount = Object.keys(dashboardJson.tiles || {}).length;
          
          statusEl.textContent = `âœ… AI Dashboard generated in ${duration}s (${method})\nğŸ“Š ${tilesCount} tiles created\n\nğŸ“¤ To upload to Dynatrace:\n1. Go to your Dynatrace environment\n2. Navigate to Dashboards â†’ Import\n3. Upload the downloaded JSON file`;
          statusEl.className = 'mt-3 p-3 bg-green-900 bg-opacity-50 rounded text-xs font-mono text-green-300 whitespace-pre-wrap';
        } else {
          const errorMsg = result.message || result.error || 'Unknown error';
          statusEl.textContent = `âŒ AI dashboard generation failed:\n${errorMsg}`;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        }
      } catch (error) {
        console.error('[AI Dashboard] Generation error:', error);
        statusEl.textContent = `âŒ Request failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
      }
    }
    
    // Initiate OAuth flow for dashboard deployment
    async function initiateOAuthForDashboard() {
      const statusEl = document.getElementById('dynatrace-status');
      statusEl.textContent = 'ğŸ” Initializing OAuth SSO...';
      statusEl.className = 'mt-3 p-3 bg-blue-900 bg-opacity-50 rounded text-xs font-mono text-blue-300';
      
      try {
        // Get stored environment
        const storedSettings = await window.loadDynatraceSettings();
        if (!storedSettings) {
          throw new Error('No environment configured. Please save settings first.');
        }
        
        // Initialize OAuth session
        const response = await fetch('/api/mcp/init-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            environment: storedSettings.environment
          })
        });
        
        const { authUrl, sessionId } = await response.json();
        
        // Open OAuth window
        const authWindow = window.open(authUrl, 'dynatrace-oauth', 'width=600,height=700,menubar=no,toolbar=no');
        
        statusEl.textContent = 'ğŸ” OAuth window opened - please sign in with Dynatrace...';
        
        // Listen for OAuth callback
        window.addEventListener('message', async (event) => {
          if (event.data.type === 'mcp-auth-success' && event.data.sessionId === sessionId) {
            statusEl.textContent = 'âœ… Authentication successful! Deploying dashboard with OAuth token...';
            
            // Now deploy with OAuth token
            // TODO: Update dashboard deployment to use MCP session
            setTimeout(() => {
              statusEl.innerHTML = `
                âœ… Authenticated successfully!
                
                Note: Dashboard deployment with OAuth tokens coming soon.
                For now, use MCP Auto-Generate feature:
                
                <button onclick="window.location.href='/mcp-demo.html'" 
                        style="margin-top: 10px; padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 5px; cursor: pointer;">
                  ğŸš€ Go to MCP Demo
                </button>
              `;
            }, 1000);
          }
        });
        
      } catch (error) {
        statusEl.textContent = `âŒ OAuth initialization failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
      }
    }
    
    // Query Dynatrace Journey Analytics
    async function queryDynatraceData() {
      const statusEl = document.getElementById('dynatrace-status');
      
      if (!currentJourneyData || !currentJourneyData.journey) {
        statusEl.textContent = 'âŒ Error: No journey loaded. Please generate or load a journey first.';
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        return;
      }
      
      const journey = currentJourneyData.journey;
      const companyName = journey.companyName;
      const correlationId = currentJourneyData.correlationId;
      
      statusEl.textContent = `ğŸ” Verifying deployment for ${companyName}...\n\nChecking: BizEvents, Services, Entities...`;
      statusEl.className = 'mt-3 p-3 bg-blue-900 bg-opacity-50 rounded text-xs font-mono text-blue-300';
      
      try {
        // Try to load credentials from localStorage
        const storedSettings = await window.loadDynatraceSettings();
        
        if (!storedSettings) {
          statusEl.textContent = 'âŒ Dynatrace not configured.\n\nClick "MCP Settings" to configure your credentials.';
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
          return;
        }
        
        const response = await fetch('/api/dynatrace/verify-deployment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-DT-Environment': storedSettings.environment,
            'X-DT-Token': storedSettings.token,
            'X-DT-Budget': storedSettings.budget
          },
          body: JSON.stringify({
            companyName: companyName,
            correlationId: correlationId,
            steps: journey.steps.map(s => s.stepName)
          })
        });
        
        const result = await response.json();
        
        if (result.ok) {
          const v = result.verification;
          
          statusEl.innerHTML = `<div style="line-height: 1.8;">
            <strong>âœ… Deployment Verification for ${companyName}</strong><br><br>
            
            <strong>ğŸ“Š BizEvents:</strong> ${v.bizEventsFound ? `âœ… ${v.bizEventsCount} events found` : 'âŒ No events yet'}<br>
            <strong>ğŸ”— Services:</strong> ${v.servicesFound ? `âœ… ${v.serviceCount} services detected` : 'âŒ No services yet'}<br>
            <strong>ğŸ“ Entities:</strong> ${v.entitiesFound ? `âœ… ${v.entityCount} entities` : 'âŒ No entities yet'}<br>
            <strong>ğŸ• Time Range:</strong> Last ${v.timeframe || '2h'}<br><br>
            
            ${correlationId ? `<strong>ğŸ”— Correlation ID:</strong> ${correlationId.substring(0, 24)}...<br><br>` : ''}
            
            ${v.bizEventsFound ? `<strong>ğŸ’¡ Tip:</strong> BizEvents are flowing! Dashboard will show real data.<br>` : `<strong>âš ï¸ Note:</strong> Run journey simulation first to generate BizEvents.<br>`}
          </div>`;
          
          statusEl.className = v.bizEventsFound && v.servicesFound ? 
            'mt-3 p-3 bg-green-900 bg-opacity-50 rounded text-sm text-green-300 border border-green-600' :
            'mt-3 p-3 bg-yellow-900 bg-opacity-50 rounded text-sm text-yellow-300 border border-yellow-600';
        } else {
          const errorMsg = result.error || 'Unknown error';
          statusEl.textContent = `âŒ Verification failed:\n${errorMsg}\n\nğŸ’¡ Check your Dynatrace credentials in MCP Settings.`;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        }
      } catch (error) {
        console.error('Verification error:', error);
        statusEl.textContent = `âŒ Request failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
      }
    }
    
    // Make functions globally available
    window.deployDynatraceDashboard = deployDynatraceDashboard;
    window.queryDynatraceData = queryDynatraceData;
    
    // Bypass function to try Platform token on Sprint anyway
    window.deployDashboardBypass = async function() {
      const statusEl = document.getElementById('dynatrace-status');
      statusEl.textContent = 'ğŸš€ Bypassing Sprint check... Trying Platform token with Configuration API fallback...';
      statusEl.className = 'mt-3 p-3 bg-orange-900 bg-opacity-50 rounded text-xs font-mono text-orange-300';
      
      // Call deployment with bypass header
      if (!currentJourneyData || !currentJourneyData.journey) {
        statusEl.textContent = 'âŒ Error: No journey loaded.';
        return;
      }
      
      const journey = currentJourneyData.journey;
      const storedSettings = await window.loadDynatraceSettings();
      
      if (!storedSettings) {
        statusEl.textContent = 'âŒ Dynatrace not configured. Click "MCP Settings" to configure.';
        return;
      }
      
      try {
        const response = await fetch('/api/dynatrace/deploy-dashboard', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-DT-Environment': storedSettings.environment,
            'X-DT-Token': storedSettings.token,
            'X-DT-Budget': storedSettings.budget,
            'X-Bypass-Sprint-Check': 'true'
          },
          body: JSON.stringify({ journeyConfig: journey })
        });
        
        const result = await response.json();
        
        if (result.ok && result.success !== false) {
          statusEl.innerHTML = `âœ… Dashboard created successfully!<br>ID: ${result.dashboardId}<br><br><a href="${result.dashboardUrl}" target="_blank" style="color: #64b5f6; text-decoration: underline;">Open Dashboard â†’</a>`;
          statusEl.className = 'mt-3 p-3 bg-green-900 bg-opacity-50 rounded text-xs font-mono text-green-300 cursor-pointer';
        } else {
          statusEl.textContent = `âŒ Deployment failed: ${result.error}`;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
        }
      } catch (error) {
        statusEl.textContent = `âŒ Request failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-xs font-mono text-red-300';
      }
    };
    
    // ============================================
    // Dynatrace Settings Management (Secure Storage)
    // ============================================
    
    // Storage keys already defined at top of script
    
    // ONE-TIME CLEANUP: Fix corrupted localStorage where keys got swapped
    (function cleanupCorruptedStorage() {
      const encKeyData = localStorage.getItem(window.DT_ENCRYPTION_KEY);
      const settingsData = localStorage.getItem(window.DT_SETTINGS_KEY);
      
      // Clear ALL encryption-related data (OAuth SSO doesn't need it)
      console.log('[Startup] Cleaning up old encryption data (OAuth SSO mode)...');
      localStorage.removeItem(window.DT_ENCRYPTION_KEY);
      
      // If settings exist and contain encrypted tokens, clear them too
      if (settingsData) {
        try {
          const parsed = JSON.parse(settingsData);
          // If settings contain encrypted token data, clear it
          if (parsed && parsed.token && typeof parsed.token === 'string' && parsed.token.length > 100) {
            console.log('[Startup] Removing old encrypted token data...');
            parsed.token = null;
            localStorage.setItem(window.DT_SETTINGS_KEY, JSON.stringify(parsed));
          }
        } catch (e) {
          // If can't parse, leave it
          console.warn('[Startup] Could not parse settings:', e.message);
        }
      }
      
      console.log('[Startup] OAuth SSO mode - encryption not needed');
    })();
    
    // Check Web Crypto API availability
    function isWebCryptoAvailable() {
      return window.crypto && window.crypto.subtle;
    }
    
    // Check if we're in a secure context
    function checkSecureContext() {
      const isSecure = window.isSecureContext;
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      
      console.log('[Security Check]', {
        isSecureContext: isSecure,
        protocol: protocol,
        hostname: hostname,
        hasCrypto: !!window.crypto,
        hasSubtle: !!(window.crypto && window.crypto.subtle),
        currentURL: window.location.href
      });
      
      return {isSecure, protocol, hostname};
    }
    
    // Generate or retrieve encryption key
    async function getEncryptionKey() {
      const secureCheck = checkSecureContext();
      
      if (!isWebCryptoAvailable()) {
        let errorMsg = 'Web Crypto API not available.\n\n';
        errorMsg += `Current URL: ${window.location.href}\n`;
        errorMsg += `Protocol: ${secureCheck.protocol}\n`;
        errorMsg += `Secure Context: ${secureCheck.isSecure ? 'Yes' : 'No'}\n\n`;
        
        if (secureCheck.protocol === 'http:') {
          errorMsg += 'âŒ You are using HTTP (insecure)\n';
          errorMsg += 'âœ… Please use HTTPS instead:\n';
          errorMsg += `   https://${secureCheck.hostname}`;
        } else {
          errorMsg += 'âš ï¸ HTTPS detected but Web Crypto unavailable.\n';
          errorMsg += 'Try: Close all tabs and reopen with https://';
        }
        
        throw new Error(errorMsg);
      }
      
      let keyData = localStorage.getItem(window.DT_ENCRYPTION_KEY);
      
      console.log('[Crypto] Raw keyData from localStorage:', keyData ? keyData.substring(0, 100) + '...' : 'null');
      
      if (!keyData) {
        console.log('[Crypto] Generating new encryption key...');
        // Generate new key
        const key = await window.crypto.subtle.generateKey(
          { name: 'AES-GCM', length: 256 },
          true,
          ['encrypt', 'decrypt']
        );
        
        // Export and store
        const exported = await window.crypto.subtle.exportKey('jwk', key);
        console.log('[Crypto] Key exported:', { hasKty: !!exported.kty, hasK: !!exported.k });
        console.log('[Crypto] Key generated and exported successfully');
        console.log('[Crypto] About to save encryption key to:', window.DT_ENCRYPTION_KEY);
        localStorage.setItem(window.DT_ENCRYPTION_KEY, JSON.stringify(exported));
        console.log('[Crypto] Key saved to localStorage');
        
        // Verify
        const verify = localStorage.getItem(window.DT_ENCRYPTION_KEY);
        if (verify) {
          const parsed = JSON.parse(verify);
          console.log('[Crypto] Verification - saved key has kty:', !!parsed.kty, 'hasK:', !!parsed.k);
        }
        
        return key;
      }
      
      // Import existing key with validation
      try {
        const keyJson = JSON.parse(keyData);
        
        console.log('[Crypto] Parsed keyJson type:', typeof keyJson);
        console.log('[Crypto] Parsed keyJson keys:', Object.keys(keyJson || {}));
        console.log('[Crypto] Validating key structure:', {
          hasKty: !!keyJson.kty,
          hasK: !!keyJson.k,
          kty: keyJson.kty
        });
        
        // Validate JWK structure
        if (!keyJson.kty || !keyJson.k) {
          console.warn('[Crypto] Invalid key in storage, regenerating...');
          localStorage.removeItem(window.DT_ENCRYPTION_KEY);
          localStorage.removeItem(window.DT_SETTINGS_KEY); // Clear old encrypted data
          console.log('[Crypto] Cleared old encrypted settings (key changed)');
          return await getEncryptionKey(); // Recursive call to regenerate
        }
        
        console.log('[Crypto] Importing existing key...');
        return await window.crypto.subtle.importKey(
          'jwk',
          keyJson,
          { name: 'AES-GCM', length: 256 },
          true,
          ['encrypt', 'decrypt']
        );
      } catch (error) {
        console.error('[Crypto] Failed to import key, regenerating:', error.message);
        localStorage.removeItem(window.DT_ENCRYPTION_KEY);
        localStorage.removeItem(window.DT_SETTINGS_KEY); // Clear old encrypted data
        console.log('[Crypto] Cleared old encrypted settings (key changed)');
        return await getEncryptionKey(); // Recursive call to regenerate
      }
    }
    
    // Encrypt data
    async function encryptData(data) {
      const key = await getEncryptionKey();
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const encoded = new TextEncoder().encode(data);
      
      const encrypted = await window.crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv },
        key,
        encoded
      );
      
      return {
        iv: Array.from(iv),
        data: Array.from(new Uint8Array(encrypted))
      };
    }
    
    // Decrypt data
    async function decryptData(encrypted) {
      const key = await getEncryptionKey();
      const iv = new Uint8Array(encrypted.iv);
      const data = new Uint8Array(encrypted.data);
      
      const decrypted = await window.crypto.subtle.decrypt(
        { name: 'AES-GCM', iv: iv },
        key,
        data
      );
      
      return new TextDecoder().decode(decrypted);
    }
    
    // Save settings securely
    async function saveDynatraceSettings() {
      const mcpServerUrl = document.getElementById('dt-mcp-server-input').value.trim();
      const environmentUrl = document.getElementById('dt-environment-input').value.trim();
      const budget = document.getElementById('dt-budget-input').value || '100';
      
      if (!mcpServerUrl) {
        showDtStatus('error', 'Missing MCP Server URL', 'Please provide Dynatrace MCP Server URL');
        return;
      }
      
      if (!environmentUrl) {
        showDtStatus('error', 'Missing Environment URL', 'Please provide your Dynatrace tenant URL');
        return;
      }
      
      console.log('[Settings] Saving MCP server configuration');
      
      // Validate URL formats
      if (!mcpServerUrl.startsWith('http://') && !mcpServerUrl.startsWith('https://')) {
        showDtStatus('error', 'Invalid URL', 'MCP Server URL must start with http:// or https://');
        return;
      }
      
      if (!environmentUrl.startsWith('http://') && !environmentUrl.startsWith('https://')) {
        showDtStatus('error', 'Invalid URL', 'Environment URL must start with http:// or https://');
        return;
      }
      
      try {
        const settings = {
          mcpServerUrl: mcpServerUrl,
          environmentUrl: environmentUrl,
          budget: budget,
          savedAt: new Date().toISOString()
        };
        
        localStorage.setItem(window.DT_SETTINGS_KEY, JSON.stringify(settings));
        console.log('[Settings] Settings saved successfully');
        
        showDtStatus('success', 'âœ… Settings Saved!', 'OAuth SSO will be used automatically when deploying dashboards');
        updateSettingsIndicator(true);
        
        // Close modal after brief delay
        setTimeout(() => {
          closeDynatraceSettings();
        }, 1500);
        
      } catch (error) {
        console.error('[Settings] Save error:', error);
        let errorMessage = error.message || 'Encryption failed';
        
        // Provide helpful error message if it's a crypto issue
        if (errorMessage.includes('kty') || errorMessage.includes('JWK')) {
          errorMessage = 'Encryption key error. Clearing and regenerating...\n\nPlease try saving again.';
          // Clear corrupted key
          localStorage.removeItem(window.DT_ENCRYPTION_KEY);
        }
        
        showDtStatus('error', 'Failed to save settings', errorMessage);
      }
    }
    
    // Auto-detect MCP server URL based on deployment context
    function detectMcpServerUrl() {
      const currentHost = window.location.hostname;
      
      // If running on localhost, MCP is likely on localhost:3000
      if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
        return 'http://localhost:3000';
      }
      
      // If running on remote server, MCP runs on same host with port 3000 (always HTTP)
      // Note: MCP server runs on HTTP, not HTTPS, even if main app uses HTTPS
      return `http://${currentHost}:3000`;
    }
    
    // Load settings
    async function loadDynatraceSettings() {
      console.log('[Settings] Loading MCP server configuration...');
      const settingsJson = localStorage.getItem(window.DT_SETTINGS_KEY);
      
      // Auto-detect MCP server URL as default
      const defaultMcpUrl = detectMcpServerUrl();
      
      if (!settingsJson) {
        console.log('[Settings] No settings found, using auto-detected MCP URL:', defaultMcpUrl);
        return {
          mcpServerUrl: defaultMcpUrl,
          environmentUrl: null,
          budget: '100'
        };
      }
      
      try {
        const settings = JSON.parse(settingsJson);
        
        console.log('[Settings] MCP server configuration loaded');
        
        // Use auto-detected URL if not explicitly configured
        const result = {
          mcpServerUrl: settings.mcpServerUrl || defaultMcpUrl,
          environmentUrl: settings.environmentUrl || null,
          environment: settings.environment || null, // Legacy
          budget: settings.budget || '100'
        };
        
        console.log('[Settings] Loaded settings:', {
          mcpServerUrl: result.mcpServerUrl,
          environmentUrl: result.environmentUrl,
          budget: result.budget
        });
        
        return result;
      } catch (error) {
        console.error('[Settings] Error loading settings:', error);
        localStorage.removeItem(window.DT_SETTINGS_KEY);
        return null;
      }
    }
    
    // Clear settings
    function clearDynatraceSettings() {
      if (confirm('Are you sure you want to clear all Dynatrace settings? This cannot be undone.')) {
        localStorage.removeItem(window.DT_SETTINGS_KEY);
        localStorage.removeItem('dt-mcp-session'); // Clear OAuth session
        
        document.getElementById('dt-mcp-server-input').value = '';
        document.getElementById('dt-budget-input').value = '100';
        
        showDtStatus('success', 'Settings Cleared', 'All settings have been removed from local storage');
        updateSettingsIndicator(false);
      }
    }
    
    // OAuth SSO Authentication via Local MCP Server
    async function authenticateWithOAuth() {
      const mcpServerUrl = document.getElementById('dt-mcp-server-input').value.trim();
      const environmentUrl = document.getElementById('dt-environment-input').value.trim();
      
      if (!mcpServerUrl) {
        showDtStatus('error', 'Missing MCP Server URL', 'Please enter MCP Server URL first');
        return;
      }
      
      if (!environmentUrl) {
        showDtStatus('error', 'Missing Environment URL', 'Please enter your Dynatrace tenant URL first');
        return;
      }
      
      showDtStatus('loading', 'ğŸ” Initiating OAuth...', 'Requesting authentication from MCP server');
      
      try {
        // Call local MCP server to initiate OAuth
        const response = await fetch(`${mcpServerUrl}/api/mcp/init-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ environment: environmentUrl })
        });
        
        if (!response.ok) {
          throw new Error(`MCP server returned ${response.status}`);
        }
        
        const result = await response.json();
        console.log('[OAuth] Session initialized:', result.sessionId);
        
        // Store session ID for later use
        localStorage.setItem('dt-mcp-session', JSON.stringify({
          sessionId: result.sessionId,
          environment: environmentUrl,
          mcpServer: mcpServerUrl,
          initiatedAt: new Date().toISOString()
        }));
        
        showDtStatus('info', 'ğŸ”“ Opening Authentication Window', 'Please sign in with your Dynatrace SSO credentials');
        
        // Open OAuth URL in popup window
        const authWindow = window.open(
          result.authUrl, 
          'dynatrace-sso-oauth',
          'width=600,height=800,toolbar=no,menubar=no,location=no'
        );
        
        // Listen for authentication success message
        window.addEventListener('message', handleOAuthCallback);
        
        // Poll for authentication status
        pollAuthStatus(result.sessionId, mcpServerUrl);
        
      } catch (error) {
        console.error('[OAuth] Authentication error:', error);
        showDtStatus('error', 'OAuth Failed', `Could not initiate authentication: ${error.message}`);
      }
    }
    
    // Handle OAuth callback message from popup
    function handleOAuthCallback(event) {
      if (event.data && event.data.type === 'mcp-authenticated') {
        console.log('[OAuth] Received authentication success message');
        const sessionData = JSON.parse(localStorage.getItem('dt-mcp-session') || '{}');
        
        if (sessionData.sessionId === event.data.sessionId) {
          showDtStatus('success', 'âœ… Authentication Successful!', 'You are now authenticated. You can deploy dashboards.');
          updateSessionStatus(true, 'Authentication complete - ready to deploy dashboards!');
          window.removeEventListener('message', handleOAuthCallback);
        }
      }
    }
    
    // Poll MCP server to check authentication status
    async function pollAuthStatus(sessionId, mcpServerUrl, attempts = 0) {
      const maxAttempts = 60; // 60 seconds
      
      if (attempts >= maxAttempts) {
        showDtStatus('error', 'Authentication Timeout', 'OAuth authentication took too long. Please try again.');
        updateSessionStatus(false, 'Authentication timeout - please try again');
        return;
      }
      
      try {
        const response = await fetch(`${mcpServerUrl}/api/mcp/session-status/${sessionId}`);
        const status = await response.json();
        
        if (status.authenticated) {
          console.log('[OAuth] Session authenticated successfully');
          showDtStatus('success', 'âœ… Authenticated!', `Connected to ${status.environment}`);
          updateSessionStatus(true, `Connected to ${status.environment}`, status.expiresIn);
          
          // Update local storage with authentication confirmation
          const sessionData = JSON.parse(localStorage.getItem('dt-mcp-session') || '{}');
          sessionData.authenticated = true;
          sessionData.authenticatedAt = new Date().toISOString();
          sessionData.expiresIn = status.expiresIn;
          localStorage.setItem('dt-mcp-session', JSON.stringify(sessionData));
          
          updateSettingsIndicator(true);
          return;
        }
        
        // Continue polling
        setTimeout(() => pollAuthStatus(sessionId, mcpServerUrl, attempts + 1), 1000);
        
      } catch (error) {
        console.error('[OAuth] Status check error:', error);
        setTimeout(() => pollAuthStatus(sessionId, mcpServerUrl, attempts + 1), 1000);
      }
    }
    
    // Check current authentication status
    async function checkAuthStatus() {
      const sessionData = JSON.parse(localStorage.getItem('dt-mcp-session') || 'null');
      
      if (!sessionData || !sessionData.sessionId) {
        showDtStatus('info', 'Not Authenticated', 'Click "Authenticate with SSO OAuth" to sign in');
        updateSessionStatus(false, 'No active session - please authenticate');
        return;
      }
      
      const mcpServerUrl = sessionData.mcpServer || document.getElementById('dt-mcp-server-input').value.trim();
      
      if (!mcpServerUrl) {
        showDtStatus('error', 'No MCP Server URL', 'Please configure MCP server URL');
        updateSessionStatus(false, 'MCP server not configured');
        return;
      }
      
      showDtStatus('loading', 'Checking status...', 'Verifying authentication with MCP server');
      
      try {
        const response = await fetch(`${mcpServerUrl}/api/mcp/session-status/${sessionData.sessionId}`);
        const status = await response.json();
        
        if (status.authenticated) {
          const expiresMinutes = Math.floor(status.expiresIn / 60);
          showDtStatus('success', 'âœ… Authenticated', `Session valid for ${expiresMinutes} minutes`);
          updateSessionStatus(true, `Session valid - expires in ${expiresMinutes} minutes`, status.expiresIn);
        } else {
          showDtStatus('info', 'Session Expired', status.message || 'Please authenticate again');
          updateSessionStatus(false, status.message || 'Session expired - please re-authenticate');
          localStorage.removeItem('dt-mcp-session');
        }
      } catch (error) {
        console.error('[Auth] Status check error:', error);
        showDtStatus('error', 'Check Failed', `Could not verify authentication: ${error.message}`);
        updateSessionStatus(false, 'Cannot reach MCP server - check if it is running');
      }
    }
    
    // ============================================
    // MCP Console Functions
    // ============================================
    
    function openMcpConsole() {
      const modal = document.getElementById('mcp-console-modal');
      modal.classList.remove('hidden');
      document.getElementById('mcp-console-input').focus();
    }
    
    function closeMcpConsole() {
      const modal = document.getElementById('mcp-console-modal');
      modal.classList.add('hidden');
    }
    
    function clearMcpConsole() {
      const messagesDiv = document.getElementById('mcp-chat-messages');
      // Keep only the welcome message
      const welcomeMsg = messagesDiv.querySelector('.flex');
      messagesDiv.innerHTML = '';
      if (welcomeMsg) {
        messagesDiv.appendChild(welcomeMsg.cloneNode(true));
      }
    }
    
    function addMcpMessage(content, isUser = false) {
      const messagesDiv = document.getElementById('mcp-chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3 items-start';
      
      if (isUser) {
        // User message (right-aligned)
        messageDiv.innerHTML = `
          <div class="flex-1"></div>
          <div class="flex-1 bg-dtpurple/30 border border-dtpurple rounded-lg p-4">
            <p class="text-sm text-white">${content}</p>
          </div>
          <div class="w-8 h-8 rounded-full bg-dtpurple flex items-center justify-center flex-shrink-0">
            <span class="text-white font-bold">ğŸ‘¤</span>
          </div>
        `;
      } else {
        // Bot message (left-aligned)
        messageDiv.innerHTML = `
          <div class="w-8 h-8 rounded-full bg-dtcyan flex items-center justify-center flex-shrink-0">
            <span class="text-black font-bold">ğŸ¤–</span>
          </div>
          <div class="flex-1 bg-dtcard border border-dtborder rounded-lg p-4">
            <p class="text-sm text-gray-300 whitespace-pre-wrap">${content}</p>
          </div>
        `;
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function setMcpStatus(icon, text) {
      document.getElementById('mcp-status-icon').textContent = icon;
      document.getElementById('mcp-status-text').textContent = text;
    }
    
    async function sendMcpMessage() {
      const input = document.getElementById('mcp-console-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // Add user message to chat
      addMcpMessage(message, true);
      input.value = '';
      
      // Show loading status
      setMcpStatus('â³', 'Sending...');
      
      try {
        // Get session from localStorage
        const sessionData = JSON.parse(localStorage.getItem('dt-mcp-session') || 'null');
        
        if (!sessionData || !sessionData.sessionId) {
          addMcpMessage('âš ï¸ Error: No active MCP session. Please authenticate first in MCP Settings.', false);
          setMcpStatus('âŒ', 'Not authenticated');
          return;
        }
        
        const mcpServerUrl = sessionData.mcpServer || 'http://localhost:3000';
        
        // Send message to MCP server
        const response = await fetch(`${mcpServerUrl}/api/mcp/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionData.sessionId,
            message: message,
            context: {
              timestamp: new Date().toISOString()
            }
          })
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            addMcpMessage('ğŸ”’ Session expired. Please re-authenticate in MCP Settings.', false);
            setMcpStatus('âŒ', 'Session expired');
            return;
          }
          throw new Error(`Server returned ${response.status}`);
        }
        
        const result = await response.json();
        
        // Add bot response to chat
        addMcpMessage(result.message || result.response || 'No response from server', false);
        setMcpStatus('ğŸŸ¢', 'Ready');
        
      } catch (error) {
        console.error('[MCP Console] Error:', error);
        addMcpMessage(`âŒ Error: ${error.message}\n\nMake sure the MCP server is running and you are authenticated.`, false);
        setMcpStatus('âŒ', 'Error');
      }
    }
    
    // Make MCP Console functions globally available
    window.openMcpConsole = openMcpConsole;
    window.closeMcpConsole = closeMcpConsole;
    window.clearMcpConsole = clearMcpConsole;
    window.sendMcpMessage = sendMcpMessage;
    
    // Test connection with MCP server
    async function testDynatraceConnection() {
      const mcpServerUrl = document.getElementById('dt-mcp-server-input').value.trim();
      const environmentUrl = document.getElementById('dt-environment-input').value.trim();
      
      if (!mcpServerUrl) {
        showDtStatus('error', 'Missing MCP Server URL', 'Please enter MCP Server URL');
        return;
      }
      
      if (!environmentUrl) {
        showDtStatus('error', 'Missing Environment URL', 'Please enter your Dynatrace tenant URL');
        return;
      }
      
      showDtStatus('loading', 'Checking MCP Server...', 'Please wait while we verify the connection');
      
      try {
        // First check if MCP server is already running
        const statusResponse = await fetch('/api/mcp/status');
        const statusResult = await statusResponse.json();
        
        if (statusResult.running) {
          showDtStatus('success', 'âœ… MCP Server Already Running!', `Ready to deploy to ${environmentUrl}`);
          return;
        }
        
        // If not running, try to start it
        showDtStatus('loading', 'Starting MCP Server...', 'This may take a moment...');
        
        const portMatch = mcpServerUrl.match(/:(\d+)/);
        const port = portMatch ? parseInt(portMatch[1]) : 3000;
        
        const startResponse = await fetch('/api/mcp/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            environmentUrl: environmentUrl,
            port: port
          })
        });
        
        const startResult = await startResponse.json();
        
        if (!startResponse.ok) {
          showDtStatus('error', 'Failed to Start MCP Server', startResult.error || 'Unknown error');
          return;
        }
        
        // If already running, success immediately
        if (startResult.status === 'running' || startResult.status === 'already_running') {
          showDtStatus('success', 'âœ… MCP Server Connected!', `Ready to deploy to ${environmentUrl}`);
          return;
        }
        
        // If OAuth URL is provided, show it
        if (startResult.authUrl) {
          showDtStatus('info', 'ğŸ” OAuth Authentication Required', 
            `Please complete authentication in the popup window.\n\nWaiting for authorization...`);
          
          // Open OAuth URL in new window
          window.open(startResult.authUrl, '_blank', 'width=600,height=800');
        } else {
          showDtStatus('loading', 'MCP Server Starting...', 'Waiting for server initialization...');
        }
        
        // Poll for server status
        let attempts = 0;
        const maxAttempts = 60; // 60 seconds for OAuth
        
        const checkStatus = async () => {
          attempts++;
          
          try {
            const checkResponse = await fetch('/api/mcp/status');
            const checkResult = await checkResponse.json();
            
            if (checkResult.running) {
              showDtStatus('success', 'âœ… MCP Server Connected!', `Ready to deploy to ${environmentUrl}`);
            } else if (attempts < maxAttempts) {
              // Update status message periodically
              if (attempts % 10 === 0) {
                showDtStatus('loading', 'Still waiting...', `Attempt ${attempts}/${maxAttempts} - Please complete OAuth if prompted`);
              }
              setTimeout(checkStatus, 1000);
            } else {
              showDtStatus('error', 'Timeout', 'MCP server did not complete startup. Try clicking Test Connection again.');
            }
          } catch (error) {
            if (attempts < maxAttempts) {
              setTimeout(checkStatus, 1000);
            } else {
              showDtStatus('error', 'Connection Failed', 'Could not verify MCP server status');
            }
          }
        };
        
        setTimeout(checkStatus, 2000);
        
      } catch (error) {
        showDtStatus('error', 'Connection Failed', `Error: ${error.message}`);
      }
    }
    
    // Open Dynatrace settings modal and load existing settings
    async function openDynatraceSettings() {
      // Load existing settings if available
      const settings = await loadDynatraceSettings();
      
      if (settings) {
        document.getElementById('dt-mcp-server-input').value = settings.mcpServerUrl || '';
        document.getElementById('dt-environment-input').value = settings.environmentUrl || '';
        document.getElementById('dt-budget-input').value = settings.budget || '100';
      }
      
      // Show modal logic...
    }
    
    // DEPRECATED OAuth SSO functions (kept for backward compatibility)
    async function OLD_testDynatraceConnection_OAuth() {
      const environment = document.getElementById('dt-environment-input').value.trim();
      
      if (!environment) {
        showDtStatus('error', 'Missing Environment', 'Please enter Dynatrace Environment URL');
        return;
      }
      
      showDtStatus('loading', 'Testing connection...', 'Initiating OAuth SSO login');
      
      try {
        // First save the environment
        const settings = {
          environment,
          budget: document.getElementById('dt-budget-input').value || '100',
          savedAt: new Date().toISOString()
        };
        localStorage.setItem(window.DT_SETTINGS_KEY, JSON.stringify(settings));
        
        // Trigger OAuth login flow
        showDtStatus('info', 'ğŸ” OAuth SSO Login', 'Opening authentication window...');
        
        const response = await fetch('/api/oauth/authorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ environment })
        });
        
        const result = await response.json();
        
        if (result.ok && result.authorizationUrl) {
          // Open authorization URL in new window
          const authWindow = window.open(result.authorizationUrl, 'dynatrace-oauth', 'width=600,height=700');
          
          showDtStatus('info', 'ğŸ” Sign In Required', 'Please sign in to Dynatrace in the popup window. The window will close automatically after signing in.');
          
          // Listen for OAuth success message from popup
          const messageHandler = (event) => {
            console.log('[OAuth Test] Received postMessage:', event.data);
            if (event.data && event.data.type === 'oauth-success') {
              console.log('[OAuth Test] OAuth success message confirmed!');
              // Force close the popup window
              if (authWindow && !authWindow.closed) {
                console.log('[OAuth Test] Closing auth window...');
                authWindow.close();
              }
              // Check token status immediately
              checkTokenStatus();
            }
          };
          console.log('[OAuth Test] Message listener attached');
          window.addEventListener('message', messageHandler);
          
          // Function to check token status
          const checkTokenStatus = async () => {
            try {
              const tokenCheck = await fetch('/api/oauth/token-status');
              const tokenResult = await tokenCheck.json();
              
              if (tokenResult.hasToken) {
                clearInterval(pollInterval);
                window.removeEventListener('message', messageHandler);
                if (authWindow && !authWindow.closed) {
                  authWindow.close();
                }
                showDtStatus('success', 'âœ… Connection Successful!', `Authenticated with ${environment} via OAuth SSO`);
              }
            } catch (error) {
              console.error('[OAuth] Token check error:', error);
            }
          };
          
          // Poll for OAuth completion (backup mechanism)
          const pollInterval = setInterval(checkTokenStatus, 2000);
          
          // Stop polling after 5 minutes
          setTimeout(() => {
            clearInterval(pollInterval);
            window.removeEventListener('message', messageHandler);
          }, 300000);
        } else {
          showDtStatus('error', 'OAuth Failed', result.error || 'Could not initiate OAuth flow');
        }
      } catch (error) {
        console.error('Connection test error:', error);
        showDtStatus('error', 'Connection Failed', error.message);
      }
    }
    
    // UI Helpers
    function openDynatraceSettings() {
      document.getElementById('dynatrace-settings-modal').classList.remove('hidden');
      
      // Load existing settings with auto-detection
      loadDynatraceSettings().then(settings => {
        if (settings) {
          document.getElementById('dt-mcp-server-input').value = settings.mcpServerUrl || '';
          document.getElementById('dt-environment-input').value = settings.environmentUrl || '';
          document.getElementById('dt-budget-input').value = settings.budget || '100';
          console.log('[Settings] Loaded and populated:', settings.mcpServerUrl);
        }
      }).catch(error => {
        console.error('[Settings] Load error:', error);
      });
    }
    
    function closeDynatraceSettings() {
      document.getElementById('dynatrace-settings-modal').classList.add('hidden');
      document.getElementById('dt-connection-status').classList.add('hidden');
    }
    
    function showDtStatus(type, title, detail) {
      const statusDiv = document.getElementById('dt-connection-status');
      const iconSpan = document.getElementById('dt-status-icon');
      const textSpan = document.getElementById('dt-status-text');
      const detailSpan = document.getElementById('dt-status-detail');
      
      const configs = {
        success: { icon: 'âœ…', bgClass: 'bg-green-900/30', borderClass: 'border-green-500' },
        error: { icon: 'âŒ', bgClass: 'bg-red-900/30', borderClass: 'border-red-500' },
        loading: { icon: 'â³', bgClass: 'bg-blue-900/30', borderClass: 'border-blue-500' },
        info: { icon: 'ğŸ’¡', bgClass: 'bg-dtcyan/20', borderClass: 'border-dtcyan' }
      };
      
      const config = configs[type] || configs.info;
      
      statusDiv.className = `p-4 rounded-lg ${config.bgClass} border ${config.borderClass}`;
      iconSpan.textContent = config.icon;
      textSpan.textContent = title;
      detailSpan.textContent = detail;
      
      statusDiv.classList.remove('hidden');
    }
    
    // Update the prominent session status banner
    function updateSessionStatus(authenticated, detail = null, expiresIn = null) {
      const statusDiv = document.getElementById('dt-session-status');
      const iconSpan = document.getElementById('dt-session-icon');
      const textSpan = document.getElementById('dt-session-text');
      const detailSpan = document.getElementById('dt-session-detail');
      
      if (authenticated) {
        // Authenticated state - green
        statusDiv.className = 'p-4 rounded-lg border-2 transition-all bg-green-900/20 border-green-500';
        iconSpan.textContent = 'ğŸŸ¢';
        textSpan.textContent = 'Authenticated';
        textSpan.className = 'font-bold text-lg text-green-400';
        
        if (expiresIn) {
          const minutes = Math.floor(expiresIn / 60);
          detailSpan.textContent = detail || `Session active - expires in ${minutes} minutes`;
        } else {
          detailSpan.textContent = detail || 'Ready to deploy dashboards!';
        }
        detailSpan.className = 'text-sm mt-1 text-green-300';
      } else {
        // Not authenticated state - neutral/red
        statusDiv.className = 'p-4 rounded-lg border-2 transition-all bg-red-900/10 border-red-500/50';
        iconSpan.textContent = 'ğŸ”’';
        textSpan.textContent = 'Not Authenticated';
        textSpan.className = 'font-bold text-lg text-red-400';
        detailSpan.textContent = detail || 'Click "Authenticate with SSO OAuth" to connect to Dynatrace';
        detailSpan.className = 'text-sm mt-1 text-gray-400';
      }
    }
    
    function updateSettingsIndicator(hasSettings) {
      const indicator = document.getElementById('dt-settings-indicator');
      if (hasSettings) {
        indicator.textContent = 'MCP Configured âœ“';
        indicator.parentElement.classList.add('border-dtgreen', 'bg-dtgreen/20');
        indicator.parentElement.classList.remove('border-dtpurple', 'bg-dtpurple/20');
      } else {
        indicator.textContent = 'MCP Settings';
        indicator.parentElement.classList.remove('border-dtgreen', 'bg-dtgreen/20');
        indicator.parentElement.classList.add('border-dtpurple', 'bg-dtpurple/20');
      }
    }
    
    // Make functions globally available
    window.openDynatraceSettings = openDynatraceSettings;
    window.closeDynatraceSettings = closeDynatraceSettings;
    window.saveDynatraceSettings = saveDynatraceSettings;
    window.clearDynatraceSettings = clearDynatraceSettings;
    window.testDynatraceConnection = testDynatraceConnection;
    window.toggleTokenVisibility = toggleTokenVisibility;
    window.loadDynatraceSettings = loadDynatraceSettings;
    window.authenticateWithOAuth = authenticateWithOAuth;
    window.checkAuthStatus = checkAuthStatus;
    
    // ============================================
    // OAuth SSO Login Flow
    // ============================================
    
    // Login with OAuth SSO (MCP server style - automatic, simple)
    async function loginWithOAuthSSO() {
      const statusEl = document.getElementById('dynatrace-status');
      
      try {
        // Load environment from settings
        const settings = await loadDynatraceSettings();
        
        if (!settings || !settings.environment) {
          statusEl.innerHTML = `
            <div style="line-height: 1.6;">
              <strong>âŒ Environment Not Configured</strong><br><br>
              Please add your Dynatrace Environment URL in Settings first.<br><br>
              <button onclick="openDynatraceSettings()" 
                      style="padding: 12px 24px; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                âš™ï¸ Open Settings
              </button>
            </div>
          `;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-sm text-red-300 border border-red-600';
          return;
        }
        
        // Trigger OAuth authorization flow (PKCE - no client secret needed!)
        statusEl.textContent = 'ğŸ” Initiating OAuth SSO login...';
        statusEl.className = 'mt-3 p-3 bg-purple-900 bg-opacity-50 rounded text-sm text-purple-300 border border-purple-600';
        
        const response = await fetch('/api/oauth/authorize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            environment: settings.environment
          })
        });
        
        const result = await response.json();
        
        if (result.ok && result.authorizationUrl) {
          // Open authorization URL in new window
          const authWindow = window.open(result.authorizationUrl, 'dynatrace-oauth', 'width=600,height=700');
          
          statusEl.innerHTML = `
            <div style="line-height: 1.6;">
              <strong>ğŸ” OAuth SSO Login</strong><br><br>
              A new window has opened for you to sign in to Dynatrace.<br>
              After signing in, the window will close automatically.<br><br>
              <em>If the window didn't open, <a href="${result.authorizationUrl}" target="_blank" style="color: #64b5f6; text-decoration: underline;">click here</a>.</em>
            </div>
          `;
          
          // Listen for OAuth success message from popup
          const messageHandler = (event) => {
            console.log('[OAuth Parent] Received postMessage:', event.data);
            if (event.data && event.data.type === 'oauth-success') {
              console.log('[OAuth Parent] OAuth success message confirmed!');
              if (authWindow && !authWindow.closed) {
                console.log('[OAuth Parent] Closing auth window...');
                authWindow.close();
              }
              checkTokenStatus();
            }
          };
          console.log('[OAuth Parent] Message listener attached');
          window.addEventListener('message', messageHandler);
          
          // Function to check token and proceed with deployment
          const checkTokenStatus = async () => {
            try {
              const tokenCheck = await fetch('/api/oauth/token-status');
              const tokenResult = await tokenCheck.json();
              
              if (tokenResult.hasToken) {
                clearInterval(pollInterval);
                window.removeEventListener('message', messageHandler);
                if (authWindow && !authWindow.closed) {
                  authWindow.close();
                }
                
                // OAuth token received - server will handle authentication
                console.log('[OAuth] Token received successfully');
                
                statusEl.innerHTML = `
                  <div style="line-height: 1.6;">
                    <strong>âœ… OAuth SSO Login Successful!</strong><br><br>
                    You're now authenticated and can deploy dashboards.<br><br>
                    <button onclick="deployDynatraceDashboard()" 
                            style="padding: 12px 24px; background: #7c4dff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                      ğŸš€ Deploy Dashboard Now
                    </button>
                  </div>
                `;
                statusEl.className = 'mt-3 p-3 bg-green-900 bg-opacity-50 rounded text-sm text-green-300 border border-green-600';
              }
            } catch (error) {
              console.error('[OAuth] Token check error:', error);
            }
          };
          
          // Poll for OAuth completion (backup mechanism)
          const pollInterval = setInterval(checkTokenStatus, 2000);
          
          // Stop polling after 5 minutes
          setTimeout(() => {
            clearInterval(pollInterval);
            window.removeEventListener('message', messageHandler);
          }, 300000);
        } else {
          statusEl.innerHTML = `
            <div style="line-height: 1.6;">
              <strong>âŒ OAuth Authorization Failed</strong><br><br>
              ${result.error || 'Could not initiate OAuth flow'}<br><br>
              Please check your environment URL and try again.
            </div>
          `;
          statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-sm text-red-300 border border-red-600';
        }
        
      } catch (error) {
        console.error('[OAuth] Login error:', error);
        statusEl.textContent = `âŒ OAuth login failed: ${error.message}`;
        statusEl.className = 'mt-3 p-3 bg-red-900 bg-opacity-50 rounded text-sm text-red-300 border border-red-600';
      }
    }
    
    window.loginWithOAuthSSO = loginWithOAuthSSO;
    
    // Check if settings exist on page load
    setTimeout(() => {
      const settingsExist = localStorage.getItem(window.DT_SETTINGS_KEY);
      updateSettingsIndicator(!!settingsExist);
    }, 500);

  </script>
  <script>
    // ==========================================
    // AI AGENTS â€” Gremlin / Fix-It / Librarian / Dashboard
    // Isolated in own script block so main-script errors can't block registration
    // ==========================================
    (function() {
      'use strict';
      console.log('[AI Agents] Registering agent functions...');

      // --- Helpers ---
      function showResult(id, text) {
        var el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('hidden');
        el.querySelector('pre').textContent = typeof text === 'string' ? text : JSON.stringify(text, null, 2);
      }

      async function agentFetch(url, opts) {
        var res = await fetch(url, opts);
        return await res.json();
      }

      // ============ JOURNEY SELECTOR & PANEL SWITCHING ============

      var _selectedJourneyData = null;  // holds the full journey config
      var _cachedJourneys = [];         // cached list from server

      // Load journey list from server (only shows journeys with running services)
      async function loadJourneyList() {
        try {
          var sel = document.getElementById('agent-journey-select');
          sel.innerHTML = '<option value="">â³ Loading journeys...</option>';
          var data = await agentFetch('/api/admin/journeys');
          if (data.ok && data.journeys) {
            _cachedJourneys = data.journeys;

            var activeJourneys = data.journeys.filter(function(j) { return j.servicesRunning; });
            var activeCount = activeJourneys.length;
            var totalCount = data.count;

            sel.innerHTML = '<option value="">ğŸ¯ Select a journey (' + totalCount + ' journeys, ' + activeCount + ' active)</option>';

            // Group ALL journeys by company name â€” show active first, then inactive
            var grouped = {};
            data.journeys.forEach(function(j) {
              var group = j.companyName || 'Other';
              if (!grouped[group]) grouped[group] = [];
              grouped[group].push(j);
            });

            Object.keys(grouped).sort().forEach(function(company) {
              var optgroup = document.createElement('optgroup');
              optgroup.label = 'ğŸ¢ ' + company;
              // Sort: active journeys first
              grouped[company].sort(function(a, b) { return (b.servicesRunning ? 1 : 0) - (a.servicesRunning ? 1 : 0); });
              grouped[company].forEach(function(j) {
                var opt = document.createElement('option');
                opt.value = j.filename;
                if (j.servicesRunning) {
                  opt.textContent = 'ğŸŸ¢ ' + (j.journeyType || 'Journey') + ' (' + j.runningServiceCount + '/' + j.services.length + ' services)';
                } else {
                  opt.textContent = 'âšª ' + (j.journeyType || 'Journey') + ' (not running)';
                }
                optgroup.appendChild(opt);
              });
              sel.appendChild(optgroup);
            });
          }
        } catch (err) {
          console.error('[Agent Hub] Failed to load journeys:', err);
        }
      }

      // Select a journey and populate context panel
      window._agentSelectJourney = async function(filename) {
        if (!filename) {
          document.getElementById('agent-journey-context').classList.add('hidden');
          _selectedJourneyData = null;
          return;
        }

        // Find journey in cache
        var journey = _cachedJourneys.find(function(j) { return j.filename === filename; });
        if (!journey) return;

        // Load full config from server
        try {
          var configId = journey.id;
          var data = await agentFetch('/api/admin/configs/' + encodeURIComponent(configId));
          if (data.ok && data.config) {
            _selectedJourneyData = data.config;
          } else {
            _selectedJourneyData = journey;  // fallback to cached summary
          }
        } catch (err) {
          _selectedJourneyData = journey;
        }

        // Set it as window.lastJourney so all agents can use it
        window.lastJourney = {
          companyName: journey.companyName,
          industryType: journey.industryType,
          journeyType: journey.journeyType,
          domain: journey.domain,
          steps: journey.steps,
          additionalFields: (_selectedJourneyData && _selectedJourneyData.additionalFields) || {},
          customerProfile: (_selectedJourneyData && _selectedJourneyData.customerProfile) || {},
          traceMetadata: (_selectedJourneyData && _selectedJourneyData.traceMetadata) || {}
        };
        window.currentJourneyData = { journey: window.lastJourney };

        // Update context panel
        document.getElementById('agent-journey-context').classList.remove('hidden');
        document.getElementById('agent-ctx-company').textContent = journey.companyName || 'â€”';
        document.getElementById('agent-ctx-industry').textContent = journey.industryType || 'â€”';
        document.getElementById('agent-ctx-journey-type').textContent = journey.journeyType || 'â€”';
        document.getElementById('agent-ctx-step-count').textContent = journey.stepsCount || 0;

        // Build service cards
        var cardsHtml = journey.services.map(function(svc) {
          return '<span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium bg-dtcyan bg-opacity-10 text-dtcyan border border-dtcyan border-opacity-30 hover:bg-opacity-20 transition-all cursor-default">' +
            '<span class="w-2 h-2 rounded-full bg-dtgreen animate-pulse"></span>' + svc + '</span>';
        }).join('');
        document.getElementById('agent-service-cards').innerHTML = cardsHtml || '<span class="text-xs text-gray-500">No services</span>';

        // Build steps flow
        var stepsHtml = journey.steps.map(function(s, i) {
          var arrow = i < journey.steps.length - 1 ? '<span class="text-gray-600 mx-0.5">â†’</span>' : '';
          var catColor = s.category === 'Acquisition' ? 'text-dtgreen' : s.category === 'FulfilmentPreparation' ? 'text-dtorange' : s.category === 'Conversion' ? 'text-dtcyan' : 'text-dtpurple';
          return '<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-[11px] bg-black bg-opacity-50 border border-dtborder">' +
            '<span class="font-bold text-white">' + (i + 1) + '</span>' +
            '<span class="' + catColor + '">' + (s.stepName || s.name || 'Step') + '</span>' +
            '</span>' + arrow;
        }).join('');
        document.getElementById('agent-steps-flow').innerHTML = stepsHtml || '<span class="text-xs text-gray-500">No steps</span>';

        // Populate Gremlin target service dropdown
        var svcSelect = document.getElementById('gremlin-target-service');
        svcSelect.innerHTML = '<option value="all">All Services (Random)</option>';
        journey.services.forEach(function(svc) {
          var opt = document.createElement('option');
          opt.value = svc;
          opt.textContent = svc;
          svcSelect.appendChild(opt);
        });

        console.log('[Agent Hub] Journey selected:', journey.companyName, '-', journey.journeyType, '(' + journey.services.length + ' services)');
      };

      // Use current journey from Steps 1-3
      window._agentUseCurrentJourney = function() {
        var data = getJourneyData();
        if (!data || !data.steps || data.steps.length === 0) {
          showResult('gremlin-result', 'âš ï¸ No journey data from Steps 1-3. Configure a journey first, or select one from the dropdown.');
          return;
        }

        // Build summary for context panel
        var journey = {
          companyName: data.company,
          industryType: data.industry,
          journeyType: data.journeyType,
          services: [...new Set((data.steps || []).map(function(s) { return s.serviceName || ''; }).filter(Boolean))],
          stepsCount: data.steps.length,
          steps: data.steps
        };

        // Update context panel with same logic
        document.getElementById('agent-journey-context').classList.remove('hidden');
        document.getElementById('agent-ctx-company').textContent = journey.companyName || 'â€”';
        document.getElementById('agent-ctx-industry').textContent = journey.industryType || 'â€”';
        document.getElementById('agent-ctx-journey-type').textContent = journey.journeyType || 'â€”';
        document.getElementById('agent-ctx-step-count').textContent = journey.stepsCount || 0;

        var cardsHtml = journey.services.map(function(svc) {
          return '<span class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium bg-dtcyan bg-opacity-10 text-dtcyan border border-dtcyan border-opacity-30">' +
            '<span class="w-2 h-2 rounded-full bg-dtgreen animate-pulse"></span>' + svc + '</span>';
        }).join('');
        document.getElementById('agent-service-cards').innerHTML = cardsHtml || '<span class="text-xs text-gray-500">No services</span>';

        var stepsHtml = journey.steps.map(function(s, i) {
          var arrow = i < journey.steps.length - 1 ? '<span class="text-gray-600 mx-0.5">â†’</span>' : '';
          return '<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-[11px] bg-black bg-opacity-50 border border-dtborder">' +
            '<span class="font-bold text-white">' + (i + 1) + '</span>' +
            '<span class="text-dtcyan">' + (s.stepName || s.name || 'Step') + '</span>' +
            '</span>' + arrow;
        }).join('');
        document.getElementById('agent-steps-flow').innerHTML = stepsHtml || '<span class="text-xs text-gray-500">No steps</span>';

        var svcSelect = document.getElementById('gremlin-target-service');
        svcSelect.innerHTML = '<option value="all">All Services (Random)</option>';
        journey.services.forEach(function(svc) {
          var opt = document.createElement('option');
          opt.value = svc;
          opt.textContent = svc;
          svcSelect.appendChild(opt);
        });

        // Reset the dropdown indicator
        var sel = document.getElementById('agent-journey-select');
        sel.value = '';

        console.log('[Agent Hub] Using current journey:', journey.companyName, '(' + journey.services.length + ' services)');
      };

      // Refresh journey list
      window._agentRefreshJourneys = function() {
        loadJourneyList();
      };

      // Agent panel switching
      window._agentShowPanel = function(agent) {
        // Toggle tabs
        document.querySelectorAll('.agent-tab').forEach(function(tab) {
          tab.classList.remove('active');
          var tabAgent = tab.getAttribute('data-agent');
          // Reset to inactive style
          tab.className = tab.className.replace(/bg-\S+/g, '').replace(/text-\S+/g, '').replace(/border-\S+/g, '').trim();
          tab.classList.add('agent-tab', 'text-xs', 'px-4', 'py-2', 'rounded-full', 'border', 'transition-all', 'cursor-pointer',
            'bg-dtgray', 'text-gray-400', 'border-dtborder');
        });

        // Activate clicked tab
        var activeTab = document.querySelector('.agent-tab[data-agent="' + agent + '"]');
        if (activeTab) {
          activeTab.classList.add('active');
          // Remove inactive grays
          activeTab.classList.remove('bg-dtgray', 'text-gray-400', 'border-dtborder');
        }

        // Toggle panels
        document.querySelectorAll('.agent-panel').forEach(function(panel) {
          panel.classList.add('hidden');
        });
        var activePanel = document.getElementById('agent-panel-' + agent);
        if (activePanel) {
          activePanel.classList.remove('hidden');
        }

        // Populate dashboard journey selector when switching to dashboard tab
        if (agent === 'dashboard') {
          populateDashboardJourneySelect();
        }
      };

      // ============ GREMLIN ============

      async function loadGremlinRecipes() {
        try {
          var data = await agentFetch('/api/gremlin/recipes');
          var sel = document.getElementById('gremlin-recipe');
          if (!sel || !Array.isArray(data)) return;
          sel.innerHTML = data.map(function(r) {
            return '<option value="' + (r.type || r.id) + '">' + r.name + ' â€” ' + (r.description || '') + '</option>';
          }).join('');
        } catch (e) { console.warn('Failed to load gremlin recipes', e); }
      }

      window._agentInjectChaos = async function() {
        var recipe = document.getElementById('gremlin-recipe');
        var val = recipe ? recipe.value : '';
        var intensity = parseInt((document.getElementById('gremlin-intensity') || {}).value || '5');
        var duration = parseInt((document.getElementById('gremlin-duration') || {}).value || '120');
        if (!val) return alert('Select a recipe first');
        var company = (document.getElementById('companyName') || {}).value || 'Demo Company';
        var targetSvc = (document.getElementById('gremlin-target-service') || {}).value || 'all';
        showResult('gremlin-result', 'â³ Injecting chaos on ' + (targetSvc === 'all' ? 'all services' : targetSvc) + '...');
        try {
          var data = await agentFetch('/api/gremlin/inject', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ type: val, target: targetSvc, intensity: intensity, duration: duration, company: company })
          });
          showResult('gremlin-result', data);
          window._agentRefreshFaults();
        } catch (e) { showResult('gremlin-result', 'âŒ ' + e.message); }
      };

      window._agentSmartChaos = async function() {
        var input = (document.getElementById('gremlin-smart-input') || {}).value;
        if (!input || !input.trim()) return alert('Describe the chaos scenario');
        showResult('gremlin-result', 'â³ Processing smart chaos...');
        try {
          var data = await agentFetch('/api/gremlin/smart', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ goal: input.trim() })
          });
          showResult('gremlin-result', data);
          window._agentRefreshFaults();
        } catch (e) { showResult('gremlin-result', 'âŒ ' + e.message); }
      };

      window._agentRefreshFaults = async function() {
        try {
          var data = await agentFetch('/api/gremlin/active');
          var container = document.getElementById('gremlin-active-faults');
          if (!container) return;
          var faults = data.activeFaults || data || [];
          if (!Array.isArray(faults) || faults.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center text-xs py-4">No active faults</p>';
            return;
          }
          container.innerHTML = faults.map(function(f) {
            return '<div class="flex items-center justify-between py-2 border-b border-dtborder last:border-0">' +
              '<div><span class="text-red-400 font-semibold text-xs">' + (f.recipe || f.recipeId || f.type || 'unknown') + '</span>' +
              '<span class="text-gray-600 text-[10px] ml-2">' + (f.id || '') + '</span></div>' +
              '<button onclick="window._agentRevertOne(\'' + (f.id || '') + '\')" class="text-[10px] bg-dtgray text-white px-2 py-1 rounded hover:bg-red-600 transition-all">Revert</button></div>';
          }).join('');
        } catch (e) { console.warn('Failed to refresh active faults', e); }
      };

      window._agentRevertOne = async function(id) {
        try {
          var data = await agentFetch('/api/gremlin/revert/' + id, { method: 'POST' });
          showResult('gremlin-result', data);
          window._agentRefreshFaults();
        } catch (e) { showResult('gremlin-result', 'âŒ ' + e.message); }
      };

      window._agentRevertAll = async function() {
        if (!confirm('Revert ALL active faults?')) return;
        try {
          var data = await agentFetch('/api/gremlin/revert-all', { method: 'POST' });
          showResult('gremlin-result', data);
          window._agentRefreshFaults();
        } catch (e) { showResult('gremlin-result', 'âŒ ' + e.message); }
      };

      // ============ FIX-IT (Workflow-only â€” quick test button) ============

      window._fixitQuickTest = async function() {
        var btn = document.getElementById('fixit-test-btn');
        var status = document.getElementById('fixit-test-status');
        if (btn) btn.disabled = true;
        if (status) status.textContent = 'â³ Calling /api/fixit/auto...';
        showResult('fixit-result', 'â³ Running auto-fix endpoint test...');
        try {
          var data = await agentFetch('/api/fixit/auto', { method: 'POST' });
          showResult('fixit-result', data);
          if (status) status.textContent = 'âœ… Endpoint responded';
        } catch (e) {
          showResult('fixit-result', 'âŒ ' + e.message);
          if (status) status.textContent = 'âŒ Failed: ' + e.message;
        } finally {
          if (btn) btn.disabled = false;
        }
      };

      // ============ LIBRARIAN ============

      window._agentLibHistory = async function() {
        try {
          var data = await agentFetch('/api/librarian/history');
          var container = document.getElementById('librarian-history');
          if (!container) return;
          var items = data.history || data.entries || data.events || [];
          if (!Array.isArray(items) || items.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center text-xs py-4">No history entries yet</p>';
            return;
          }
          container.innerHTML = items.slice(0, 50).map(function(item) {
            var ts = item.timestamp ? new Date(item.timestamp).toLocaleString() : '';
            var summary = item.summary || item.description || item.action || JSON.stringify(item).substring(0, 120);
            return '<div class="py-2 border-b border-dtborder last:border-0">' +
              '<div class="flex justify-between"><span class="font-semibold text-dtcyan">' + (item.type || item.kind || item.action || 'event') + '</span>' +
              '<span class="text-gray-600 text-[10px]">' + ts + '</span></div>' +
              '<p class="text-gray-400 mt-0.5">' + summary + '</p></div>';
          }).join('');
        } catch (e) { console.warn('Failed to load librarian history', e); }
      };

      window._agentLibStats = async function() {
        try {
          var data = await agentFetch('/api/librarian/stats');
          var container = document.getElementById('librarian-stats');
          if (!container) return;
          var stats = data.stats || data;
          container.innerHTML = Object.entries(stats).map(function(pair) {
            return '<div class="flex justify-between py-0.5"><span class="text-gray-500">' + pair[0] + '</span><span class="text-white font-semibold">' + pair[1] + '</span></div>';
          }).join('');
        } catch (e) { console.warn('Failed to load librarian stats', e); }
      };

      window._agentLibSearch = async function() {
        var query = (document.getElementById('librarian-search-input') || {}).value;
        if (!query || !query.trim()) return alert('Enter a search term');
        showResult('librarian-result', 'â³ Searching...');
        try {
          var data = await agentFetch('/api/librarian/search', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ query: query.trim() })
          });
          showResult('librarian-result', data);
        } catch (e) { showResult('librarian-result', 'âŒ ' + e.message); }
      };

      window._agentLibTimeline = async function() {
        var id = (document.getElementById('librarian-timeline-id') || {}).value;
        if (!id || !id.trim()) return alert('Enter an incident ID');
        showResult('librarian-result', 'â³ Loading timeline...');
        try {
          var data = await agentFetch('/api/librarian/timeline/' + encodeURIComponent(id.trim()));
          showResult('librarian-result', data);
        } catch (e) { showResult('librarian-result', 'âŒ ' + e.message); }
      };

      // ============ DASHBOARD ============

      // Get journey data from the app's current state
      function getJourneyData() {
        var storedConfig = null;

        // Priority 1: window.lastJourney â€” set by main app after prompt generation
        // Contains { company, industry, journeyType, steps, additionalFields, customerProfile, traceMetadata }
        if (window.lastJourney && window.lastJourney.steps && window.lastJourney.steps.length > 0) {
          storedConfig = {
            company: window.lastJourney.companyName || window.lastJourney.company || '',
            industry: window.lastJourney.industryType || window.lastJourney.industry || '',
            journeyType: window.lastJourney.journeyType || '',
            steps: window.lastJourney.steps || [],
            additionalFields: window.lastJourney.additionalFields || {},
            customerProfile: window.lastJourney.customerProfile || {},
            traceMetadata: window.lastJourney.traceMetadata || {}
          };
          console.log('[AI Agents] Journey data from window.lastJourney:', storedConfig.company, storedConfig.steps.length, 'steps');
        }

        // Priority 2: window.currentJourneyData â€” the full parsed LLM response
        if (!storedConfig && window.currentJourneyData) {
          var cjd = window.currentJourneyData;
          var journey = cjd.journey || cjd;
          storedConfig = {
            company: journey.companyName || journey.company || cjd.companyName || '',
            industry: journey.industryType || journey.industry || cjd.industryType || '',
            journeyType: journey.journeyType || cjd.journeyType || '',
            steps: journey.steps || [],
            additionalFields: cjd.additionalFields || journey.additionalFields || {},
            customerProfile: cjd.customerProfile || journey.customerProfile || {},
            traceMetadata: cjd.traceMetadata || journey.traceMetadata || {}
          };
          console.log('[AI Agents] Journey data from window.currentJourneyData:', storedConfig.company, storedConfig.steps.length, 'steps');
        }

        // Priority 3: Try parsing the Step 3 output textarea/pre
        if (!storedConfig) {
          try {
            var raw = document.getElementById('journey-output-step3');
            if (raw && raw.textContent && raw.textContent.trim().startsWith('{')) {
              var parsed = JSON.parse(raw.textContent);
              var j = parsed.journey || parsed;
              storedConfig = {
                company: j.companyName || j.company || parsed.companyName || '',
                industry: j.industryType || j.industry || parsed.industryType || '',
                journeyType: j.journeyType || parsed.journeyType || '',
                steps: j.steps || [],
                additionalFields: parsed.additionalFields || j.additionalFields || {},
                customerProfile: parsed.customerProfile || j.customerProfile || {},
                traceMetadata: parsed.traceMetadata || j.traceMetadata || {}
              };
              console.log('[AI Agents] Journey data from step3 output:', storedConfig.company, storedConfig.steps.length, 'steps');
            }
          } catch(e) { console.warn('[AI Agents] Could not parse step3 output:', e.message); }
        }

        // Fallback: Build minimal config from Step 1 inputs
        if (!storedConfig) {
          var company = (document.getElementById('companyName') || {}).value || 'Demo Company';
          var industry = (document.getElementById('industryType') || {}).value || 'Technology';
          var journey = (document.getElementById('journeyType') || {}).value || 'E-Commerce';
          storedConfig = { company: company, industry: industry, journeyType: journey, steps: [], additionalFields: {}, customerProfile: {}, traceMetadata: {} };
          console.log('[AI Agents] Journey data from Step 1 inputs (fallback):', company);
        }

        return storedConfig;
      }

      // Populate the dashboard journey selector from cached journeys
      function populateDashboardJourneySelect() {
        var sel = document.getElementById('dashboard-journey-select');
        if (!sel) return;
        
        // Keep the default option
        sel.innerHTML = '<option value="">Use currently selected journey from Agent Hub</option>';
        
        if (!_cachedJourneys || _cachedJourneys.length === 0) return;
        
        // Group by companyName
        var grouped = {};
        _cachedJourneys.forEach(function(j) {
          var group = j.companyName || 'Other';
          if (!grouped[group]) grouped[group] = [];
          grouped[group].push(j);
        });

        Object.keys(grouped).sort().forEach(function(company) {
          var optgroup = document.createElement('optgroup');
          optgroup.label = 'ğŸ¢ ' + company;
          grouped[company].forEach(function(j) {
            var opt = document.createElement('option');
            opt.value = j.filename;
            opt.textContent = (j.journeyType || 'Journey') + ' (' + j.stepsCount + ' steps, ' + j.services.length + ' services)';
            optgroup.appendChild(opt);
          });
          sel.appendChild(optgroup);
        });
      }

      // Handle dashboard journey selection
      window._dashSelectJourney = async function(filename) {
        var info = document.getElementById('dashboard-journey-info');
        
        if (!filename) {
          // Use default from Agent Hub
          if (info) info.textContent = 'Dashboard will use the journey selected in the Agent Hub above';
          return;
        }

        // Find journey in cache
        var journey = _cachedJourneys.find(function(j) { return j.filename === filename; });
        if (!journey) return;

        // Load full config from server
        try {
          var configId = journey.id;
          var data = await agentFetch('/api/admin/configs/' + encodeURIComponent(configId));
          if (data.ok && data.config) {
            // Set as current journey data for dashboard generation
            window.lastJourney = {
              companyName: journey.companyName,
              industryType: journey.industryType,
              journeyType: journey.journeyType,
              domain: journey.domain,
              steps: journey.steps,
              additionalFields: data.config.additionalFields || {},
              customerProfile: data.config.customerProfile || {},
              traceMetadata: data.config.traceMetadata || {}
            };
            window.currentJourneyData = { journey: window.lastJourney };
          }
        } catch (err) {
          // Use cached journey data
          window.lastJourney = {
            companyName: journey.companyName,
            industryType: journey.industryType,
            journeyType: journey.journeyType,
            domain: journey.domain,
            steps: journey.steps
          };
          window.currentJourneyData = { journey: window.lastJourney };
        }

        if (info) info.textContent = 'âœ… ' + journey.companyName + ' â€” ' + (journey.journeyType || 'Journey') + ' (' + journey.stepsCount + ' steps)';
      };

      window._agentDashPreview = async function() {
        var journeyData = getJourneyData();
        showResult('dashboard-result', 'â³ Previewing fields...');
        try {
          var data = await agentFetch('/api/ai-dashboard/preview', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ journeyData: journeyData })
          });
          // Show detected fields in the preview panel
          var previewEl = document.getElementById('dashboard-preview');
          if (previewEl && data.preview) {
            var p = data.preview;
            var html = '<div class="space-y-2">';
            html += '<p class="text-dtpurple font-semibold">' + (p.name || 'Dashboard') + '</p>';
            html += '<p class="text-gray-400">Journey Type: ' + (p.journeyType || p.industry || 'â€”') + '</p>';
            if (p.detectedFields) {
              var df = p.detectedFields;
              html += '<div class="mt-2"><span class="text-gray-500">String fields:</span> <span class="text-white">' + (df.stringFields || []).length + '</span></div>';
              html += '<div><span class="text-gray-500">Numeric fields:</span> <span class="text-white">' + (df.numericFields || []).length + '</span></div>';
              html += '<div><span class="text-gray-500">Boolean fields:</span> <span class="text-white">' + (df.booleanFields || []).length + '</span></div>';
            }
            html += '<p class="text-dtgreen mt-2 font-semibold">' + (p.dynamicTileCount || 0) + ' dynamic tiles detected</p>';
            html += '</div>';
            previewEl.innerHTML = html;
          }
          showResult('dashboard-result', data);
        } catch (e) { showResult('dashboard-result', 'âŒ ' + e.message); }
      };

      var _lastGeneratedDashboard = null;

      window._agentDashGenerate = async function() {
        // Use the same proven data extraction as the working generateAIDashboard()
        var cjd = window.currentJourneyData;
        var lj = window.lastJourney;
        var journey = null;
        var addFields = {};
        var custProfile = {};
        var traceMeta = {};

        // Priority 1: window.currentJourneyData.journey (same as working button)
        if (cjd && cjd.journey && cjd.journey.steps && cjd.journey.steps.length > 0) {
          journey = cjd.journey;
          addFields = cjd.additionalFields || {};
          custProfile = cjd.customerProfile || {};
          traceMeta = cjd.traceMetadata || {};
          console.log('[AI Agents] Dashboard data from currentJourneyData.journey');
        }
        // Priority 2: window.lastJourney
        else if (lj && lj.steps && lj.steps.length > 0) {
          journey = lj;
          addFields = lj.additionalFields || {};
          custProfile = lj.customerProfile || {};
          traceMeta = lj.traceMetadata || {};
          console.log('[AI Agents] Dashboard data from lastJourney');
        }
        // Priority 3: Try parsing Step 3 output
        else {
          try {
            var raw = document.getElementById('journey-output-step3');
            if (raw && raw.textContent && raw.textContent.trim().startsWith('{')) {
              var parsed = JSON.parse(raw.textContent);
              journey = parsed.journey || parsed;
              addFields = parsed.additionalFields || journey.additionalFields || {};
              custProfile = parsed.customerProfile || journey.customerProfile || {};
              traceMeta = parsed.traceMetadata || journey.traceMetadata || {};
              console.log('[AI Agents] Dashboard data from step3 output');
            }
          } catch(e) {}
        }

        if (!journey || !journey.steps || journey.steps.length === 0) {
          return alert('No journey loaded. Please generate or load a journey first (Step 2 â†’ Step 3).');
        }

        var companyName = journey.companyName || journey.company || 'Dashboard';
        var journeyType = journey.journeyType || 'Journey';
        showResult('dashboard-result', 'â³ AI generating dashboard for ' + companyName + ' ' + journeyType + '...');

        try {
          var startTime = Date.now();
          var data = await agentFetch('/api/ai-dashboard/generate', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              journeyData: {
                company: companyName,
                industry: journey.industryType || journey.industry || 'Technology',
                journeyType: journeyType,
                steps: journey.steps.map(function(s) {
                  return {
                    name: s.stepName || s.name,
                    serviceName: s.serviceName || '',
                    category: s.category || '',
                    description: s.description || '',
                    estimatedDuration: s.estimatedDuration || 0,
                    hasError: s.hasError || false
                  };
                }),
                additionalFields: addFields,
                customerProfile: custProfile,
                traceMetadata: traceMeta
              }
            })
          });

          var duration = ((Date.now() - startTime) / 1000).toFixed(1);

          if (data.success && data.dashboard) {
            _lastGeneratedDashboard = data.dashboard;

            // Download the inner content (the actual dashboard JSON), same as working button
            var dashboardJson = data.dashboard.content || data.dashboard;
            var blob = new Blob([JSON.stringify(dashboardJson, null, 2)], { type: 'application/json' });
            var dlUrl = URL.createObjectURL(blob);
            var dlLink = document.createElement('a');
            dlLink.href = dlUrl;
            dlLink.download = (companyName + '-' + journeyType + '-ai-dashboard.json').replace(/\s+/g, '-').toLowerCase();
            document.body.appendChild(dlLink);
            dlLink.click();
            document.body.removeChild(dlLink);
            URL.revokeObjectURL(dlUrl);

            var method = data.generationMethod || 'unknown';
            var tilesCount = Object.keys(dashboardJson.tiles || {}).length;

            // Update preview panel
            var previewEl = document.getElementById('dashboard-preview');
            if (previewEl) {
              previewEl.innerHTML = '<div class="space-y-1">' +
                '<p class="text-dtpurple font-semibold">' + companyName + ' â€” ' + journeyType + '</p>' +
                '<p class="text-gray-500 text-[10px]">Method: <span class="text-dtcyan">' + method + '</span> | Generated in ' + duration + 's</p>' +
                '<p class="text-gray-500 text-[10px]">Tiles: <span class="text-white font-bold">' + tilesCount + '</span></p>' +
                '<p class="text-dtgreen text-xs mt-2 font-semibold">âœ… Dashboard downloaded</p></div>';
            }
            showResult('dashboard-result', 'âœ… AI Dashboard generated in ' + duration + 's (' + method + ')\nğŸ“Š ' + tilesCount + ' tiles created\n\nğŸ“¤ To upload to Dynatrace:\n1. Go to your Dynatrace environment\n2. Navigate to Dashboards â†’ Import\n3. Upload the downloaded JSON file');
          } else {
            showResult('dashboard-result', 'âŒ ' + (data.error || data.message || 'Generation failed'));
          }
        } catch (e) { showResult('dashboard-result', 'âŒ ' + e.message); }
      };

      window._agentDashDeploy = async function() {
        var journeyData = getJourneyData();
        var journeyConfig = {
          companyName: journeyData.company || journeyData.companyName || 'Demo',
          steps: journeyData.steps || [],
          industry: journeyData.industry || '',
          journeyType: journeyData.journeyType || ''
        };

        // Build request body â€” if we have a pre-generated dashboard, send it for direct deployment
        var requestBody = { journeyConfig: journeyConfig };
        if (_lastGeneratedDashboard) {
          requestBody.dashboardDocument = _lastGeneratedDashboard;
          console.log('[AI Agents] Deploying pre-built dashboard:', _lastGeneratedDashboard.name, '(' + (_lastGeneratedDashboard.metadata?.totalTiles || '?') + ' tiles)');
        } else {
          // No pre-generated dashboard â€” auto-generate first, then deploy
          if (!journeyData.steps || journeyData.steps.length === 0) {
            return alert('No journey steps found. Generate journey data first (Step 2 â†’ Step 3), then click Generate Dashboard.');
          }
          console.log('[AI Agents] No pre-built dashboard â€” generating first...');
          showResult('dashboard-result', 'â³ Generating dashboard first...');
          try {
            // Use proper step mapping like the working generateAIDashboard()
            var mappedJourney = {
              company: journeyData.company || journeyData.companyName || 'Demo',
              industry: journeyData.industry || 'Technology',
              journeyType: journeyData.journeyType || 'Journey',
              steps: (journeyData.steps || []).map(function(s) {
                return { name: s.stepName || s.name, serviceName: s.serviceName || '', category: s.category || '', description: s.description || '', estimatedDuration: s.estimatedDuration || 0, hasError: s.hasError || false };
              }),
              additionalFields: journeyData.additionalFields || {},
              customerProfile: journeyData.customerProfile || {},
              traceMetadata: journeyData.traceMetadata || {}
            };
            var genData = await agentFetch('/api/ai-dashboard/generate', {
              method: 'POST', headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ journeyData: mappedJourney })
            });
            if (genData.dashboard) {
              _lastGeneratedDashboard = genData.dashboard;
              requestBody.dashboardDocument = genData.dashboard;
              console.log('[AI Agents] Auto-generated dashboard:', genData.dashboard.name);
            }
          } catch (genErr) {
            console.warn('[AI Agents] Auto-generate failed, deploying via legacy path:', genErr.message);
          }
        }

        showResult('dashboard-result', 'â³ Deploying dashboard to Dynatrace...');
        var statusEl = document.getElementById('dashboard-deploy-status');
        if (statusEl) { statusEl.classList.remove('hidden'); statusEl.innerHTML = '<p class="text-xs text-dtyellow">â³ Deploying...</p>'; }
        try {
          var data = await agentFetch('/api/dynatrace/deploy-dashboard', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(requestBody)
          });
          if (data.ok || data.success) {
            if (statusEl) statusEl.innerHTML = '<p class="text-xs text-dtgreen font-semibold">âœ… Deployed!</p>' +
              (data.dashboardUrl ? '<a href="' + data.dashboardUrl + '" target="_blank" class="text-dtcyan text-xs underline">Open Dashboard â†’</a>' : '') +
              '<p class="text-[10px] text-gray-500 mt-1">ID: ' + (data.dashboardId || 'â€”') + '</p>';
          } else if (data.needsOAuthLogin) {
            if (statusEl) statusEl.innerHTML = '<p class="text-xs text-dtyellow font-semibold">âš ï¸ OAuth login required</p><p class="text-[10px] text-gray-400">Go to Settings and sign in with OAuth SSO first.</p>';
          } else {
            if (statusEl) statusEl.innerHTML = '<p class="text-xs text-red-400 font-semibold">âŒ ' + (data.error || 'Deploy failed') + '</p>';
          }
          showResult('dashboard-result', data);
        } catch (e) {
          if (statusEl) statusEl.innerHTML = '<p class="text-xs text-red-400">âŒ ' + e.message + '</p>';
          showResult('dashboard-result', 'âŒ ' + e.message);
        }
      };

      window._agentDashDownload = function() {
        if (!_lastGeneratedDashboard) {
          return alert('Generate a dashboard first before downloading.');
        }
        // Download the inner content (actual Dynatrace-importable dashboard), not the wrapper
        var dashboardJson = _lastGeneratedDashboard.content || _lastGeneratedDashboard;
        var blob = new Blob([JSON.stringify(dashboardJson, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = (_lastGeneratedDashboard.name || 'dashboard').replace(/\s+/g, '-').toLowerCase() + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      window._agentDashHealth = async function() {
        showResult('dashboard-result', 'â³ Checking Ollama health...');
        try {
          var data = await agentFetch('/api/ai-dashboard/health');
          var badge = document.getElementById('dashboard-ai-status');
          if (badge) {
            if (data.ollamaAvailable) {
              badge.textContent = 'ğŸŸ¢ AI Online';
              badge.className = 'text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded-full border border-green-700 uppercase tracking-widest';
            } else {
              badge.textContent = 'ğŸ”´ AI Offline';
              badge.className = 'text-[10px] bg-red-900 text-red-300 px-2 py-0.5 rounded-full border border-red-700 uppercase tracking-widest';
            }
          }
          showResult('dashboard-result', data);
        } catch (e) { showResult('dashboard-result', 'âŒ ' + e.message); }
      };

      // ============ AUTO-LOAD ON TAB SWITCH ============

      function hookSwitchTab() {
        if (typeof window.switchTab !== 'function') {
          setTimeout(hookSwitchTab, 200);
          return;
        }
        var _orig = window.switchTab;
        window.switchTab = function(tabName) {
          _orig(tabName);
          if (tabName === 'step4') {
            loadJourneyList();
            loadGremlinRecipes();
            window._agentRefreshFaults();
            window._agentLibHistory();
            window._agentLibStats();
            window._agentDashHealth();
          }
        };
      }
      hookSwitchTab();

      console.log('[AI Agents] âœ… All agent functions registered');
    })();

  </script>

  <!-- ============================================ -->
  <!-- Dynatrace Settings Modal (UI-based, no MCP) -->
  <!-- ============================================ -->
  <div id="dt-settings-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4" onclick="if(event.target===this) closeDtSettingsModal()">
    <div class="bg-dtcard border border-dtborder rounded-2xl shadow-2xl w-full max-w-lg" onclick="event.stopPropagation()">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-dtborder">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-dtcyan/20 border border-dtcyan flex items-center justify-center">
            <span class="text-xl">âš™ï¸</span>
          </div>
          <div>
            <h2 class="text-lg font-bold text-dtcyan">Dynatrace Settings</h2>
            <p class="text-xs text-gray-400">Configure Events API credentials</p>
          </div>
        </div>
        <button onclick="closeDtSettingsModal()" class="w-8 h-8 rounded-lg bg-dtgray hover:bg-red-600 text-gray-400 hover:text-white flex items-center justify-center transition-all text-lg">&times;</button>
      </div>
      
      <!-- Body -->
      <div class="p-6 space-y-5">
        <!-- Status Banner -->
        <div id="dt-cred-status-banner" class="p-3 rounded-lg bg-gray-800 border border-gray-600 text-sm text-gray-400">
          <div class="flex items-center gap-2">
            <span id="dt-cred-status-icon">âšª</span>
            <span id="dt-cred-status-text">Checking status...</span>
          </div>
          <p id="dt-cred-status-detail" class="text-xs mt-1 text-gray-500"></p>
        </div>

        <!-- What This Does -->
        <div class="p-3 rounded-lg bg-dtpurple/10 border border-dtpurple/30">
          <h4 class="text-xs font-bold text-dtpurple mb-1">What does this enable?</h4>
          <ul class="text-xs text-gray-400 space-y-1">
            <li>â€¢ Sends <strong class="text-white">custom events</strong> to Dynatrace when AI agents inject chaos</li>
            <li>â€¢ Feature flag changes appear in the <strong class="text-white">deployment timeline</strong></li>
            <li>â€¢ Enables <strong class="text-white">CUSTOM_INFO</strong> and <strong class="text-white">CUSTOM_DEPLOYMENT</strong> events</li>
          </ul>
        </div>

        <!-- Environment URL -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1.5">
            Dynatrace Environment URL <span class="text-red-400">*</span>
          </label>
          <input type="url" id="dt-env-url-input" 
            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2.5 text-white text-sm focus:outline-none focus:border-dtcyan focus:ring-1 focus:ring-dtcyan transition-all"
            placeholder="https://abc12345.live.dynatrace.com">
          <p class="text-xs text-gray-500 mt-1">Your Dynatrace SaaS or Managed tenant URL</p>
        </div>

        <!-- API Token -->
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-1.5">
            API Token <span class="text-red-400">*</span>
          </label>
          <div class="relative">
            <input type="password" id="dt-api-token-input" 
              class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2.5 pr-12 text-white text-sm font-mono focus:outline-none focus:border-dtcyan focus:ring-1 focus:ring-dtcyan transition-all"
              placeholder="dt0c01.XXXXXXXX.YYYYYYYY">
            <button onclick="toggleDtTokenVis()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-dtcyan text-sm px-2 py-1 rounded transition-all" title="Show/Hide token">
              ğŸ‘ï¸
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">Requires <code class="text-dtcyan">events.ingest</code> scope (Access Tokens &rarr; Generate New Token)</p>
        </div>
        
        <!-- Token Scope Help -->
        <details class="text-xs">
          <summary class="text-dtcyan cursor-pointer hover:text-white transition-colors font-medium">How to create an API Token</summary>
          <div class="mt-2 p-3 rounded-lg bg-gray-800 border border-gray-600 space-y-2 text-gray-400">
            <p>1. Go to your Dynatrace tenant</p>
            <p>2. Navigate to <strong class="text-white">Access Tokens</strong> (Settings &rarr; Integration &rarr; Access Tokens)</p>
            <p>3. Click <strong class="text-white">Generate new token</strong></p>
            <p>4. Give it a name like <code class="text-dtcyan">BizObs Events</code></p>
            <p>5. Add the scope: <code class="text-dtcyan">events.ingest</code> (Ingest events)</p>
            <p>6. Click <strong class="text-white">Generate token</strong> and copy it</p>
          </div>
        </details>
      </div>

      <!-- Footer -->
      <div class="flex items-center justify-between p-6 border-t border-dtborder">
        <div class="flex gap-2">
          <button onclick="testDtConnection()" id="dt-test-btn" class="px-4 py-2 rounded-lg bg-dtgray hover:bg-gray-600 text-white text-sm font-medium transition-all flex items-center gap-2">
            ğŸ”Œ Test Connection
          </button>
          <button onclick="clearDtCredentials()" class="px-4 py-2 rounded-lg bg-gray-700 hover:bg-red-600 text-gray-300 hover:text-white text-sm font-medium transition-all">
            ğŸ—‘ï¸ Clear
          </button>
        </div>
        <button onclick="saveDtCredentials()" class="px-6 py-2 rounded-lg bg-dtcyan hover:bg-dtpurple text-black hover:text-white text-sm font-bold transition-all">
          ğŸ’¾ Save Credentials
        </button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // Dynatrace Settings Modal Logic (UI-based)
    // ============================================

    function openDtSettingsModal() {
      document.getElementById('dt-settings-modal').classList.remove('hidden');
      refreshDtCredentialStatus();
    }

    function closeDtSettingsModal() {
      document.getElementById('dt-settings-modal').classList.add('hidden');
    }

    function toggleDtTokenVis() {
      const input = document.getElementById('dt-api-token-input');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function updateDtStatusBanner(type, icon, text, detail) {
      const banner = document.getElementById('dt-cred-status-banner');
      document.getElementById('dt-cred-status-icon').textContent = icon;
      document.getElementById('dt-cred-status-text').textContent = text;
      document.getElementById('dt-cred-status-detail').textContent = detail || '';

      const colors = {
        success: 'bg-green-900/30 border-green-600 text-green-300',
        error: 'bg-red-900/30 border-red-600 text-red-300',
        warning: 'bg-yellow-900/30 border-yellow-600 text-yellow-300',
        info: 'bg-gray-800 border-gray-600 text-gray-400'
      };
      banner.className = `p-3 rounded-lg border text-sm ${colors[type] || colors.info}`;
    }

    async function refreshDtCredentialStatus() {
      try {
        const res = await fetch('/api/admin/dt-credentials/status');
        const data = await res.json();

        if (data.configured) {
          updateDtStatusBanner('success', 'âœ…', 'Credentials configured', 
            `Environment: ${data.environmentUrl} | Token: ${data.tokenPreview} | Source: ${data.source}`);
          // Pre-fill the environment URL (not token for security)
          document.getElementById('dt-env-url-input').value = data.environmentUrl || '';
          document.getElementById('dt-api-token-input').value = ''; // Don't pre-fill token
          document.getElementById('dt-api-token-input').placeholder = `Current: ${data.tokenPreview} (enter new to change)`;
          updateDtIndicator(true);
        } else if (data.environmentUrl && !data.tokenConfigured) {
          updateDtStatusBanner('warning', 'âš ï¸', 'Partially configured', 
            `Environment URL set but API Token is missing`);
          document.getElementById('dt-env-url-input').value = data.environmentUrl || '';
          updateDtIndicator(false);
        } else {
          updateDtStatusBanner('info', 'âšª', 'Not configured', 
            'Add your Dynatrace Environment URL and API Token to enable event ingestion');
          updateDtIndicator(false);
        }
      } catch (err) {
        updateDtStatusBanner('error', 'âŒ', 'Failed to check status', err.message);
        updateDtIndicator(false);
      }
    }

    function updateDtIndicator(configured) {
      const dot = document.getElementById('dt-settings-indicator');
      if (dot) {
        dot.className = configured 
          ? 'w-2 h-2 rounded-full bg-green-400 animate-pulse' 
          : 'w-2 h-2 rounded-full bg-gray-500';
        dot.title = configured ? 'Dynatrace connected' : 'Not configured';
      }
    }

    async function saveDtCredentials() {
      const envUrl = document.getElementById('dt-env-url-input').value.trim();
      const apiToken = document.getElementById('dt-api-token-input').value.trim();

      if (!envUrl) {
        updateDtStatusBanner('error', 'âŒ', 'Missing Environment URL', 'Please enter your Dynatrace tenant URL');
        return;
      }

      // If token field is empty but credentials already configured, only update URL
      if (!apiToken) {
        // Check if we already have a token configured
        const statusRes = await fetch('/api/admin/dt-credentials/status');
        const statusData = await statusRes.json();
        if (!statusData.tokenConfigured) {
          updateDtStatusBanner('error', 'âŒ', 'Missing API Token', 'Please enter your Dynatrace API Token');
          return;
        }
      }

      try {
        updateDtStatusBanner('info', 'â³', 'Saving...', '');

        // If no new token entered, we need to fetch the existing one server-side
        // So we send a signal to only update URL
        const body = { environmentUrl: envUrl };
        if (apiToken) {
          body.apiToken = apiToken;
        }

        const res = await fetch('/api/admin/dt-credentials', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();
        if (data.ok) {
          updateDtStatusBanner('success', 'âœ…', 'Credentials saved!', 
            `${data.environmentUrl} | Token: ${data.tokenPreview}`);
          updateDtIndicator(true);
          // Clear the token input after save
          document.getElementById('dt-api-token-input').value = '';
          document.getElementById('dt-api-token-input').placeholder = `Current: ${data.tokenPreview} (enter new to change)`;
        } else {
          updateDtStatusBanner('error', 'âŒ', 'Save failed', data.error);
        }
      } catch (err) {
        updateDtStatusBanner('error', 'âŒ', 'Save failed', err.message);
      }
    }

    async function testDtConnection() {
      const btn = document.getElementById('dt-test-btn');
      btn.disabled = true;
      btn.textContent = 'â³ Testing...';
      updateDtStatusBanner('info', 'â³', 'Testing connection...', 'Sending test event to Dynatrace');

      try {
        const res = await fetch('/api/admin/dt-credentials/test', { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          updateDtStatusBanner('success', 'âœ…', 'Connection successful!', data.message);
        } else {
          updateDtStatusBanner('error', 'âŒ', 'Connection failed', data.error);
        }
      } catch (err) {
        updateDtStatusBanner('error', 'âŒ', 'Test failed', err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ğŸ”Œ Test Connection';
      }
    }

    async function clearDtCredentials() {
      if (!confirm('Clear all Dynatrace credentials from the server?')) return;
      try {
        await fetch('/api/admin/dt-credentials', { method: 'DELETE' });
        document.getElementById('dt-env-url-input').value = '';
        document.getElementById('dt-api-token-input').value = '';
        document.getElementById('dt-api-token-input').placeholder = 'dt0c01.XXXXXXXX.YYYYYYYY';
        updateDtStatusBanner('info', 'âšª', 'Credentials cleared', 'Events will not be sent until credentials are configured again');
        updateDtIndicator(false);
      } catch (err) {
        updateDtStatusBanner('error', 'âŒ', 'Clear failed', err.message);
      }
    }

    // Check credential status on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Update the settings indicator on load
      fetch('/api/admin/dt-credentials/status')
        .then(r => r.json())
        .then(data => updateDtIndicator(data.configured))
        .catch(() => updateDtIndicator(false));
    });
  </script>
</body>
</html>
